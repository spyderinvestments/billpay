<!DOCTYPE html>
<html lang="en">
  <head>
    <!--[if lt IE 8]> <script type="text/javascript"> document.location.href = "/ie7"; </script> <![endif]-->
    <script>
      var errorceptionErrorCount = 0;
      (function (_, e, rr, s) {
        _errs = [s];
        var c = _.onerror;
        _.onerror = function () {
          if (errorceptionErrorCount++ < 5) {
            var a = arguments;
            _errs.push(a);
            c && c.apply(this, a)
          }
        };
        var b = function () {
          var c = e.createElement(rr),
            b = e.getElementsByTagName(rr)[0];
          c.src = "//beacon.errorception.com/" + s + ".js";
          c.async = !0;
          b.parentNode.insertBefore(c, b)
        };
        _.addEventListener
          ? _.addEventListener("load", b, !1)
          : _.attachEvent("onload", b)
      })(window, document, "script", "503528308f9d632d6f000fb9");
      _errs.allow = function (err) {
        if (err.message == "Uncaught ReferenceError: $ is not defined" || err.message == "ReferenceError: $ is not defined")
          return // Probably a browser disallowing external scripts
          false;
        else if (err.message == "Uncaught ReferenceError: Backbone is not defined" || err.message == "ReferenceError: Backbone is not defined")
          return // Probably a browser disallowing external scripts
          false;
        else
          return true;
        }
      ;
      _errs.meta = {
        userId: 3511011,
        email: "michaelpliang@gmail.com",
        pageLoaded: (new Date()).toString()
      };
    </script>
    <meta charset="utf-8">
    <meta name="apple-itunes-app" content="app-id=458023433, affiliate-data=partnerId=30&siteID=T4zFPuSHh2U"/>
    <title>Splitwise</title>
    <meta content="authenticity_token" name="csrf-param"/>
    <meta content="4h5XAlFxjqvhgUR593ok5HXlBRqleegF3qDLHPfeQyw=" name="csrf-token"/>
    <!--[if lt IE 9]> <script src="https://html5shim.googlecode.com/svn/trunk/html5.js" type="text/javascript"></script> <![endif]-->
    <link href='https://fonts.googleapis.com/css?family=Lato:400,400italic,700' rel='stylesheet' type='text/css'>
    <link href="//dx0qysuen8cbs.cloudfront.net/assets/adorable-67b9ef29c6db2092027199cdeca64395.css" media="all" rel="stylesheet" type="text/css"/>
    <link href="/favicon.ico" rel="shortcut icon">

    <script type="text/javascript">
      // Mixpanel
      if (!mpq || !mpq.push)
        var mpq = [];

      mpq.push(["init", "81bc5d1ccfd935d0e748c16d4068e461"]);
      mpq.push([
        "register_once", {
          'signed_up': 'yes'
        },
        "all",
        'no'
      ]);
      mpq.push([
        "register_once", {
          'mp_source': 'registered'
        },
        "all",
        'unregistered'
      ]);
      mpq.push([
        "register_once", {
          'signup_type': 'registered'
        },
        "all",
        'unregistered'
      ]);
      mpq.push([
        "register_once", {
          'ab_test': 'A'
        },
        "all",
        ''
      ]);
      mpq.push([
        "register_once", {
          'ad_source': ''
        },
        "all",
        ''
      ]);
      mpq.push([
        "register", {
          'logged_in': 'yes'
        },
        "all"
      ]);
      mpq.push([
        "register", {
          'user_id': '3511011'
        },
        "all"
      ]);
      mpq.push([
        "register", {
          'mobile': 'no'
        },
        "all"
      ]);
      mpq.push(["name_tag", "michaelpliang@gmail.com"]);
      (function () {
        var a = document.createElement("script");
        a.type = "text/javascript";
        a.async = true;
        a.src = (document.location.protocol === "https:"
          ? "https:"
          : "http:") + "//api.mixpanel.com/site_media/js/api/mixpanel.js";
        var b = document.getElementsByTagName("script")[0];
        b.parentNode.insertBefore(a, b)
      })();
    </script>
    <script type="text/javascript">
      // Mixpanel fallback for Ghostery
      if (!mpq || !mpq.push)
        var mpq = [];
    </script>
    <!-- Facebook Conversion Code for Registrations website -->
    <script>
      (function () {
        var _fbq = window._fbq || (window._fbq = []);
        if (!_fbq.loaded) {
          var fbds = document.createElement('script');
          fbds.async = true;
          fbds.src = '//connect.facebook.net/en_US/fbds.js';
          var s = document.getElementsByTagName('script')[0];
          s.parentNode.insertBefore(fbds, s);
          _fbq.loaded = true;
        }
      })();
      window._fbq = window._fbq || [];
      window._fbq.push([
        'track',
        '6026874798750', {
          'value': '0.00',
          'currency': 'USD'
        }
      ]);
    </script>
    <noscript><img height="1" width="1" alt="" style="display:none" src="https://www.facebook.com/tr?ev=6026874798750&amp;cd[value]=0.00&amp;cd[currency]=USD&amp;noscript=1"/></noscript>

  </head>
  <body>
    <div id="body-min-width">
      <div class="navbar navbar-fixed-top">
        <div class="navbar-inner">
          <div class="container">
            <a class="brand" href="/">
              <img alt="Wordmark" id="logo" src="//dx0qysuen8cbs.cloudfront.net/assets/fat_rabbit/wordmark-038b462ad6f1d67855d02cb81e7931af.png"/>
            </a>
            <ul class="nav pull-right">
              <li class="dropdown">
                <a href="#" class="dropdown-toggle" data-toggle="dropdown">
                  <img alt="50" src="https://dx0qysuen8cbs.cloudfront.net/assets/fat_rabbit/avatars/50-a1e7c78c96b64b48f8ffd189d623c58b.png"/>
                  Michael

                  <b class="caret"></b>
                </a>

                <ul class="dropdown-menu pull-right">
                  <li>
                    <a href="/account/settings">Your account</a>
                  </li>
                  <li>
                    <a href="/groups/new">Create a group</a>
                  </li>
                  <li>
                    <a href="/calculators">Fairness calculators</a>
                  </li>

                  <li>
                    <a href="/logout" data-method="post" rel="nofollow">Log out</a>
                  </li>
                </ul>
              </li>

            </ul>
          </div>
        </div>
      </div>
    </div>

    <div id="center_container">
      <div id="center_bars">
        <div id="left_sidebar"></div>
        <div id="right_sidebar">
          <div id="right_sidebar_content"></div>
        </div>
        <div id="center_column"></div>
        <div style="clear: both"></div>
      </div>
    </div>
    <div id="loading">
      <div class="ajax"></div>
      <div style="margin-top: 65px">
        Loading
      </div>
    </div>

    <!-- MODALS -->
    <div id="ajax_statuses">
      <div id="ajax_loading">
        <div id="ajax_activity"></div>
        <p>Loading...</p>
      </div>
      <div id="ajax_success">
        <img alt="Ajax_success" src="//dx0qysuen8cbs.cloudfront.net/assets/adorable/ajax_success-d08e06b500a78d2d596de6ca59888c86.png"/>
        <p>Loading...</p>
      </div>
      <div id="ajax_error">
        <img alt="Ajax_error" src="//dx0qysuen8cbs.cloudfront.net/assets/adorable/ajax_error-460740b83eeadd76471784ffc7278788.png"/>
        <p>Loading...</p>
      </div>
    </div>

    <!-- START MODALS -->
    <div class="modal fade" id="user_summary"></div>
    <div class="modal fade" id="settle_up"></div>
    <div class="modal fade" id="group_member_details"></div>
    <div class="modal fade" id="simplify_debts"></div>
    <div class="modal fade" id="charts_modal"></div>

    <div class="modal fade transparent" id="add_bill"></div>
    <div class="modal fade transparent" id="settle_up_form"></div>

    <div class="modal fade" id="send_reminder"></div>
    <div class="modal fade" id="delete_friendship"></div>
    <div class="modal fade" id="invite_friends"></div>
    <div id="first_launch"></div>
    <!-- END MODALS -->

    <script src="//dx0qysuen8cbs.cloudfront.net/assets/adorable-a4e5e698600d12c15d4af0190f10d85a.js" type="text/javascript"></script>
    <script type="text/javascript">
      if (!mpq || !mpq.push)
        var mpq = [];

      var current_user = 3511011;
      var currentUserObject = {
        "id": 3511011,
        "first_name": "Michael",
        "last_name": null,
        "picture": {
          "small": "https:\/\/dx0qysuen8cbs.cloudfront.net\/assets\/fat_rabbit\/avatars\/50-a1e7c78c96b64b48f8ffd189d623c58b.png",
          "medium": "https:\/\/dx0qysuen8cbs.cloudfront.net\/assets\/fat_rabbit\/avatars\/100-17010fc5ad055cc69769b9209f95f2c1.png",
          "large": "https:\/\/dx0qysuen8cbs.cloudfront.net\/assets\/fat_rabbit\/avatars\/200-4a03472750dda254b5e7a8e1726bb5d3.png"
        },
        "email": "michaelpliang@gmail.com",
        "registration_status": "confirmed",
        "locale": null,
        "country_code": "US",
        "date_format": "MM\/DD\/YYYY",
        "default_currency": "USD",
        "default_group_id": -1,
        "notifications_read": "2012-07-17T23:54:29Z",
        "notifications_count": 0,
        "notifications": {
          "added_as_friend": true,
          "added_to_group": true,
          "expense_added": false,
          "expense_updated": false,
          "bills": true,
          "payments": true,
          "monthly_summary": true,
          "announcements": true
        }
      };
      currentUserObject.referralCode = "fe5d75934e0fb3e8";
      currentUserObject.test = "A";
      currentUserObject.mobile = false;
      currentUserObject.showVenmo = true;
      currentUserObject.locale = "en";
      currentUserObject.translationPrompt = null;
      currentUserObject.was_invited = false;
      currentUserObject.first_request_at = new Date("2016-02-25T17:27:01-05:00");
      currentUserObject.ads_disabled = false;
      currentUserObject.show_external_accounts = false;
      currentUserObject.has_pro = false;
      currentUserObject.read_only = false;
      var default_currency = "USD";
      var default_group = -1;
      var version = '3.0.0';
      var page_loaded = new Date();
      var first_launch = false;
      var params = null;

      var third_party_tokens = {};
      window.addThirdPartyToken = function (source, key) {
        // IE8 forgets that 'key' is an array, but remembers some of its properties
        // so let's rebuild an array
        var contacts = [];
        for (var i = 0; i < key.length; i++)
          contacts.push(key[i]);

        third_party_tokens[source] = contacts;
        console.log("Loaded contacts from " + source);
        $('#invite_friends').trigger('addContacts', [source, contacts]);
      }
    </script>

    <script type="text/javascript">
      var CURRENT_USER = 3511011,
        STRINGS = {
          "App": "Splitwise",
          "Url": "https://secure.splitwise.com/"
        },
        SHORT_MONTHS = [
          "Jan",
          "Feb",
          "Mar",
          "Apr",
          "May",
          "Jun",
          "Jul",
          "Aug",
          "Sep",
          "Oct",
          "Nov",
          "Dec"
        ],
        MONTHS = [
          "January",
          "February",
          "March",
          "April",
          "May",
          "June",
          "July",
          "August",
          "September",
          "October",
          "November",
          "December"
        ],
        DAYS = [
          "Sunday",
          "Monday",
          "Tuesday",
          "Wednesday",
          "Thursday",
          "Friday",
          "Saturday"
        ];

      // Setup our Backbone.js application
      var App = {
        Routers: {},
        Views: {},
        Models: {},
        Collections: {},
        settings: {
          show_items_not_involving_me: true,
          show_settled_bills: false
        },
        loadBootstrapDataAndInit: function (options) {
          $("#loading .ajax").activity({
            steps: 10,
            width: 4,
            space: 5,
            length: 10,
            align: 'center',
            valign: 'top',
            padding: 0
          });

          // Bootstrap with currencies and relationships
          App.currencies = new App.Collections.Currencies();
          App.currencies.reset([
            {
              "currency_code": "USD",
              "unit": "$"
            }, {
              "currency_code": "ARS",
              "unit": "$"
            }, {
              "currency_code": "AUD",
              "unit": "$"
            }, {
              "currency_code": "EUR",
              "unit": "\u20ac"
            }, {
              "currency_code": "BRL",
              "unit": "R$"
            }, {
              "currency_code": "CAD",
              "unit": "$"
            }, {
              "currency_code": "CNY",
              "unit": "\u00a5"
            }, {
              "currency_code": "DKK",
              "unit": "kr"
            }, {
              "currency_code": "GBP",
              "unit": "\u00a3"
            }, {
              "currency_code": "INR",
              "unit": "\u20b9"
            }, {
              "currency_code": "ILS",
              "unit": "\u20aa"
            }, {
              "currency_code": "JPY",
              "unit": "\u00a5"
            }, {
              "currency_code": "MXN",
              "unit": "$"
            }, {
              "currency_code": "NZD",
              "unit": "$"
            }, {
              "currency_code": "PHP",
              "unit": "\u20b1"
            }, {
              "currency_code": "RUB",
              "unit": "\u0440\u0443\u0431."
            }, {
              "currency_code": "SGD",
              "unit": "$"
            }, {
              "currency_code": "SEK",
              "unit": "kr"
            }, {
              "currency_code": "CHF",
              "unit": "Fr."
            }, {
              "currency_code": "MYR",
              "unit": "RM"
            }, {
              "currency_code": "RON",
              "unit": "RON"
            }, {
              "currency_code": "ZAR",
              "unit": "R"
            }, {
              "currency_code": "LKR",
              "unit": "Rs. "
            }, {
              "currency_code": "NAD",
              "unit": "$"
            }, {
              "currency_code": "SAR",
              "unit": "SR"
            }, {
              "currency_code": "AED",
              "unit": "DH"
            }, {
              "currency_code": "PLN",
              "unit": "PLN"
            }, {
              "currency_code": "HRK",
              "unit": "HRK"
            }, {
              "currency_code": "PKR",
              "unit": "Rs"
            }, {
              "currency_code": "TWD",
              "unit": "NT$"
            }, {
              "currency_code": "VEF",
              "unit": "Bs"
            }, {
              "currency_code": "HUF",
              "unit": "Ft"
            }, {
              "currency_code": "CLP",
              "unit": "$"
            }, {
              "currency_code": "BDT",
              "unit": "Tk"
            }, {
              "currency_code": "CZK",
              "unit": "K\u010d"
            }, {
              "currency_code": "COP",
              "unit": "$"
            }, {
              "currency_code": "TRY",
              "unit": "TL"
            }, {
              "currency_code": "KRW",
              "unit": "\u20a9"
            }, {
              "currency_code": "BOB",
              "unit": "Bs."
            }, {
              "currency_code": "VND",
              "unit": "\u20ab"
            }, {
              "currency_code": "NOK",
              "unit": "kr"
            }, {
              "currency_code": "EGP",
              "unit": "E\u00a3"
            }, {
              "currency_code": "HKD",
              "unit": "$"
            }, {
              "currency_code": "THB",
              "unit": "\u0e3f"
            }, {
              "currency_code": "KES",
              "unit": "KSh"
            }, {
              "currency_code": "IDR",
              "unit": "Rp "
            }, {
              "currency_code": "ISK",
              "unit": "kr"
            }, {
              "currency_code": "BTC",
              "unit": "\u0e3f"
            }, {
              "currency_code": "UAH",
              "unit": "\u20b4"
            }, {
              "currency_code": "MVR",
              "unit": "MVR"
            }, {
              "currency_code": "OMR",
              "unit": "OMR"
            }, {
              "currency_code": "YER",
              "unit": "YER"
            }, {
              "currency_code": "IRR",
              "unit": "IRR"
            }, {
              "currency_code": "QAR",
              "unit": "QR"
            }, {
              "currency_code": "BHD",
              "unit": "BD"
            }, {
              "currency_code": "TZS",
              "unit": "TZS"
            }, {
              "currency_code": "RSD",
              "unit": "RSD"
            }, {
              "currency_code": "ETB",
              "unit": "Br"
            }, {
              "currency_code": "BGN",
              "unit": "BGN"
            }, {
              "currency_code": "FJD",
              "unit": "$"
            }, {
              "currency_code": "JMD",
              "unit": "J$"
            }, {
              "currency_code": "UYU",
              "unit": "$"
            }, {
              "currency_code": "GTQ",
              "unit": "Q"
            }, {
              "currency_code": "NPR",
              "unit": "Rs. "
            }, {
              "currency_code": "PEN",
              "unit": "S\/. "
            }, {
              "currency_code": "DJF",
              "unit": "Fdj "
            }, {
              "currency_code": "LTL",
              "unit": "Lt "
            }, {
              "currency_code": "MKW",
              "unit": "MK"
            }, {
              "currency_code": "KWD",
              "unit": "KWD"
            }, {
              "currency_code": "CRC",
              "unit": "\u20a1"
            }, {
              "currency_code": "DOP",
              "unit": "$"
            }, {
              "currency_code": "NGN",
              "unit": "\u20a6"
            }, {
              "currency_code": "JOD",
              "unit": "JOD"
            }, {
              "currency_code": "MAD",
              "unit": "MAD"
            }, {
              "currency_code": "RWF",
              "unit": "FRw"
            }, {
              "currency_code": "UGX",
              "unit": "USh"
            }, {
              "currency_code": "AOA",
              "unit": "Kz"
            }, {
              "currency_code": "XAF",
              "unit": "CFA"
            }, {
              "currency_code": "XOF",
              "unit": "CFA"
            }, {
              "currency_code": "CMG",
              "unit": "CMg"
            }, {
              "currency_code": "ANG",
              "unit": "NAf"
            }, {
              "currency_code": "ALL",
              "unit": "L"
            }, {
              "currency_code": "PYG",
              "unit": "\u20b2"
            }, {
              "currency_code": "KYD",
              "unit": "CI$"
            }, {
              "currency_code": "KZT",
              "unit": "\u20b8"
            }, {
              "currency_code": "BAM",
              "unit": "KM"
            }, {
              "currency_code": "AWG",
              "unit": "Afl."
            }, {
              "currency_code": "BIF",
              "unit": "FBu"
            }, {
              "currency_code": "MKD",
              "unit": "\u0434\u0435\u043d"
            }, {
              "currency_code": "XPF",
              "unit": "F"
            }, {
              "currency_code": "GEL",
              "unit": "GEL"
            }, {
              "currency_code": "TND",
              "unit": "DT"
            }, {
              "currency_code": "MZN",
              "unit": "MT"
            }, {
              "currency_code": "BYR",
              "unit": "Br"
            }, {
              "currency_code": "TTD",
              "unit": "TT$"
            }, {
              "currency_code": "XCD",
              "unit": "EC$"
            }, {
              "currency_code": "LBP",
              "unit": "\u0644.\u0644"
            }, {
              "currency_code": "LAK",
              "unit": "\u20ad"
            }, {
              "currency_code": "MOP",
              "unit": "MOP$"
            }, {
              "currency_code": "GHS",
              "unit": "GH\u20b5"
            }, {
              "currency_code": "UZS",
              "unit": "UZS"
            }, {
              "currency_code": "NIO",
              "unit": "C$"
            }, {
              "currency_code": "AZN",
              "unit": "m."
            }, {
              "currency_code": "ZMW",
              "unit": "ZMW"
            }, {
              "currency_code": "SZL",
              "unit": "E"
            }, {
              "currency_code": "BWP",
              "unit": "P"
            }, {
              "currency_code": "MMK",
              "unit": "K"
            }, {
              "currency_code": "CVE",
              "unit": "$"
            }, {
              "currency_code": "MUR",
              "unit": "\u20a8"
            }, {
              "currency_code": "SCR",
              "unit": "SR"
            }, {
              "currency_code": "KHR",
              "unit": "\u17db"
            }, {
              "currency_code": "CUP",
              "unit": "$"
            }, {
              "currency_code": "CUC",
              "unit": "CUC$"
            }, {
              "currency_code": "STD",
              "unit": "Db"
            }
          ]);

          App.categories = new App.Collections.Categories();
          App.categories.reset([
            {
              "id": 19,
              "name": "Entertainment",
              "parent_id": null,
              "icon": "https:\/\/s3.amazonaws.com\/splitwise\/uploads\/category\/icon\/slim\/entertainment\/other.png"
            }, {
              "id": 20,
              "name": "Games",
              "parent_id": 19,
              "icon": "https:\/\/s3.amazonaws.com\/splitwise\/uploads\/category\/icon\/slim\/entertainment\/games.png"
            }, {
              "id": 21,
              "name": "Movies",
              "parent_id": 19,
              "icon": "https:\/\/s3.amazonaws.com\/splitwise\/uploads\/category\/icon\/slim\/entertainment\/movies.png"
            }, {
              "id": 22,
              "name": "Music",
              "parent_id": 19,
              "icon": "https:\/\/s3.amazonaws.com\/splitwise\/uploads\/category\/icon\/slim\/entertainment\/music.png"
            }, {
              "id": 23,
              "name": "Other",
              "parent_id": 19,
              "icon": "https:\/\/s3.amazonaws.com\/splitwise\/uploads\/category\/icon\/slim\/entertainment\/other.png"
            }, {
              "id": 24,
              "name": "Sports",
              "parent_id": 19,
              "icon": "https:\/\/s3.amazonaws.com\/splitwise\/uploads\/category\/icon\/slim\/entertainment\/sports.png"
            }, {
              "id": 25,
              "name": "Food and drink",
              "parent_id": null,
              "icon": "https:\/\/s3.amazonaws.com\/splitwise\/uploads\/category\/icon\/slim\/food-and-drink\/other.png"
            }, {
              "id": 13,
              "name": "Dining out",
              "parent_id": 25,
              "icon": "https:\/\/s3.amazonaws.com\/splitwise\/uploads\/category\/icon\/slim\/food-and-drink\/dining-out.png"
            }, {
              "id": 12,
              "name": "Groceries",
              "parent_id": 25,
              "icon": "https:\/\/s3.amazonaws.com\/splitwise\/uploads\/category\/icon\/slim\/food-and-drink\/groceries.png"
            }, {
              "id": 38,
              "name": "Liquor",
              "parent_id": 25,
              "icon": "https:\/\/s3.amazonaws.com\/splitwise\/uploads\/category\/icon\/slim\/food-and-drink\/liquor.png"
            }, {
              "id": 26,
              "name": "Other",
              "parent_id": 25,
              "icon": "https:\/\/s3.amazonaws.com\/splitwise\/uploads\/category\/icon\/slim\/food-and-drink\/other.png"
            }, {
              "id": 27,
              "name": "Home",
              "parent_id": null,
              "icon": "https:\/\/s3.amazonaws.com\/splitwise\/uploads\/category\/icon\/slim\/home\/other.png"
            }, {
              "id": 39,
              "name": "Electronics",
              "parent_id": 27,
              "icon": "https:\/\/s3.amazonaws.com\/splitwise\/uploads\/category\/icon\/slim\/home\/electronics.png"
            }, {
              "id": 16,
              "name": "Furniture",
              "parent_id": 27,
              "icon": "https:\/\/s3.amazonaws.com\/splitwise\/uploads\/category\/icon\/slim\/home\/furniture.png"
            }, {
              "id": 14,
              "name": "Household supplies",
              "parent_id": 27,
              "icon": "https:\/\/s3.amazonaws.com\/splitwise\/uploads\/category\/icon\/slim\/home\/household-supplies.png"
            }, {
              "id": 17,
              "name": "Maintenance",
              "parent_id": 27,
              "icon": "https:\/\/s3.amazonaws.com\/splitwise\/uploads\/category\/icon\/slim\/home\/maintenance.png"
            }, {
              "id": 4,
              "name": "Mortgage",
              "parent_id": 27,
              "icon": "https:\/\/s3.amazonaws.com\/splitwise\/uploads\/category\/icon\/slim\/home\/mortgage.png"
            }, {
              "id": 28,
              "name": "Other",
              "parent_id": 27,
              "icon": "https:\/\/s3.amazonaws.com\/splitwise\/uploads\/category\/icon\/slim\/home\/other.png"
            }, {
              "id": 29,
              "name": "Pets",
              "parent_id": 27,
              "icon": "https:\/\/s3.amazonaws.com\/splitwise\/uploads\/category\/icon\/slim\/home\/pets.png"
            }, {
              "id": 3,
              "name": "Rent",
              "parent_id": 27,
              "icon": "https:\/\/s3.amazonaws.com\/splitwise\/uploads\/category\/icon\/slim\/home\/rent.png"
            }, {
              "id": 30,
              "name": "Services",
              "parent_id": 27,
              "icon": "https:\/\/s3.amazonaws.com\/splitwise\/uploads\/category\/icon\/slim\/home\/services.png"
            }, {
              "id": 40,
              "name": "Life",
              "parent_id": null,
              "icon": "https:\/\/s3.amazonaws.com\/splitwise\/uploads\/category\/icon\/slim\/life\/other.png"
            }, {
              "id": 41,
              "name": "Clothing",
              "parent_id": 40,
              "icon": "https:\/\/s3.amazonaws.com\/splitwise\/uploads\/category\/icon\/slim\/life\/clothing.png"
            }, {
              "id": 42,
              "name": "Gifts",
              "parent_id": 40,
              "icon": "https:\/\/s3.amazonaws.com\/splitwise\/uploads\/category\/icon\/slim\/life\/gifts.png"
            }, {
              "id": 10,
              "name": "Insurance",
              "parent_id": 40,
              "icon": "https:\/\/s3.amazonaws.com\/splitwise\/uploads\/category\/icon\/slim\/life\/insurance.png"
            }, {
              "id": 43,
              "name": "Medical expenses",
              "parent_id": 40,
              "icon": "https:\/\/s3.amazonaws.com\/splitwise\/uploads\/category\/icon\/slim\/life\/medical-expenses.png"
            }, {
              "id": 44,
              "name": "Other",
              "parent_id": 40,
              "icon": "https:\/\/s3.amazonaws.com\/splitwise\/uploads\/category\/icon\/slim\/life\/other.png"
            }, {
              "id": 45,
              "name": "Taxes",
              "parent_id": 40,
              "icon": "https:\/\/s3.amazonaws.com\/splitwise\/uploads\/category\/icon\/slim\/life\/taxes.png"
            }, {
              "id": 31,
              "name": "Transportation",
              "parent_id": null,
              "icon": "https:\/\/s3.amazonaws.com\/splitwise\/uploads\/category\/icon\/slim\/transportation\/other.png"
            }, {
              "id": 46,
              "name": "Bicycle",
              "parent_id": 31,
              "icon": "https:\/\/s3.amazonaws.com\/splitwise\/uploads\/category\/icon\/slim\/transportation\/bicycle.png"
            }, {
              "id": 32,
              "name": "Bus\/train",
              "parent_id": 31,
              "icon": "https:\/\/s3.amazonaws.com\/splitwise\/uploads\/category\/icon\/slim\/transportation\/bus-train.png"
            }, {
              "id": 15,
              "name": "Car",
              "parent_id": 31,
              "icon": "https:\/\/s3.amazonaws.com\/splitwise\/uploads\/category\/icon\/slim\/transportation\/car.png"
            }, {
              "id": 33,
              "name": "Gas\/fuel",
              "parent_id": 31,
              "icon": "https:\/\/s3.amazonaws.com\/splitwise\/uploads\/category\/icon\/slim\/transportation\/gas-fuel.png"
            }, {
              "id": 47,
              "name": "Hotel",
              "parent_id": 31,
              "icon": "https:\/\/s3.amazonaws.com\/splitwise\/uploads\/category\/icon\/slim\/transportation\/hotel.png"
            }, {
              "id": 34,
              "name": "Other",
              "parent_id": 31,
              "icon": "https:\/\/s3.amazonaws.com\/splitwise\/uploads\/category\/icon\/slim\/transportation\/other.png"
            }, {
              "id": 9,
              "name": "Parking",
              "parent_id": 31,
              "icon": "https:\/\/s3.amazonaws.com\/splitwise\/uploads\/category\/icon\/slim\/transportation\/parking.png"
            }, {
              "id": 35,
              "name": "Plane",
              "parent_id": 31,
              "icon": "https:\/\/s3.amazonaws.com\/splitwise\/uploads\/category\/icon\/slim\/transportation\/plane.png"
            }, {
              "id": 36,
              "name": "Taxi",
              "parent_id": 31,
              "icon": "https:\/\/s3.amazonaws.com\/splitwise\/uploads\/category\/icon\/slim\/transportation\/taxi.png"
            }, {
              "id": 2,
              "name": "Uncategorized",
              "parent_id": null,
              "icon": "https:\/\/s3.amazonaws.com\/splitwise\/uploads\/category\/icon\/slim\/uncategorized\/general.png"
            }, {
              "id": 18,
              "name": "General",
              "parent_id": 2,
              "icon": "https:\/\/s3.amazonaws.com\/splitwise\/uploads\/category\/icon\/slim\/uncategorized\/general.png"
            }, {
              "id": 1,
              "name": "Utilities",
              "parent_id": null,
              "icon": "https:\/\/s3.amazonaws.com\/splitwise\/uploads\/category\/icon\/slim\/utilities\/other.png"
            }, {
              "id": 48,
              "name": "Cleaning",
              "parent_id": 1,
              "icon": "https:\/\/s3.amazonaws.com\/splitwise\/uploads\/category\/icon\/slim\/utilities\/cleaning.png"
            }, {
              "id": 5,
              "name": "Electricity",
              "parent_id": 1,
              "icon": "https:\/\/s3.amazonaws.com\/splitwise\/uploads\/category\/icon\/slim\/utilities\/electricity.png"
            }, {
              "id": 6,
              "name": "Heat\/gas",
              "parent_id": 1,
              "icon": "https:\/\/s3.amazonaws.com\/splitwise\/uploads\/category\/icon\/slim\/utilities\/heat-gas.png"
            }, {
              "id": 11,
              "name": "Other",
              "parent_id": 1,
              "icon": "https:\/\/s3.amazonaws.com\/splitwise\/uploads\/category\/icon\/slim\/utilities\/other.png"
            }, {
              "id": 37,
              "name": "Trash",
              "parent_id": 1,
              "icon": "https:\/\/s3.amazonaws.com\/splitwise\/uploads\/category\/icon\/slim\/utilities\/trash.png"
            }, {
              "id": 8,
              "name": "TV\/Phone\/Internet",
              "parent_id": 1,
              "icon": "https:\/\/s3.amazonaws.com\/splitwise\/uploads\/category\/icon\/slim\/utilities\/tv-phone-internet.png"
            }, {
              "id": 7,
              "name": "Water",
              "parent_id": 1,
              "icon": "https:\/\/s3.amazonaws.com\/splitwise\/uploads\/category\/icon\/slim\/utilities\/water.png"
            }
          ]);

          // Load the core data (while showing a loading overlay)
          App.groups = new App.Collections.Groups();
          App.friends = new App.Collections.Friends();
          App.notifications = new App.Collections.Notifications();

          // cachebust parameter is included to prevent a bug on Chrome where navigating away and
          // hitting "back" won't refresh the main data
          $.get('/api/v3.0/get_main_data?no_expenses=1&limit=3&cachebust=' + Math.random(), function (data) {
            App.groups.reset(data.groups);
            App.friends.reset(data.friends);
            App.notifications.reset(data.notifications);
            App.init();
            App.loadThirdPartyContacts();
          });
        },
        init: function (options) {
          $('#loading').fadeOut();

          // Update notifications once per hour
          setInterval(function () {
            App.notifications.fetch({
              upsert: true,
              data: {
                background_sync: true
              }
            });
          }, 60 * 60 * 1000);

          App.dashboard = false;

          // We track when the page was loaded to prevent unnecessary data fetches in the first few secs
          page_loaded = new Date();

          if (App.friends.size() <= 0 && App.groups.size() <= 1 && App.notifications.size() <= 0) {
            App.firstLaunch = new App.Views.FirstLaunch();
            $('#first_launch').fadeIn();
            setTimeout(this.initRouter, 500)
          } else {
            this.initRouter();
          }

          App.formDataSupported = true;
          try {
            var test = new FormData();
          } catch (e) {
            App.formDataSupported = false
          };

          console.log("Curious how Splitwise works? Come join us! https://www.splitwise.com/jobs");

          if (params && params.add_bill) {
            // Pop up the add bill form with pre-filled information
            var group_id;
            try {
              if (App.currentRelationship && App.currentRelationship.isGroup())
                group_id = App.currentRelationship.id;
              else
                group_id = App.groups.defaultGroup().id;
              }
            catch (e) {
              group_id = 0
            }

            var attributes = {
              group_id: group_id,
              cost: params.cost,
              description: params.description,
              details: params.notes
            };

            if (params.date) {
              attributes.date = new Date(params.date);
            }

            var model = new App.Models.Expense(attributes);

            if (params.category_id) {
              model.set({
                categorySetManually: true,
                category: {
                  id: params.category_id
                }
              });
            }

            if (App.relationshipsRouter.relationshipDetailsView.addABill) {
              App.relationshipsRouter.relationshipDetailsView.addABill.setModel(model);
            } else {
              App.relationshipsRouter.relationshipDetailsView.addABill = new App.Views.AddBillForm({model: model});
            }

            if (params.split_type && group_id == 0) {
              App.relationshipsRouter.relationshipDetailsView.addABill.model.set("split", params.split_type);
            }

            $('#add_bill').modal("show");
            setTimeout("$('#token-input-add_bill_with').click()", 250);
          }
        },

        initRouter: function () {
          var startPath = '#/dashboard';
          // Start up our routers and start tracking history
          App.relationshipsRouter = new App.Routers.Relationships();
          Backbone.history.start();

          if (!Backbone.history.fragment || Backbone.history.fragment.length < 2) {
            // Try default group, if available
            if (default_group > 0 && App.groups.get(default_group)) {
              startPath = '#/groups/' + default_group

            } else if (default_group == -1) {
              // if user only belongs to one group (and has no other friends), go to that group
              var relationship = _.select(App.groups.models, function (g) {
                  return g.id != 0
                })[0],
                otherFriends = [],
                otherBalances = App.groups.get(0).get("original_debts");

              if (relationship) {
                otherFriends = _.map(App.friends.models, function (f) {
                  return f.id
                });
                otherFriends = _.difference(otherFriends, _.map(relationship.get("members"), function (m) {
                  return m.id;
                }));
              }

              if (relationship && !otherFriends.length && !otherBalances.length && App.groups.size() <= 2) {
                startPath = '#/groups/' + relationship.id;
              }

            } else {
              var relationship = _.select(App.groups.models, function (g) {
                return g.id != 0
              })[0];

              if (relationship) {
                startPath = '#/' + relationship.get('relationship_type') + 's/' + relationship.id;
              }
            }

            App.relationshipsRouter.navigate(startPath, true);
          }
        },
        loadThirdPartyContacts: function () {
          //only load this if we have reason to belive the user has Google Oauth with contacts
        },

        // Routers can call App.setActive(id) to set the sidebar navigation
        setActive: function (id) {
          if (this.active === id) {
            return;
          }

          this.active = id;
          $('#left_sidebar a').removeClass('active');
          $('#' + id).addClass('active');
        },

        setPageTitle: function (title, mode) {
          switch (mode) {
            case 'prepend':
              document.title = title + ' ' + document.title;
              break;
            case 'append':
              document.title = document.title + ' ' + title;
              break;
            default:
              document.title = title;
          }

          return document.title;
        },

        showLoader: function (message) {
          this.loaderOpen = true;
          clearTimeout(this.loaderTimeout);
          this.loaderTimeout = setTimeout("$('#ajax_loading p').html('(Still waiting...)');", 10000);
          $("#ajax_loading p").html(message);
          $("#ajax_loading").fadeIn(100);
        },

        closeLoader: function (options) {
          this.loaderOpen = false;
          clearTimeout(this.loaderTimeout);

          if (options && options['type']) {
            if (options['message'] == undefined) {
              options['message'] == App.t(options['type'] == "success"
                ? 'done'
                : 'failed');
            }

            $("#ajax_success p, #ajax_error p").html(options['message']);
            $("#ajax_loading").hide();
            $((options['type'] == "success"
              ? "#ajax_success"
              : "#ajax_error")).show().delay(500).fadeOut(400);
          } else {
            $("#ajax_loading").fadeOut(500);
          }
        },

        renderError: function (options) {
          // TODO: error pop-up
        }
      };

      // Handle logged-out errors
      $(document).ajaxError(function (e, xhr, options) {
        switch (xhr.status) {
          case 410:
            window.location = "/login?logged_out=true";
            break;
          case 403:
            alert("It looks like you don't have permission to perform that action. If you think you've received this message in error, please email us at support@splitwise.com and give us details about what you were trying to do. Thanks!");
            break;
        }
      });

      function checkFirstLaunch() {
        $("#splash").remove();
      }

      function formattedDate(date, format) {
        try {
          var parsedDate = Date.fromISO(date);

          if (format === 'short') {
            return SHORT_MONTHS[parsedDate.getMonth()] + ' ' + parsedDate.getDate();

          } else if (format === 'relative') {
            var today = new Date();
            var yesterday = new Date(new Date() - 1000 * 60 * 60 * 24);
            var thisWeek = new Date() - 1000 * 60 * 60 * 24 * 6;

            if (parsedDate.getFullYear() == today.getFullYear() && parsedDate.getMonth() == today.getMonth() && parsedDate.getDate() == today.getDate())
              return App.t('today').toLowerCase()

            else if (parsedDate.getFullYear() == yesterday.getFullYear() && parsedDate.getMonth() == yesterday.getMonth() && parsedDate.getDate() == yesterday.getDate())
              return App.t('yesterday').toLowerCase()

            else if (parsedDate > thisWeek)
              return DAYS[parsedDate.getDay()];

else
              return SHORT_MONTHS[parsedDate.getMonth()] + ' ' + parsedDate.getDate();

            }
          else {
            return MONTHS[parsedDate.getMonth()] + ' ' + parsedDate.getDate() + ', ' + parsedDate.getFullYear();
          }
        } catch (err) {
          return date;
        }
      }

      $(document).ready(function () {

        App.Models.Currency = Backbone.Model.extend({
          defaults: {
            unit: ''
          },

          unit: function () {
            var currencyCode = this.get("currency_code")

            return currencyCode == default_currency
              ? this.get('unit')
              : currencyCode;
          }
        });

        App.Models.Category = Backbone.Model.extend({
          parentCategory: function () {
            var parentId = this.get('parent_id');

            return parentId
              ? App.categories.get(parentId)
              : null;
          }
        });

        App.Models.Relationship = Backbone.Model.extend({
          getUser: function (id) {
            var correctUser = {};
            _.each(this.get("members"), function (user) {
              if (parseInt(user["id"]) == parseInt(id))
                correctUser = user;
              }
            );
            return new App.Models.User(correctUser);
          },
          mainBalance: function () {
            if (this.balance().length == 0)
              return {"currency_code": default_currency, "amount": 0}
            else
              return _.max(this.balance(), function (b) {
                return Math.abs(b.amount);
              });
            }
          ,

          active: function () {
            return (this.mainBalance().amount != 0) || Date.fromISO(this.get("updated_at")) > (new Date) - 2678400000; // Updated in the past 30 days
          },

          isFriend: function () {
            return this.get("relationship_type") == "friend";
          },

          isGroup: function () {
            return this.get("relationship_type") == "group" && this.id > 0;
          }
        });

        App.Models.Group = App.Models.Relationship.extend({
          defaults: {
            relationship_type: "group"
          },
          name: function () {
            return this.get('name');
          },
          shortName: function () {
            return this.id === 0
              ? App.t("non_group_expenses__short")
              : this.name();
          },
          setAttrs: function () {
            if (this.get("members")) {
              var g = this;
              _.each(this.get("members"), function (user) {
                if (user.id == current_user)
                  g.attributes["balance"] = parseFloat(user.balance); // don't trigger a change event
                }
              );
            } else
              this.attributes['balance'] = parseFloat(this.attributes['balance']); // don't trigger a change event
            }
          ,
          parse: function (response) {
            return response.group || response;
          },

          balance: function () {
            try {
              return _.find(this.get("members"), function (user) {
                return user.id == current_user;
              }).balance;
            } catch (e) {
              return [
                {
                  amount: 0.0,
                  currency_code: default_currency
                }
              ];
            }
          },

          balances: function () {
            var result = {};
            _.each(this.get("members"), function (m) {
              result[m.id] = [];
              _.each(m.balance, function (x) {
                result[m.id].push(_.clone(x));
              });
              if (result[m.id].length == 0)
                result[m.id].push({amount: 0.0, currency_code: default_currency});
              }
            )
            return result;
          },

          adjustBalances: function (direction, expense) {
            if (expense.get("group_id") == this.id) {
              var multiplier = (direction == "subtract"
                ? -1.0
                : 1.0);

              _.each(this.get("members"), function (m) {
                var x = _.find(m.balance, function (b) {
                  return b.currency_code == expense.get("currency_code")
                });
                if (x)
                  x.amount = parseFloat(x.amount) + multiplier * expense.netBalance(m.id);
                else {
                  if (!m.balance)
                    m.balance = [];
                  m.balance.push({
                    amount: multiplier * expense.netBalance(m.id),
                    currency_code: expense.get("currency_code")
                  });
                }
              })

              if (!this.get("simplify_by_default")) {
                // optimistically update repayments
                var group_debts = this.get("original_debts");
                if (!group_debts)
                  group_debts = [];
                _.each(expense.get("repayments"), function (r) {
                  // first, look for a repayment in the correct direction
                  var debt = _.find(group_debts, function (od) {
                    return od.to == r.to && od.from == r.from && od.currency_code == expense.get("currency_code");
                  });
                  if (debt) {
                    debt.amount = parseFloat(debt.amount) + multiplier * parseFloat(r.amount);
                    return;
                  }

                  // next, look for a repayment in the opposite direction
                  debt = _.find(group_debts, function (od) {
                    return od.to == r.from && od.from == r.to && od.currency_code == expense.get("currency_code");
                  });
                  if (debt) {
                    debt.amount = parseFloat(debt.amount) - multiplier * parseFloat(r.amount);
                    return;
                  }

                  // finally, create a repayment if necessary
                  group_debts.push({
                    to: r.to,
                    from: r.from,
                    currency_code: expense.get("currency_code"),
                    amount: multiplier * parseFloat(r.amount)
                  });
                });
              }

              this.trigger("optimisticUpdate");
            }
          },

          methodUrl: function (type) {
            return '/api/v3.0/get_group/' + this.get('id');
          },
          sync: function (method, model, options) {
            if (this.id < 0) {
              // Special case: negative ID => do nothing
              return;
            }

            options = options || {};
            options.url = this.methodUrl();
            Backbone.sync(method, model, options);
          },
          expensesInvolving: function (user) {
            var expenses = this.get(this.get('simplify_by_default')
              ? 'simplified_debts'
              : 'original_debts');

            if (user == null) { // user was not specified (undefined) or null was specified
              return expenses;
            }

            return _.select(expenses, function (expense) {
              return (expense.to == user || expense.from == user) && parseFloat(expense.amount) != 0.0;
            });
          },
          repayments: function (involvedUser) { // maintained for compatibility and later refactor
            return this.expensesInvolving(involvedUser);
          },
          repaymentsAsHTML: function (involvedUser) {
            var repayments = this.repayments(involvedUser);

            if (repayments.length == 0) {
              return ["All settled up!"];
            }

            return _.collect(repayments, function (repayment) {
              var amount = App.currencies.print(repayment.amount, repayment.currency_code),
                keystring,
                spanAttrs,
                userSource;

              if (repayment.from == involvedUser) {
                keystring = 'bullet_owes_AMOUNT_to_NAME__short_html';
                spanAttrs = {
                  class: 'negative'
                };
                userSource = repayment.to;
              } else {
                keystring = 'bullet_gets_back_AMOUNT_from_NAME__short_html';
                spanAttrs = {
                  class: 'positive'
                };
                userSource = repayment.from;
              }

              return App.t(keystring, S(amount).wrapWithTag('span', spanAttrs), App.currentRelationship.getUser(userSource).firstNameLastInitial());
            });
          },
          userTooltipAsHTML: function (involved_user) {
            var member;
            if (involved_user == current_user)
              member = new App.Models.User(currentUserObject);
            else
              member = App.friends.get(involved_user);

            // If we didn't find the member for some reason, fall back on the group's record of that user
            if (!member)
              member = this.getUser(involved_user);

            var result = "<div class='left'>" +
            "<h2>" + _.escape(member.fullName()) + "</h2>";

            if (member.get("registration_status") == "dummy") {
              result += "<div class='registration_status'><i class='icon-large icon-warning-sign' style='color:#e2b649'></i> ";
              result += _.escape(App.t("this_person_does_not_have_an_email_click_to_update"));
              result += "</div>";
            } else if (member.get("registration_status") == "invited") {
              if (member.get("email").indexOf("@phone.com") == -1)
                result += "<h3>" + member.get("email") + "</h3>";
              else {
                result += "<h3>";
                result += _.escape(App.t("no_email_address"));
                result += "</h3>";
              }

              result += "<div class='registration_status'><i class='icon-large icon-warning-sign' style='color:#999999'></i> ";
              result += _.escape(App.t("this_person_has_not_claimed_their_invite_click_to_update"));
              result += "</div>";
            } else {
              result += "<h3>" + member.get("email") + "</h3>";
            }

            result += "<hr>" + App.currentRelationship.repaymentsAsHTML(member.id).join('<br>') + "</div>";

            return result.replace(/"/g, '');
          },
          balanceWith: function (other_user) {
            // find current user's balance with another user
            var result = {};

            var r = this.repayments(current_user);
            _.each(r, function (x) {
              if (x.to == other_user || x.from == other_user) {
                if (!result[x.currency_code])
                  result[x.currency_code] = 0.0;

                if (x.to == other_user)
                  result[x.currency_code] -= x.amount;
                else if (x.from == other_user)
                  result[x.currency_code] += x.amount;
                }
              });

            if (_.size(result) == 0)
              result[default_currency] = 0.0;

            return result;
          }
        });

        App.Models.Friend = App.Models.Relationship.extend({
          defaults: function () {
            return {relationship_type: "friend"};
          },
          fullName: function () {
            if (this.get("first_name") == null)
              return this.get("email");
            else if (this.get("last_name") == undefined || $.trim(this.get("last_name")) == "")
              return this.get("first_name");
            else
              return this.get("first_name") + " " + this.get("last_name");
            }
          ,
          name: function () {
            return this.fullName();
          },
          firstNameLastInitial: function () {
            var name = this.get('first_name'),
              lastName = $.trim(this.get('last_name'));

            if (lastName.length > 0) {
              name += ' ' + lastName[0].toUpperCase() + '.';
            }

            return name;
          },
          displayEmail: function () {
            var email = this.get('email');

            if (_.isEmpty(email) || /@example\.com$/.test(email)) {
              return App.t('no_email_address');
            }

            if (/@phone\.com$/.test(email)) {
              return App.t('invited_via_sms');
            }

            return email;
          },
          balance: function () {
            var result = _.select(this.get('balance'), function (b) {
              return b.amount != 0
            });

            return result.length > 0
              ? result
              : [
                {
                  amount: 0.0,
                  currency_code: default_currency
                }
              ];
          },
          balances: function () {
            var b = this.get('balance'),
              result = {};

            if (b.length == 0) {
              result[current_user] = [
                {
                  amount: 0.0,
                  currency_code: default_currency
                }
              ];
              result[this.id] = [
                {
                  amount: 0.0,
                  currency_code: default_currency
                }
              ];

            } else {
              var person_id = this.id;
              result[current_user] = [];
              result[this.id] = [];

              _.each(b, function (x) {
                result[current_user].push(_.clone(x));
                result[person_id].push({
                  amount: -parseFloat(x.amount),
                  currency_code: x.currency_code
                });
              });
            }

            return result;
          },
          adjustBalances: function (direction, expense) {
            var multiplier = (direction == "subtract"
              ? -1.0
              : 1.0);

            // b is the current user's balance
            var b = _.find(this.get("balance"), function (x) {
              return x.currency_code == expense.get("currency_code")
            });
            if (b)
              b.amount = parseFloat(b.amount) + multiplier * expense.netBalance();
            else {
              b = {
                amount: multiplier * expense.netBalance(),
                currency_code: expense.get("currency_code")
              };
              this.get("balance").push(b);
            }

            this.trigger("optimisticUpdate");
          },
          sharedTabs: function () {
            return _.select(this.get('groups'), function (b) {
              return b.group_id != 0
            });
          },
          groupBalances: function () {
            return _.select(this.get('groups'), function (b) {
              return _.find(b.balance, function (x) {
                return parseFloat(x.amount) != 0
              })
            });
          },
          parse: function (response) {
            return response.friends || response.friend || response;
          },
          methodUrl: function (type) {
            return '/api/v3.0/get_friend/' + this.get('id');
          },
          sync: function (method, model, options) {
            options = options || {};
            options.url = this.methodUrl();
            Backbone.sync(method, model, options);
          },
          noEmail: function () {
            return this.get('registration_status') == 'dummy' || /@(splittherent-dummy|example|phone)\.com$/.test(this.get('email'))
          }
        });

        // Load up the cross-platform category guessing code
        function guess_category(description) {
          description = description.toLowerCase();

          if (description == null)
            return 18;
          else if (description.match(/\brent\b/) != null)
            return //rent
            3;
          else if (description.match(/\bmortgage\b/) != null)
            return //mortgage
            4;
          else if (description.match(/\belec|\bpg&e\b|\bpower\b|\benergy\b|\bcomed\b|\bnstar\b|\bpge\b|\bpg\b|\bxcel\b|\bpeco\b|\belectricity\b/) != null)
            return //electric
            5;
          else if (description.match(/\bheat/) != null)
            return 6 //gas can be heat or petrol - we'll handle this ambiguity at the end to see if anything else resolves it first
            // water is a low priority because if it goes with grocery, it's bottled water;
          else if (description.match(/\binternet\b|\bcomcast\b|\batt\b|\bat&t\b|\bat\b&\bt\b|\bcable\b|\bphone\b|\bnet\b|\btime\b|\bverizon\b|\bwarner\b|\btwc\b|\bcox\b|\bbroadband\b|\bwifi\b|\brcn\b|\bvonage\b|\btmobile\b|\bsprint\b|\bt-mobile\b|\bmodem\b|\bmobile\b/) != null)
            return //tv/phone/internet
            8;
          else if (description.match(/\bparking\b/) != null)
            return //parking
            9;
          else if (description.match(/\binsurance\b|\brenters\b/) != null)
            return //insurance
            10;
          else if (description.match(/\bnetflix\b|\butility\b|\bhulu\b/) != null)
            return //other utils
            11;
          else if (description.match(/\bgroceries\b|\bmilk\b|\bgrocery\b|\bchicken\b|\bsafeway\b|\bbread\b|\beggs\b|\bstore\b|\bmarket\b|\bpatel\b|\bbaza|\bcurd\b|\bveg\b|\bvegetables\b|\bkroger\b|\bbazz\b|\bbaaz|\bchips\b|\boil\b|\bshop\b|\bjuice\b|\btesco\b|\bfoods\b|\bapna\b|\bveggies\b|\bwhole\b|\bbanana\b|\bfruits\b|\bmart\b|\byogurt\b|\baldi\b|\bonion\b|\bstores\b|\bonions\b|\bpasta\b|\bshoprite\b|\bbasket\b|\bmilk\b|\bhoney\b|\bbananas\b|\bhalal\b|\bsalt\b|\bbutter\b|\bjoes\b|\begg\b|\bapple\b|\bmeijer\b|\bgarlic\b|\bmeyer\b|\bsupermarket\b|\bjoe's\b|\bpotato\b|\bicc\b|\bginger\b|\bolive\b|\bcheese\b|\bstrawberry\b|\bcereal\b|\bapples\b|\bwegmans\b|\bmutton\b|\bpopcorn\b|\bturkey\b|\bfarmers\b|\bwinco\b|\bbuttermilk\b|\bthanksgiving\b|\bfruit\b|\bbeans\b|\bcola\b|\bwholefoods\b|\bwhole\bfoods\b|\bcream\b/) != null)
            return //groceries
            12;
          else if (description.match(/\bdinner\b|\blunch\b|\bpizza\b|\bindian\b|\bbreakfast\b|\bcoffee\b|\bsubway\b|\btea\b|\bcafe\b|\bgarden\b|\btaco\b|\bthai\b|\bstarbucks\b|\bchinese\b|\bchipotle\b|\bcurry\b|\bbombay\b|\bchat\b|\bbuffet\b|\bihop\b|\bsandwich\b|\bdiner\b|\btiffin\b|\bbfast\b|\btacos\b|\btavern\b|\bbagel\b|donalds\b|\bdunkin\b|\bbrunch\b|\bgelato\b|\bresturant\b|\bdonuts\b|\bwendys\b|\bkfc\b|\bburger\b|\bpanera\b|\bdominoes\b|\bdomino|\bpapa\b|\bsushi\b/) != null)
            return //dining out
            13;
          else if (description.match(/\bwalmart\b|\bcostco\b|\btarget\b|\bpaper\b|\btoilet\b|\bdish\b|\bdollar\b|\bkitchen\b|\bcvs\b|\btide\b|\btowels\b|\bdetergent\b|\bwalgreens\b|\bliquid\b|\btp\b|\bsam's\b|\btoothpaste\b|\bbathroom\b|\bbath\b|\bvacuum\b|\bshampoo\b|\bhousehold\b|\bwal-mart\b|\bshower\b|\btissue\b|\bfilter\b|\bfoil\b|\bgloves\b/) != null)
            return //household supplies
            14;
          else if (description.match(/\bcar\b|\bauto\b|\bzipcar\b|\bzip\b|\benterprise\b/) != null)
            return //car
            15;
          else if (description.match(/\bikea\b|\bmattress\b|\bbed\b|\btable\b|\bbj's\b|\bcouch\b|\bfridge\b|\bpillow\b/) != null)
            return //furniture
            16;
          else if (description.match(/\brepair\b|\bmaintenance\b/) != null)
            return //repair
            17;
          else if (description.match(/\bpoker\b/) != null)
            return //games
            20;
          else if (description.match(/\bmovie\b|\bamc\b|\bcinema\b/) != null)
            return //movies
            21;
          else if (description.match(/\bmusic\b|\bconcert\b/) != null)
            return //rent
            22;
          else if (description.match(/\bentry\b|\bhookah\b|\bcig\b|\bcasino\b|\bcamping\b/) != null)
            return //other entertainment
            23;
          else if (description.match(/\bgolf\b|\bgym\b/) != null)
            return //sports
            24;
          else if (description.match(/\bsnacks\b/) != null)
            return //other food
            26;
          else if (description.match(/\bwashing\b|\bbooks\b|\bkeys\b|\bprime\b/) != null)
            return //other home
            28;
          else if (description.match(/\bdog\b|\bcat\b|\bpet\b|\bpets\b/) != null)
            return //pets
            29;
          else if (description.match(/\blaundry\b|\bcook\b/) != null)
            return //services
            30;
          else if (description.match(/\bbus\b|\btrain\b|\brail\b|\bmegabus\b|\bgreyhound\b/) != null)
            return //bus/train
            32;
          else if (description.match(/\bfuel\b|\bpetrol\b|\bchevron\b|\bgasoline\b|\bshell\b/) != null)
            return //gas/fuel TODO
            33;
          else if (description.match(/\btravel\b|\bride\b/) != null)
            return //other travel
            34;
          else if (description.match(/\bplane\b|\bjetblue\b|\bairline\b|\bairlines\b|\bflight/) != null)
            return //plane
            35;
          else if (description.match(/\btaxi\b|\bcab\b|\buber\b|\blyft\b/) != null)
            return //taxi
            36;
          else if (description.match(/\btrash\b|\bgarbage\b/) != null)
            return //trash
            37;
          else if (description.match(/\bbeer\b|\bdrinks\b|\bparty\b|\bbar\b|\bwine\b|\bliquor\b|\bbooze\b|\balcohol\b|\bshots\b|\bpub\b|\bwhiskey\b/) != null)
            return //liquor
            38;
          else if (description.match(/\blaptop\b|\bprinter\b|\bhdmi\b|\bfrys\b/) != null)
            return //electronics
            39;
          else if (description.match(/\bclothing\b|\bshirt\b|\bclothes\b|\bshoes\b|\bmacys\b|\bkohls\b|\bgap\b/) != null)
            return //clothing
            41;
          else if (description.match(/\bcake\b|\bgift\b|\bbday\b/) != null)
            return //gifts
            42;
          else if (description.match(/\bmedicines\b|\bmedicine\b|\bmedical\b/) != null)
            return //medical expenses
            43;
          else if (description.match(/\bfedex\b|\bmassage\b/) != null)
            return //other life
            44;
          else if (description.match(/\bbike\b|\bbicycle\b/) != null)
            return //bike
            46;
          else if (description.match(/\bhotel\b|\bairbnb\b|\binn\b/) != null)
            return //hotel
            47;
          else if (description.match(/\bcleaning\b|\bmaid\b|\bcleaner/) != null)
            return //cleaning
            48;
          else if (description.match(/\bgas\b/) != null) { //oh geez here we go
            if
            (description. match(/bill|jan|feb|mar|apr|may|jun|jul|aug|sep|oct|nov|dec|\bco\b|\bnatural\b/) !=null) return
              6;

//it's actually gas/heat
            if
            (description. match(/\bto\b|\bfrom\b|\boff\b|\btrip\b|\bbefore\b|\bgallon\b|\bliter\b/) !=null) return //it's petrol/fuel 33;
            else
             //well, I'm not confident but I'm going to guess petrol
              return
              33;
            }
          else
          if (description. match(/\bwater\b/) !=null) {
            //at the bottom because groceries also mentioned suggests not a bill
            //some fancy stuff to get rid of bottle
            if
            (description. match(/\bbottle\b|\bcan|mineral|sparkling|seltzer/) !=null) return //groceries 12;
            else
            if (description. match(/bill|jan|feb|mar|apr|may|jun|jul|aug|sep|oct|nov|dec/) !=null) return //Water 7;
            else

              //well, I'm not confident but we have to return something
              return
              7;
            }
          else
           return
            18; // general
          }

        App. Models. Expense = Backbone. Model. extend({
          initialize: function () {this. setAttrs();this. bind('change', this. setUsersList, this);this. bind('change:usersList', this. cancelIOU, this);this. bind('change:description', this. guessCategory, this);this. bind('change:cost change:onePayer change:users change:usersList change:eachPaidOwnShare change:split change:split_type change:oneReimburser', this. updatePaidShares, this);this. bind('change:cost change:onePayee change:users change:usersList change:split change:split_type', this. updateOwedShares, this);this. bind('change:equal_users change:unequal_amounts change:percents change:adjustments change:reimbursements change:shares change:items', this. updateOwedShares, this);
          },

          defaults: { cost: 0, currency_code: default_currency, group_id: 0, users: [],category: { id: 18
            },
            categorySetManually: false, items: {
              "items": [],
              "subtotals": {},
              "tax": {
                "users": {}
              },
              "tip": {
                "users": {}
              },
              "totals": {}
            }
          },

          parse: function (response) {return
            response. expense || response;
          },

          setAttrs: function () {this. set({
              cost: parseFloat(this. get("cost"))
            }, {silent: true});if
            (!this. get('date')) this. set({
                date: new Date()
              }, {silent: true});

            // Sort users by net balance, positive to negative
            var
            u = this. get("users");if
            (u && u != undefined) u. sort( function(a, b) {return
                parseFloat(b['net_balance']) -parseFloat(a['net_balance'])
              });

            // Convert number strings to floats
            _. each( u, function (user) {if
              (!isNaN(parseFloat(user. owed_share))) user. owed_share = parseFloat(user. owed_share);
              if
              (!isNaN(parseFloat(user. paid_share))) user. paid_share = parseFloat(user. paid_share);
              }
            ) this. set({
              users: u,
              relationship_type: (this. get("group_id")
                ?"group"
                : "friendship"),relationship_id: (this. get("group_id")
                ?this. get("group_id")
                :this. get("friendship_id"))
            }, {silent: true});this. set({
              relationship_: u
            }, {silent: true});

            // Set payers
            var
            u = _. filter( this. get("users"),function (user) {return
              user['paid_share'] >0
            }); this. set({
              payers: u
            }, {silent: true});

            // Set onePayer (the person who is paying the whole bill), if applicable
            if
            (u. length == 1) this. set({
                onePayer: u[0].user_id
              }, {silent: true});
            else
            if (u. length == 0) this. set({
                onePayer: current_user
              }, {silent: true});
            else
             this. set({
                onePayer: null
              }, {silent: true});

            // if editing, don't auto-detect category
            if
            (this. get("created_at")) this. set({
                categorySetManually: true
              }, {silent: true});

            // when editing, detect split type
            if
            (this. get("cost") <0) {this. set({split: "split", split_type: "unequal"});
            } else
            if (this. get("cost") >0 && this. get("users").length >= 1) {var
              minShare = _. min( this. get("users"),function (u) {return
                u. owed_share
              }). owed_share; var
              maxShare = _. max( this. get("users"),function (u) {return
                u. owed_share
              }). owed_share; var
              currentUserShare = _. find( this. get("users"),function (u) {return
                u. user_id == current_user
              }); var
              otherUserShare = _. find( this. get("users"),function (u) {return
                u. user_id != current_user
              }); if
              (this. isPayment()) {this. set("split", "payment");
              } else
              if (this. get("users").length == 2 && currentUserShare && parseFloat(currentUserShare. net_balance) ==this. get("cost") &&otherUserShare && parseFloat(otherUserShare. net_balance) == -this. get("cost")) {this. set({split: "uoi", split_type: "equal"});
              } else
              if (this. get("users").length == 2 && currentUserShare && parseFloat(currentUserShare. net_balance) == -this. get("cost") &&otherUserShare && parseFloat(otherUserShare. net_balance) ==this. get("cost")) {this. set({split: "iou", split_type: "equal"});
              } else
              if (isNaN(parseFloat(minShare))) {
                // some share doesn't have an owed_share; let's be safe and split unequally
                this. set({split: "split", split_type: "unequal"});
              } else
              if (this. get("details") &&this. get("details").indexOf("Tax") >=0 && this. get("details").indexOf("Tip") >=0) {
                //Parse out items from description
                this. setUsersList();var
                users = this. get("usersList");var
                item_data = {
                  "items": [],
                  "subtotals": {},
                  "tax": {
                    "users": {}
                  },
                  "tip": {
                    "users": {}
                  },
                  "totals": {}
                };

                var
                split_notes = this. get("details").split("\n\r\n");var
                raw_info = split_notes. slice(-1)[0];raw_info = raw_info. split("\n");var
                user_grand_totals = {};var
                totals = {};_. each( users, function (user) {totals[user. id] =0.0; user_grand_totals[user. id] =0.0;
                }) _. each( raw_info, function (item) {try
                  { if
                    (item. length < 3) {
                      //continue;
                    } elseif (item. indexOf("Tax:") ==0) {if
                      (item. indexOf("%") >=0) {
                        //Tax done as percentage
                        item_data["tax"]["total"] =item. split(": ")[1];
                      } else
                      {
                        //Tax done as individual amounts
                        var
                        raw_vals = item. split(": ")[1].split(", ");var
                        raw_taxes = _. map( raw_vals, function (value) {return
                          value. split(" - ")[1]
                        }); var
                        tax_names = _. map( raw_vals, function (value) {return
                          value. split(" - ")[0]
                        }); _. each( tax_names, function (name, index) {var
                          user = _. find( users, function (u) {return
                            name == u. first_name + (u. last_name
                              ? (" " + u. last_name)
                              :"");
                          }); if
                          (user) {item_data["tax"]["users"][user. id] =safe_parse_float(raw_taxes[index]);
                          }
                        });
                      }
                    } else
                    if (item. indexOf("Tip:") ==0) {if
                      (item. indexOf("%") >=0) {
                        //Tip done as percentage
                        item_data["tip"]["total"] =item. split(": ")[1];
                      } else
                      {
                        //Tip done as individual amounts
                        var
                        raw_vals = item. split(": ")[1].split(", ");var
                        raw_tips = _. map( raw_vals, function (value) {return
                          value. split(" - ")[1]
                        }); var
                        tip_names = _. map( raw_vals, function (value) {return
                          value. split(" - ")[0]
                        }); _. each( tip_names, function (name, index) {var
                          user = _. find( users, function (u) {return
                            name == u. first_name + (u. last_name
                              ? (" " + u. last_name)
                              :"");
                          }); if
                          (user) {item_data["tip"]["users"][user. id] =safe_parse_float(raw_tips[index]);
                          }
                        });
                      }
                    } else
                    { var
                      item_obj = {};var
                      cost_split = item. split(" - ");item_obj["cost"] =cost_split[cost_split. length - 1].split(" (")[0];var
                      amount = parseFloat(item_obj["cost"]);cost_split. pop();item_obj["description"] =cost_split. join(" - ");var
                      name_split = item. split(" (");var
                      user_names = name_split[name_split. length - 1].split(")")[0].split(", ");var
                      user_shares = [];var
                      user_amounts = {};var
                      amounts = safe_divide_evenly_amounts(amount, user_names. length);_. each( user_names, function (name, index) {var
                        user = _. find( users, function (u) {return
                          name == u. first_name + (u. last_name
                            ? (" " + u. last_name)
                            :"");
                        }); if
                        (user) {totals[user. id] +=amounts[index];user_shares. push(user. id);user_amounts[user. id] =amounts[index];
                        }
                      }); item_obj["users"] =user_shares; item_obj["shares"] =user_amounts; item_data["items"].push(item_obj);
                    }
                  } catch
                  (e) {console. log(e);
                  }
                }); _. each( users, function (user) {var
                  total = totals[user. id];_. each( [
                    "tax", "tip"
                  ],function (type) {var
                    adj = item_data[type]["users"][user. id];if
                    (!adj) {var
                      percent = item_data[type]["total"];if
                      (percent) {percent = safe_parse_float(percent. replace(/%/,"")) /100.0; adj = totals[user. id] *percent;
                      } else
                      { adj = 0.0;
                      }
                    }
                    total += adj;
                  }); user_grand_totals[user. id] =total;
                }) item_data["subtotals"] =totals; item_data["totals"] =user_grand_totals; this. set("items", item_data);this. set({split: "split", split_type: "itemized"});
              } else
              if (minShare == maxShare || (this. get("cost") >1 && (minShare + 0.01 * this. get("users").length) >maxShare)) {
                // all owed shares are equal, w00t
                this. set({split: "split", split_type: "equal"});
              } else
              {
                // default to unequal split
                this. set({split: "split", split_type: "unequal"});
              }
            }

            // Is each person paying their own share? (e.g. rent)
            if
            (this. get("cost") >0) {this. set({
                eachPaidOwnShare: true
              }, {silent: true});var
              model = this; _. each( this. get("users"),function (u) {if
                (u. paid_share != u. owed_share) model. set({
                    eachPaidOwnShare: false
                  }, {silent: true});
                }
              )
            } else
            {
              // Don't check this box by default for new expenses
              this. set({
                eachPaidOwnShare: false
              }, {silent: true});
            }
          },

          // Add reference to cross-platform categorization function
          guessCategoryFromDescription: guess_category, guessCategory: function () {if
            (this. get("categorySetManually")) {return;
            }

            this. set({
              category: { id: this. guessCategoryFromDescription(this. get('description'))
              }
            });
          },

          payer: function () {return
            this. getUser(this. get("onePayer"));
          },

          payee: function () {return
            this. getUser(this. get("onePayee"));
          },

          guessPayee: function () {var
            payee = _. find( this. get("users"),function (u) {return
              u. owed_share > 0
            }); if
            (payee) {this. set("onePayee", payee. user_id);
            } else
            { var
              p = this. payer().id; var
              user_ids = _. map( this. get("usersList"),function (u) {return
                u. id
              }); var
              other_user = _. find( user_ids, function (user_id) {return
                user_id != p
              }); this. set("onePayee", other_user);
            }
          },

          categoryIcon: function () {if
            (this. isPayment()) {if
              (this. get("transaction_method") =="paypal") return
                "//dx0qysuen8cbs.cloudfront.net/assets/fat_rabbit/app/payment-icon-big-paypal-876d6467f652c65534083d66cf391cd6.png";
              else
              if (this. get("transaction_method") =="venmo") return
                "//dx0qysuen8cbs.cloudfront.net/assets/fat_rabbit/app/payment-icon-big-venmo-bd7ed1ec9be1f43bc32247ebd1234e65.png";
              else
               return
                "//dx0qysuen8cbs.cloudfront.net/assets/fat_rabbit/app/payment-icon-big-black-fa200924d2c9b0c0f724ba0f151cd67c.png";
              }
            else
            { var
              cat = App. categories. get(this. get("category").id);if
              (cat) return
                cat. get("icon");
              else
               return
                "blah";
              }
            },

          cancelIOU: function () {
            // if we now have <>2 people, reset from "iou" to "equal split"
            var
            splitType = this. get("split");if
            ((splitType == "iou" || splitType == "uoi") &&this. get("usersList").length > 2) {this. set({split: "split", split_type: "equal"});
            }
          },

          updatePaidShares: function () {
            // if it's an IOU, set the paid_shares and return
            var
            splitType = this. get("split");if
            (splitType == "iou" || splitType == "uoi") {var
              cost = this. get("cost");var
              users = this. get("users");_. each( users, function (user, index) {if
                (user. user_id == current_user) user. paid_share = (splitType == "iou"
                    ? 0
                    : cost);
                else
                 user. paid_share = (splitType == "iou"
                    ? cost
                    : 0);
                }
              ); return;
            }

            // if it's a reimbursement, special case
            if
            (this. get("split_type") =="reimbursement") {var
              oR = this. get("oneReimburser");var
              cost = this. get("cost");_. each( this. get("users"),function (user) {user. owed_share = (user. user_id == oR
                  ? cost
                  : 0);
              }); return;
            }

            var
            oP = this. get("onePayer");if
            (oP) {
              // check that the onePayer has not been removed
              if
              (this. get("usersList") &&! _. find( this. get("usersList"),function (u) {return
                u. id == oP
              })) {if
                (this. get("usersList").length == 0 && oP == current_user) {
                  // do nothing - this is to prevent a infinite loop for an empty list of people
                } elseif (this. get("usersList").length == 0) this. set("onePayer", current_user);
                else
                 this. set( "onePayer", this. get("usersList")[0].id);
                }

              // if one person is specified as having paid the full cost, update their paid_share
              // to reflect that fact (even if the total cost has changed)
              var
              users = this. get("users");var
              onePayer = this. get("onePayer");var
              totalCost = this. get("cost");_. each( users, function (user) {user. paid_share = (user. user_id == onePayer
                  ? totalCost
                  : 0);
              });
            } else
            if (this. previous("onePayer")) {
              // if we used to have a onePayer and now don't, reset all paid_shares
              var
              users = this. get("users");_. each( users, function (user) {user. paid_share = null;
              });
            }

            if
            (!oP && this. get("eachPaidOwnShare")) {
              // set each involved person's paid_share to be equal to their owed_share
              _. each( this. get("users"),function (user) {user. paid_share = user. owed_share;
              });
            }
          },

          updateOwedShares: function (model, value, options) {
            // Avoid an extra call when updating an itemized expense
            if
            (options && options. itemized) return;

            // if it's an IOU, set the paid_shares and return
            var
            splitType = this. get("split");if
            (splitType == "iou" || splitType == "uoi") {var
              cost = this. get("cost");var
              users = this. get("users");_. each( users, function (user, index) {if
                (user. user_id == current_user) user. owed_share = (splitType == "iou"
                    ? cost
                    : 0.0);
                else
                 user. owed_share = (splitType == "iou"
                    ? 0.0
                    : cost);
                }
              );
            } else
            if (splitType == "payment") {
              // if it's a payment, set the owed_shares and return
              var
              oP = this. get("onePayee");var
              cost = this. get("cost");var
              users = this. get("users");_. each( users, function (user, index) {if
                (user. user_id == oP) user. owed_share = cost;
                else
                 user. owed_share = 0.0;
                }
              );
            } else
            if (this. get("split") =="split") {if
              (this. get("split_type") =="equal") {
                // if splitting equally, update each person's owed_share
                var
                users = this. get("users");var
                totalCost = parseFloat(this. get("cost"));var
                involved_list = this. get("equal_users");if
                (involved_list) {var
                  involved_count = _. select( involved_list, function (u) {return
                    u;
                  }). length;
                } else
                { var
                  involved_count = this. get("users").length;
                }
                var
                amounts = safe_divide_evenly_amounts(totalCost, involved_count);_. each( users, function (user, index) {if
                  (!involved_list) // by default, include all
                    user. owed_share = amounts. pop();
                  else
                  if (involved_list[user. user_id]) user. owed_share = amounts. pop();
                  else
                   user. owed_share = 0.0;
                  }
                );
              } else
              if (this. get("split_type") =="unequal") {var
                users = this. get("users");var
                amounts = this. get("unequal_amounts");if
                (amounts) {_. each( users, function (user) {try
                    { user. owed_share = amounts[user. user_id];
                    } catch
                    (e) {user. owed_share = null;
                    }
                  });
                }
              } else
              if (this. get("split_type") =="shares") {var
                shares = this. get("shares");try
                { var
                  total_shares = _. reduce( shares, function (memo, share) {return
                    memo + share
                  }) * 1.0; var
                  cost = parseFloat(this. get("cost"));var
                  costLeft = cost; var
                  totalPercentPaid = 0.0; _. each( this. get("users"),function (user) {var
                    share = shares[user. user_id];if
                    (share) {var
                      percent = share / total_shares; totalPercentPaid += percent * 100.0;
                      // handle floating point errors
                      if
                      (totalPercentPaid > 99.99 && totalPercentPaid < 100.01) {user. owed_share = costLeft;
                      } else
                      { user. owed_share = Math. round(cost * percent * 100) /100.0;
                      }
                      costLeft -= user. owed_share;
                    } else
                     user. owed_share = 0.0;
                    }
                  );
                } catch
                (e) {_. each( this. get("users"),function (user) {user. owed_share = 0.0;
                  });
                }

              } else
              if (this. get("split_type") =="percent") {var
                percents = this. get("percents");var
                cost = parseFloat(this. get("cost"));var
                costLeft = cost; var
                users = this. get("users");var
                totalPercentPaid = 0.0; _. each( users, function (user) {try
                  { var
                    percent = percents[user. user_id];if
                    (percent) {totalPercentPaid += percent * 100.0;
                      // handle floating point errors
                      if
                      (totalPercentPaid > 99.99 && totalPercentPaid < 100.01) {user. owed_share = costLeft;
                      } else
                      { user. owed_share = Math. round(cost * percent * 100) /100.0;
                      }
                      costLeft -= user. owed_share;
                    } else
                     user. owed_share = 0.0;
                    }
                  catch
                  (e) {user. owed_share = 0.0;
                  }
                });
              } else
              if (this. get("split_type") =="adjustment") {var
                adjustments = this. get("adjustments");var
                cost = parseFloat(this. get("cost"));var
                remainder = cost - _. reduce( adjustments, function (memo, adj) {return
                  memo + adj
                },
                0.0); var
                amounts = safe_divide_evenly_amounts(remainder, _. size(adjustments));_. each( this. get("users"),function (user) {user. owed_share = 0.0; try
                  { var
                    adjustment = adjustments[user. user_id];
                  } catch
                  (e) {var
                    adjustment = 0.0;
                  }

                  user. owed_share = adjustment + amounts. pop();
                });
              } else
              if (this. get("split_type") =="reimbursement") {
                // if reimbursing, update each person's paid_share
                var
                users = this. get("users");var
                totalCost = Math. abs(parseFloat(this. get("cost")));var
                involved_list = this. get("reimbursements");if
                (involved_list) {var
                  involved_count = _. select( involved_list, function (u) {return
                    u;
                  }). length;
                } else
                { var
                  involved_count = this. get("users").length;
                }
                var
                amounts = safe_divide_evenly_amounts(totalCost, involved_count);_. each( users, function (user, index) {if
                  (!involved_list) // by default, include all
                    user. paid_share = amounts. pop();
                  else
                  if (involved_list[user. user_id]) user. paid_share = amounts. pop();
                  else
                   user. paid_share = 0.0;
                  }
                );
              } else
              if (this. get("split_type") =="itemized") {var
                totals = this. get("items")["totals"];_. each( this. get("users"),function (user) {user. owed_share = 0.0; try
                  { user. owed_share = totals[user. user_id];
                  } catch
                  (e) {user. owed_share = 0.0;
                  }
                }); var
                cost = safe_parse_float(_. reduce( totals, function (memo, amount) {return
                  memo + amount
                },
                0.0));cost = Math. round(cost * 100.0) /100.0; if
                (this. get("cost") !=cost) {this. set("cost", cost, {itemized: true});
                };
              }
            }
          },

          setUsersList: function () {if
            (this. changedAttributes()) {var
              changedKeys = _. keys(this. changedAttributes());if
              (($. inArray("comments", changedKeys) !=-1 || $. inArray("comments_count", changedKeys) !=-1) &&$. inArray("users", changedKeys) ==-1) {
                // Don't refresh usersList when just fetching comments or updating comment count
                // (It's causing bugs with expense details for payments. Because my code is a house of cards. Wah-wah.)
                return;
              }
            }

            var
            usersList; if
            (this. get('users')) {usersList = _. collect( this. get('users'),function (u) {var
                userId = null; if
                (u. user_id) userId = u. user_id;
                else
                if (u. user && u. user. user_id) userId = u. user. user_id;

                var
                existingUserId = (parseInt(userId) >0);if
                (userId && userId == current_user) {return
                  currentUserObject;
                } else
                if (userId && existingUserId) {
                  // what if user is involved in an expense with users he/she isn't friends with?
                  var
                  friend = App. friends. get(userId);if
                  (friend) return
                    App. friends. get(userId).attributes;
                  else
                  if (u. user) return
                    u. user;
                  else
                  { return
                    {
                      id: userId,
                      first_name: "[Unknown or removed]",
                      last_name: null,
                      email: null,
                      phone: null, picture: { small: "https://secure.gravatar.com/avatar/7a5cc67c280675eb39c26cdfc650f387?s=50&d=mm&r=r", medium: "https://secure.gravatar.com/avatar/7a5cc67c280675eb39c26cdfc650f387?s=100&d=mm&r=r", large: "https://secure.gravatar.com/avatar/7a5cc67c280675eb39c26cdfc650f387?s=200&d=mm&r=r"
                      }
                    }
                  }
                } else
                { return
                  {
                    id: userId,
                    first_name: u. user. first_name,
                    last_name: u. user. last_name,
                    email: u. user. email,
                    phone: u. user. phone, picture: { small: "https://secure.gravatar.com/avatar/7a5cc67c280675eb39c26cdfc650f387?s=50&d=mm&r=r", medium: "https://secure.gravatar.com/avatar/7a5cc67c280675eb39c26cdfc650f387?s=100&d=mm&r=r", large: "https://secure.gravatar.com/avatar/7a5cc67c280675eb39c26cdfc650f387?s=200&d=mm&r=r"
                    }
                  }
                }
              });
            } else
             usersList = {};

            // sort users list alphabetically
            usersList. sort( function(a, b) {return
              a. first_name. localeCompare(b. first_name)
            }); if
            (_. isEqual(usersList, this. get("usersList"))) return;
            else
            { this. set('usersList', usersList);
            }
          },
          relationship: function () {if
            (this. get("relationship_type") =="group") App. groups. fetchGroup(this. get("relationship_id"));
            else
             App. friendships. fetchFriendship(this. get("relationship_id"));
            }
          ,
          payers: function () {return
            _. filter( this. get("users"),function (user) {return
              user['paid_share'] >0
            });
          },
          owers: function () {return
            _. filter( this. get("users"),function (user) {return
              user['owed_share'] >0
            });
          },
          getUser: function (id, options) {
            // TODO: display long names when options.long == true
            try
            { var
              user = App. friends. get(id);if
              (id == current_user) {return
                new App. Models. User(currentUserObject);
              } else
              if (user) {return
                user;
              } else
              { user = _. find( this. get("users"),function (u) {return
                  u. user_id == id
                }); return
                new App. Models. User(user. user);
              }
            } catch
            (e) {return
              new App. Models. User(currentUserObject);
            }
          },
          getShare: function (id) {return
            _. find( this. get("users"),function (u) {return
              u. user_id == id || u. user_id == parseInt(id);
            });
          },
          netBalance: function (user_id) {if
            (user_id) {var
              s = _. find( this. get("users"),function (u) {return
                parseInt(u['user_id']) ==user_id
              }); return
              (s
                ? parseFloat(s. net_balance)
                :0.0);
            } else
            if (App. currentRelationship && App. currentRelationship. get("relationship_type") =="friend") {
              // Find repayment between these two users
              var
              friend = App. currentRelationship. id; var
              repayment = _. find( this. get("repayments"),function (r) {return [
                  parseInt(r['from']),parseInt(r['to'])
                ].sort().toString() ==[current_user, friend].sort().toString()
              }); if
              (repayment) {if
                (repayment['from'] ==current_user) return - parseFloat(repayment['amount']);
                else
                 return
                  parseFloat(repayment['amount']);
                }
              else
              { return
                0;
              }
            } else
            { var
              current_user_share = _. find( this. get("users"),function (u) {return
                parseInt(u['user_id']) ==current_user
              }); return
              (current_user_share
                ? parseFloat(current_user_share['net_balance'])
                :0.0);
            }
          },
          equalSplit: function (shareCount) {if
            (this. get('users').length == 0) {return
              {standard: 0.0, leftover: 0.0};
            } else
            { if
              (shareCount === undefined) shareCount = _. select( this. get("equal_users"),function (u) {return
                  u
                }). length;

              if
              (!shareCount) shareCount = this. get("users").length;

              var
              cost = parseFloat(this. get('cost')) ||0.0; var
              split = cost / shareCount; var
              standard_share = Math. round(split * 100) /100.0; var
              leftover_share = parseFloat(this. get('cost')) -standard_share * (shareCount - 1);return
              {standard: standard_share, leftover: leftover_share};
            }
          },
          toApiJSON: function () {expense_hash = {}for
            (key in this. attributes) {if
              ([
                "cost",
                "creation_method",
                "currency_code",
                "date",
                "description",
                "details",
                "email_reminder",
                "email_reminder_in_advance",
                "group_id",
                "id",
                "payment",
                "repeat_interval",
                "repeats",
                "transaction_method"
              ].indexOf(key) !=-1) {
                // just copy these attributes
                if
                (this. attributes[key] !=null && this. attributes[key] !=undefined) expense_hash[key] =this. attributes[key];
                }
              else
              if (key == "category") {expense_hash. category_id = this. attributes. category. id;
              } else
              if (key == "users") {_. each( this. attributes. users, function (user, index) {var
                  owed_share, paid_share, owed_share = parseFloat(user. owed_share);paid_share = parseFloat(user. paid_share);if
                  (isNaN(owed_share)) owed_share = 0.0;
                  if
                  (isNaN(paid_share)) paid_share = 0.0;

                  // only include user if they had a share in this expense
                  if
                  (owed_share != 0 || paid_share != 0) {if
                    (user. user_id && parseInt(user. user_id) >0) {
                      // known user; just pass along id
                      expense_hash["users__" + index + "__user_id"] =parseInt(user. user_id)
                    } else
                    {
                      // new user; pass along name and email address
                      expense_hash["users__" + index + "__first_name"] =user. user. first_name; expense_hash["users__" + index + "__last_name"] =user. user. last_name; expense_hash["users__" + index + "__email"] =user. user. email;
                    }
                    expense_hash["users__" + index + "__paid_share"] =paid_share. toFixed(2);expense_hash["users__" + index + "__owed_share"] =owed_share. toFixed(2);
                  }
                });
              }
            }

            //Need to do this outside the loop or the details copy will overwrite this
            if
            (this. attributes. split_type == "itemized") {var
              itemized_notes = ""; var
              users = this. get("usersList");var
              item_data = this. get("items");_. each( item_data["items"],function (item) {var
                description = item["description"];var
                amount = parseFloat(item["cost"]);if
                (!isNaN(amount) &&isFinite(amount)) {itemized_notes += description + " - " + amount. toFixed(2) +" ("; var
                  parties = [];_. each( users, function (user) {if
                    (_. contains(item["users"],user. id)) {parties. push(user. first_name + (user. last_name
                        ? (" " + user. last_name)
                        :""));
                    }
                  }) itemized_notes += parties. join(", ") +")\n";
                }

              }) var
              tax = item_data["tax"]["total"];if
              (tax && tax. indexOf("%") >=0) {itemized_notes += "Tax: " + tax + "\n";
              } else
              { var
                tax_amounts = [];_. each( users, function (user) {var
                  raw_tax = item_data["tax"]["users"][user. id];raw_tax = isNaN(raw_tax)
                    ?0.0
                    : raw_tax; tax_amounts. push(user. first_name + (user. last_name
                    ? (" " + user. last_name)
                    :"") +" - " + raw_tax. toFixed(2));
                }); itemized_notes += "Tax: " + tax_amounts. join(", ") +"\n";
              }

              var
              tip = item_data["tip"]["total"];if
              (tip && tip. indexOf("%") >=0) {itemized_notes += "Tip: " + tip + "\n";
              } else
              { var
                tip_amounts = [];_. each( users, function (user) {var
                  raw_tip = item_data["tip"]["users"][user. id];raw_tip = isNaN(raw_tip)
                    ?0
                    : raw_tip; tip_amounts. push(user. first_name + (user. last_name
                    ? (" " + user. last_name)
                    :"") +" - " + raw_tip. toFixed(2));
                }); itemized_notes += "Tip: " + tip_amounts. join(", ") +"\n";
              }

              if
              (expense_hash["details"]) {var
                details = expense_hash["details"];if
                (details. indexOf("Tax") >=0 && details. indexOf("Tip") >=0) {var
                  real_details = details. split("\n\r\n\r").slice(0, -1);details = real_details. join("\n\n");
                }

                expense_hash["details"] =details + "\n\n" + itemized_notes;
              } else
              { expense_hash["details"] =itemized_notes;
              }
            }

            if
            (!expense_hash["creation_method"]) {
              // metadata for analytics purposes
              if
              (this. isPayment()) expense_hash["creation_method"] ="payment";
              else
               expense_hash["creation_method"] =this. get("split_type");
              }

            return
            expense_hash;
          },
          unread: function () {
            // used for notifications
            if
            (this. get("created_by") ==current_user) {return
              false;
            } else
            if (App. notifications_read) {var
              new_update = Date. fromISO(this. get("updated_at"));var
              last_update = Date. fromISO(App. notifications_read);return
              (new_update > last_update);
            } else
            { return
              false;
            }
          },

          isRecurring: function () {return
            this. get('repeats') &&this. get('repeat_interval') !='never';
          },

          isPayment: function () {return
            this. get('payment');
          }
        });App. Models. User = Backbone. Model. extend({
          defaults: function () {return
            {
              first_name: "[Removed]",
              last_name: "",
              picture: { small: "https://secure.gravatar.com/avatar/8f9dec27581b65e39e2010c81a8de29a?s=50&d=mm&r=r", medium: "https://secure.gravatar.com/avatar/8f9dec27581b65e39e2010c81a8de29a?s=100&d=mm&r=r", large: "https://secure.gravatar.com/avatar/8f9dec27581b65e39e2010c81a8de29a?s=200&d=mm&r=r"
              }
            };
          },
          initialize: function () {this. bind('change', this. setAttrs, this);this. setAttrs();
          },
          setAttrs: function () {if
            (this. has("user_id")) this. set({
                id: this. get("user_id")
              }, {silent: true});

            this. set({
              net_balance: parseFloat(this. get("net_balance"))
            }, {silent: true});
          },
          firstNameLastInitial: function (options) {
            // requires checking of options as previous code would not exit in this if condition
            // if options was not provided at all
            if
            (this. id == current_user && options) {return
              options. uppercaseYou
                ? App. t("you__subject")
                :App. t('you__legacy');
            }

            if
            (this. get("last_name") ==undefined || $. trim(this. get("last_name")) =="") return
              this. get("first_name");
            else
             return
              this. get("first_name") +" " + this. get("last_name").substr(0, 1).toUpperCase() +".";
            }
          ,
          fullName: function (options) {if
            (this. id == current_user && options) {return
              options. uppercaseYou
                ? App. t("you__subject")
                :App. t('you__legacy');
            }

            if
            (this. get("last_name") ==undefined || $. trim(this. get("last_name")) =="") return
              this. get("first_name");
            else
             return
              this. get("first_name") +" " + this. get("last_name");
            }
          ,
          displayEmail: function () {if
            (!this. get("email")) {return
              "no email address";
            } else
            if (this. get("email").indexOf("@phone.com") !=-1) {return
              "invited via SMS";
            } else
            if (this. get("email").indexOf("@example.com") !=-1) {return
              "no email address";
            } else
            { return
              this. get("email");
            }
          }
        });App. Models. Company = Backbone. Model. extend({});App. Models. ExternalAccount = Backbone. Model. extend({});App. Models. Notification = Backbone. Model. extend({
          unread: function (read_timestamp) {if
            (!read_timestamp) read_timestamp = App. notifications_read;

            if
            (this. get("created_by") ==current_user) {return
              false;
            } else
            if (read_timestamp) {var
              new_update = Date. fromISO(this. get("created_at"));var
              last_update = Date. fromISO(read_timestamp);return
              (new_update > last_update);
            } else
            { return
              true;
            }
          }
        });

      }); // document.ready

      $(document).ready( function() {App. Collections. Currencies = Backbone. Collection. extend({
          model: App. Models. Currency,
          url: '/api/v3.0/get_currencies',
          comparator: function (currency1, currency2) {
            // Sort "USD" to the top; sort the rest alphabetically by country_code
            if
            (currency1. get("currency_code") =="USD") return
              -1;
            else
            if (currency2. get("currency_code") =="USD") return
              1;
            else
             return
              currency1. get("currency_code").localeCompare(currency2. get("currency_code"));
            }
          ,
          print: function (number, country_code) {number = number || 0; var
            sign = ''; if
            (number < 0) {sign = "-"; number = -number;
            }

            try
            { return
              sign + this. unit(country_code) +parseFloat(number).toFixed(2);
            } catch
            (e) {return
              sign + parseFloat(number).toFixed(2);
            }
          },
          unit: function (country_code) {country_code = country_code || 'ZZZ'; // Protect against the absence of a country code

            var
            currency = _. find( this. models, function (c) {return
              c. get(country_code. length == 3
                ? 'currency_code'
                : 'country_code') ==country_code;
            }); try
            {
              // for all currencies but default, show currency_code instead of unit (less confusion)
              return
              currency. get(currency. get('currency_code') ==default_currency
                ? 'unit'
                : 'currency_code');
            } catch
            (e) {return
              "";
            }
          },
          printWithCurrentCurrency: function (number) {try
            { var
              currentCurrency = default_currency;
            } catch
            (e) {var
              currentCurrency = "unknown";
            }

            return
            this. print(number, currentCurrency);
          }
        });App. Collections. Categories = Backbone. Collection. extend({
          model: App. Models. Category,
          url: '/api/3.0/get_categories',
          rootCategories: function () {return
            this. filter( function(cat) {return
              (cat. get('parent_id') ==null);
            });
          },
          childCategories: function (rootCategory) {return
            this. filter( function(cat) {return
              (cat. get('parent_id') ==rootCategory. id);
            });
          }
        });App. Collections. Groups = Backbone. Collection. extend({
          model: App. Models. Group,
          url: '/api/v3.0/get_group',
          parse: function (response) {return
            response. groups
              ? response. groups
              : response;
          },
          fetchGroup: function (id) {var
            previous = this. get(id);if
            (previous) {return
              previous;
            } else
            { console. log('Could not find group ' + id + '; it may have been deleted');
            }
          },
          comparator: function (group1, group2) {return
            group2. get("updated_at").localeCompare(group1. get("updated_at"));
          },
          involvingUser: function (user_id) {return
            this. filter( function(group) {return
              _. any( group. get("members"),function (member) {return
                member. id == user_id;
              });
            });
          },
          defaultGroup: function () {
            // Returns the "assorted expenses" group, UNLESS the user has exactly one real group
            // and there are no outstanding debts in "assorted expenses"

            // If more or less than one real group, return
            if
            (App. groups. size() !=2) {return
              App. groups. get(0);
            }

            // Check for any non-zero balances outside a group
            var
            hasNongroupDebts = (App. groups. get(0).repayments().length > 0);hasNongroupDebts = hasNongroupDebts || App. friends. find( function(f) {return
              _. find( f. groupBalances(),function (b) {return
                b. group_id == 0;
              });
            }); return
            hasNongroupDebts
              ? App. groups. get(0)
              :App. groups. find( function(g) {return
                g. id != 0
              });
          }
        });App. Collections. Friends = Backbone. Collection. extend({
          model: App. Models. Friend,
          url: '/api/v3.0/get_friend',
          parse: function (response) {return
            response. friends
              ? response. friends
              : response;
          },
          fetchFriend: function (id) {var
            previous = this. get(id);if
            (previous) {return
              previous;
            } else
            { console. log('Could not find friend ' + id + '; it may have been deleted');
            }
          },
          totalBalance: function () {var
            total_balances = {};var
            negative_balances = {};var
            positive_balances = {};_. each( this. models, function (r) {_. each( r. balance(),function (b) {b. amount = parseFloat(b. amount);if
                (b. amount == 0) return;

                if
                (total_balances[b. currency_code] ==null) total_balances[b. currency_code] =0;

                if
                (b. amount > 0) {if
                  (positive_balances[b. currency_code] ==null) positive_balances[b. currency_code] =0;

                  positive_balances[b. currency_code] +=b. amount; total_balances[b. currency_code] +=b. amount;
                } else
                if (b. amount < 0) {if
                  (negative_balances[b. currency_code] ==null) negative_balances[b. currency_code] =0;

                  negative_balances[b. currency_code] +=b. amount; total_balances[b. currency_code] +=b. amount;
                }
              })
            }); return
            {total: total_balances, positive: positive_balances, negative: negative_balances};
          },
          emailAddresses: function () {return
            this. pluck('email');
          },
          owed: function () {return
            this. filter( function(friend) {return
              _. any( friend. get('balance'),function (balance) {return
                balance. amount < 0
              });
            });
          }
        });App. Collections. Expenses = Backbone. Collection. extend({
          model: App. Models. Expense,
          url: '/api/v3.0/get_expenses?visible=true',
          comparator: function (e1, e2) {return
            e2. get("date").localeCompare(e1. get("date")) +0.1 * e2. get("updated_at").localeCompare(e1. get("updated_at"));
          },
          initialize: function () {this. bind( 'reset', function () {this. fullyLoaded = (this. models. length < 25)
            });
          },
          parse: function (response) {return
            response. expenses
              ? response. expenses
              : response;
          },
          loadMore: function (data) {if
            (!this. fullyLoaded) {var
              that = this; $('#load_more_expenses_button').button('loading')data. data. limit = 100; data. data. offset = this. models. length; data. upsert = true; data. silent = true; // don't fire 100 add events - just fire one reset at the end
              data. success = function (a, b, c) {var
                scrollPosition = window. scrollY; that. trigger("reset"); // manually fire a reset, since we suppressed individual add events
                window. scrollTo(0, scrollPosition);try
                { if
                  (b && b. expenses && b. expenses. length < 100) {$('#load_more_expenses_button').remove();that. fullyLoaded = true;
                  } else
                   $('#load_more_expenses_button').button('reset')
              } catch
                (e) {$('#load_more_expenses_button').button('reset')
                }

                // TODO: if we haven't loaded at least the last month of expenses, keep loading
                // (mainly so that we can show charts/recurring info correctly)
              }this. fetch(data);
            }
          },
          thisMonth: function (givenDate) {return
            this. filter( function(expense) {var
              expenseDate = Date. fromISO(expense. get('date'));return
              expenseDate. getMonth() ==givenDate. getMonth() &&expenseDate. getYear() ==givenDate. getYear();
            });
          },
          thisMonthSummary: function (givenDate) {var
            result = { expenses_paid: {},expenses_owed: {},payments_made: {},payments_received: {},net_change: {}
            };

            _. each( this. thisMonth(givenDate),function (e) {var
              share = e. getShare(current_user);if
              (!share) {return;
              }

              if
              (e. isPayment()) {if
                (share. paid_share > 0) {if
                  (!result. payments_made[e. get("currency_code")]) result. payments_made[e. get("currency_code")] =0.0;
                  result. payments_made[e. get("currency_code")] +=share. paid_share;
                }

                if
                (share. owed_share > 0) {if
                  (!result. payments_received[e. get("currency_code")]) result. payments_received[e. get("currency_code")] =0.0;
                  result. payments_received[e. get("currency_code")] +=share. owed_share;
                }

              } else
              { if
                (share. paid_share > 0) {if
                  (!result. expenses_paid[e. get("currency_code")]) result. expenses_paid[e. get("currency_code")] =0.0;
                  result. expenses_paid[e. get("currency_code")] +=share. paid_share;
                }

                if
                (share. owed_share > 0) {if
                  (!result. expenses_owed[e. get("currency_code")]) result. expenses_owed[e. get("currency_code")] =0.0;
                  result. expenses_owed[e. get("currency_code")] +=share. owed_share;
                }
              }

              if
              (!result. net_change[e. get("currency_code")]) result. net_change[e. get("currency_code")] =0.0;
              if
              (share. paid_share > 0) result. net_change[e. get("currency_code")] +=share. paid_share;
              if
              (share. owed_share > 0) result. net_change[e. get("currency_code")] -=share. owed_share;
              }
            ); _. each( result, function (r) {if
              (_. size(r) ==0) r[default_currency] =0.0;
              }
            ); return
            result;
          },
          recurringExpenses: function () {return
            this. select( function(expense) {return
              expense. isRecurring();
            });
          }
        });App. Collections. Notifications = Backbone. Collection. extend({
          initialize: function () {this. bind('change', this. setNotificationsFlag, this);this. bind('reset', this. setNotificationsFlag, this);this. bind('add', this. setNotificationsFlag, this);
          },
          model: App. Models. Notification, url: "/api/v3.0/get_notifications?limit=5", comparator: function (e1, e2) {return
            e2. get("created_at").localeCompare(e1. get("created_at"));
          },
          parse: function (response) {return
            response. notifications
              ? response. notifications
              : response;
          },
          loadMore: function (data) {data = data || { data: {}
            };

            var
            that = this; $('#load_more_notifications').text(App. t('_in_progress', App. t('loading')));data. data. limit = this. size() +25; data. upsert = true; data. silent = true; // don't fire 25 add events - just fire one reset at the end
            data. success = function (a, b, c) {that. trigger("reset"); // manually fire a reset, since we suppressed individual add events
              $('#load_more_notifications').text(App. t("show_more"));
            }
            this. fetch(data);
          },
          after: function (time) {return
            this. filter( function(notification) {var
              expenseDate = Date. fromISO(notification. get('created_at'));return
              expenseDate > time;
            });
          },
          setNotificationsFlag: function () {
            // Only mark as unread if (a) new update and (b) update was not by current user
            $('#notifications_link').removeClass('unread');if
            (App. notifications_count_at_page_load > 0) {$('#notifications_link').addClass('unread');
            }

            if
            (this && this. first()) {var
              new_update = Date. fromISO(this. first().get("created_at")),last_update = Date. fromISO(App. notifications_read);if
              (new_update == last_update) {return;
              }

              if
              (last_update == 'undefined') {$('#notifications_link').addClass('unread');
              } else
              { _. each( this. after(last_update),function (n) {if
                  (n. unread()) {$('#notifications_link').addClass('unread');
                  }
                });
              }
            }
          }
        });App. Collections. ExternalAccounts = Backbone. Collection. extend({
          model: App. Models. ExternalAccount,
          url: '/api/v3.0/get_external_accounts',
          comparator: function (e1, e2) {return
            e2. get("company").name. localeCompare(e1. get("company").name);
          },
          parse: function (response) {this. loaded = true; return
            response. external_accounts
              ? response. external_accounts
              : response;
          }
        });

      }); // document.ready

      $(document).ready( function() {Backbone. View. prototype. close = function () {if
          (this. el) {$(this. el).empty();
          }

          this. unbind();if
          (typeofthis. onClose == 'function') {this. onClose();
          }
        }

        App. Views. BalancesSidebar = Backbone. View. extend({
          el: '#left_sidebar',
          template: JST["backbone/templates/balances-sidebar"],
          events: {
            'click a.show_inactive_accounts': 'expand',
            'click button.send_invite': 'sendInvite',
            'keyup #filter_search': "filterSearch",
            'keypress input[type=email]': "sendInviteOnEnter",
            'click .social a': function (e) {mpq. push([
                "track",
                "Sidebar sharing link", { action: $(e. currentTarget).data("action")
                }
              ]);
            }
          },
          initialize: function (options) {App. groups. bind('reset', this. render, this);App. groups. bind('change', this. render, this);App. groups. bind('add', this. render, this);App. friends. bind('reset', this. render, this);App. friends. bind('change', this. render, this);App. friends. bind('add', this. render, this);this. render();this. filterSearch();this. clickToExpand = false;
          },
          expand: function () {$('.show_inactive_accounts').hide();this. clickToExpand = true; this. filterSearch();return
            false;
          },
          render: function () {$(this. el).html(this. template());if
            (this. $('.tags a[data-active="false"]').size() ==0) this. $('#groups_show_inactive_accounts').hide();

            if
            (this. $('.people a[data-active="false"]').size() ==0) this. $('#friends_show_inactive_accounts').hide();

            if
            (!this. clickToExpand) this. $('a[data-active="false"]').hide();

            this. $('[rel=tooltip]').tooltip({placement: 'right'});if
            (App. notifications) App. notifications. setNotificationsFlag();
            }
          ,

          filterSearch: function () {if
            ($('#filter_search').val() =="" || $('#filter_search').val() ==undefined) {this. $('a[data-filterable="true"]').show();this. $('.add-on').removeClass('active');
            } else
            { this. $('a[data-filterable="true"]').hide();this. $('a[data-search-string*="' + $('#filter_search').val().toLowerCase() +'"]').show();this. $('.add-on').addClass('active');
            }

            if
            (!this. clickToExpand) this. $('a[data-active="false"]').hide();
            }
          ,

          sendInvite: function () {if
            (this. $('.invite_email').val() =="" || this. $('.invite_email').val().indexOf("@") ==-1) {return
              alert(App. t('invalid_email_alert'));
            }

            var
            that = this; this. $('.invite_ajax_indicator').show();$. ajax({
              url: "/api/v3.0/create_friends",
              data: {
                "friends": [
                  {
                    "user_name": that. $('.invite_email').val(),
                    "user_email": that. $('.invite_email').val()
                  }
                ]
              },
              type: "POST", dataType: "json", success: function (data) {that. $('.invite_ajax_indicator').hide();if
                ( data["friends"]["errors"]) { alert(App. t('general_unknown_error'));
                } else
                { if
                  ( data["friends"][0] &&data["friends"][0]["id"]) { that. $(".invite_email").val("").focus();that. $('.invite_success').slideDown();setTimeout("$('#left_sidebar .invite_success').slideUp(250)", 3000);App. friends. add( data["friends"][0]);
                  } else
                  { alert(App. t('general_unknown_error'));
                  }
                }
              },
              error: function (data) {that. $('.invite_ajax_indicator').hide();alert(App. t('general_unknown_error'));
              }
            });
          },

          sendInviteOnEnter: function (e) {if
            (e. keyCode != 13) return;
            this. sendInvite();
          }
        });App. Views. DetailsSidebar = Backbone. View. extend({
          el: '#right_sidebar_content',
          template: JST["backbone/templates/details-sidebar"],
          events: {
            'click .nav a': 'setActive',
            'click .toggle_involvement': 'toggleInvolvement',
            'click .resend_invite': 'resendInvite',
            'click .nav a.loadmore': 'loadMoreExpenses',
            'click #edit_whiteboard': 'showWhiteboardForm',
            'click #save_whiteboard': 'updateWhiteboard',
            'click #whiteboard_text': 'showWhiteboardForm'
          },
          initialize: function (options) {App. groups. bind('reset', this. render, this);App. groups. bind('change', this. render, this);App. friends. bind('reset', this. render, this);App. friends. bind('change', this. render, this);
          },

          render: function () {if
            (App. currentRelationship || App. dashboard || App. notifications_view) $(this. el).html(this. template({relationship: App. currentRelationship}));
            else
             $(this. el).empty();

            if
            (App. currentRelationship) {if
              (this. relationshipBalances) this. relationshipBalances. close();

              this. relationshipBalances = new App. Views. RelationshipBalances({model: App. currentRelationship});this. relationshipBalances. render();
            }

            if
            (this. recurringList) this. recurringList. close();
            this. recurringList = new App. Views. RecurringList();this. recurringList. render();if
            (this. mainTrends) this. mainTrends. close();
            this. mainTrends = new App. Views. MainTrends();this. mainTrends. render();if
            (this. monthlyChart) this. monthlyChart. close();
            this. monthlyChart = new App. Views. MonthlyChart();this. monthlyChart. render();$('.tooltip').hide();this. $('.nav *[rel=tooltip]').tooltip({placement: 'bottom'});
          },

          setActive: function (item) {var
            button = $(item. currentTarget);this. $('.nav a').removeClass('open');button. addClass('open');
          },

          toggleInvolvement: function () {App. settings. show_items_not_involving_me = ! App. settings. show_items_not_involving_me; if
            (App. settings. show_items_not_involving_me) {if
              (App. settings. show_settled_bills) $('.expense.uninvolved').slideDown(250);
              else
               $('.expense.uninvolved:not(.settled)').slideDown(250);
              $('.toggle_involvement').text(App. t('hide_items_without_me'));
            } else
            { $('.expense.uninvolved').slideUp(250);$('.toggle_involvement').text(App. t('show_items_without_me'));
            }
            return
            false;
          },

          resendInvite: function () {if
            (App. currentRelationship. get("relationship_type") =="friend") {App. showLoader(App. t('sending'));$. ajax({
                url: "/api/v3.0/resend_invite/" + App. currentRelationship. get("id"),data: {},type: "POST", dataType: "json", success: function (data, status) {if
                  (status == "success" && data["success"] ==true) {App. closeLoader({type: 'success', message: App. t('invite_resent')});
                  } else
                  { App. closeLoader({type: 'error'});
                  }
                },
                error: function (data, status) {alert(App. t('general_unknown_error'));
                }
              });
            }
          },

          loadMoreExpenses: function () {if
            (App. currentRelationship. id == -1) App. expenses. loadMore({data: {}});
            else
            if (App. currentRelationship. get("relationship_type") =="group") App. expenses. loadMore({
                data: { group_id: App. currentRelationship. get("id")
                }
              });
            else
             App. expenses. loadMore({
                data: { friend_id: App. currentRelationship. get("id"),group_id: 0
                }
              });
            }
          ,

          showWhiteboardForm: function () {this. $("#whiteboard_show").hide();this. $("#whiteboard_edit").show();this. $("#whiteboard_form").focus();
          },

          updateWhiteboard: function () {
            //update group with new data, show loader, move to original whiteboard
            var
            that = this; if
            (App. currentRelationship. get("relationship_type") =="group") {App. showLoader(App. t('saving'));$. ajax({
                url: "/api/v2.0/update_group_settings",
                data: {
                  "id": App. currentRelationship. get("id"),
                  "whiteboard": that. $("#whiteboard_form").val()
                },
                type: "POST", dataType: "json", success: function (data, status) {var
                  errors = null; if
                  (status == "success") {if
                    ( data["group"]["errors"]) { errors = App. t('general_unknown_error');
                    } else
                    { $("#whiteboard_text").html( data["group"]["whiteboard"]);
                    }
                  }

                  if
                  (errors || status != "success") {App. closeLoader({type: 'error'});alert(errors
                      ? errors
                      : status);
                  } else
                  { App. closeLoader({type: 'success', message: App. t('success')});$("#whiteboard_show").show();$("#whiteboard_edit").hide();
                  }
                },
                error: function (data, status) {alert(App. t('general_unknown_error'));
                }
              });
            }
            //TODO: whiteboard for friendships?
          }
        });App. Views. InviteFriends = Backbone. View. extend({
          el: "#invite_friends",
          template: JST["backbone/templates/modals/invite-friends"],
          events: {
            'addContacts': 'addContacts',
            "click a.submit": "inviteFriends",
            "click .input-data": function () {this. render();setTimeout("$('#token-input-invite-input').click()", 100);
            },
            "click .pick_a_method button": "showMainForm"
          },

          initialize: function (options) {_. bindAll(this, 'render', 'addPerson');this. render();
          },

          render: function () {var
            that = this; var
            shouldShowMainForm = false; $(this. el).html(this. template());this. setupTokenInput([]);_. each( third_party_tokens, function (tokens, source) {that. addContacts(null, source, tokens);shouldShowMainForm = true;
            }); if
            (shouldShowMainForm) this. showMainForm();

            return
            this;
          },

          setupTokenInput: function (entries) {if
            (entries && entries. length > 0) {
              // Update the list of entries to search, as well as the text shown when the field is empty
              this. $(".invite-input").tokenInput("setOptions", {
                local_data: entries, hintText: null, //"Hit enter to add this person",
                noResultsText: '[blank]' //"Hit enter to add this person"
              });
            } else
            { this. $(".invite-input").tokenInput(entries, {
                theme: "mac", preventDuplicate: true, placeholder: App. t('enter_names_or_emails'),hintText: (entries. length > 0
                  ? App. t('hit_enter_to_add_person')
                  :null),searchDelay: 0, prePopulate: this. removeTokenInput(),animateDropdown: false, noResultsText: '[blank]', searchDelay: 0, resultsLimit: 8, initialWidth: 300, leftPadding: 28, allowTabOut: true, allowFreeTagging: true, onFreeTaggingAdd: this. addPerson, resultsFormatter: function (input) {var
                  result = "<li><p>" result += input. name; if
                  (input. name. indexOf("@") ==-1) result += " (" + input. email + ")";
                  result += "</p></li>" return
                  result;
                }
              });
            }
          },

          removeTokenInput: function () {
            //get existing tokens
            if
            (this. $(".token-input-list-mac").get(0)) {return
              this. $(".invite-input").tokenInput("get");
            }
          },

          showMainForm: function () {this. $('.pick_a_method').fadeOut();this. $('.invite_method.email').fadeIn();this. $('#token-input-invite-input').click();
          },

          inviteFriends: function () {if
            (this. $('a.submit').hasClass('disabled')) return;

            var
            that = this, invitees = [];this. $('a.submit').addClass('disabled');this. $(".invite-input").tokenInput("get").map( function(token) {invitees. push({"user_name": token["name"],"user_email": token["email"]});
            }); mpq. push([
              "track",
              "Invite friends: submit", { userCount: invitees. length, messageIncluded: ! !(this. $('textarea').val())
              }
            ]);$. ajax({
              url: "/api/v3.0/create_friends",
              data: { friends: invitees, message: this. $('textarea').val()
              },
              type: "POST", dataType: "json", success: function (data) {that. $('a.submit').removeClass('disabled');if
                ( data["friends"]["errors"]) { alert(App. t('general_unknown_error'));mpq. push(["track", "Invite friends: error"]);
                } else
                { _. each( data["friends"],function (f) {App. friends. add(f);
                  }) that. $(".invite-input").tokenInput("clear");$(that. el).modal("hide");mpq. push(["track", "Invite friends: success"]);
                }
              },
              error: function (data) {that. $('a.submit').removeClass('disabled');mpq. push(["track", "Invite friends: error"]);alert(App. t('general_unknown_error'));
              }
            });
          },

          addContacts: function (event, source, contacts) {var
            entries = [];contacts = contacts. sort( function(a, b) {var
              total = 0; if
              (a. friends && ! b. friends) // Sort existing friends to the bottom
                total += 10000;
              if
              (!a. friends && b. friends) total -= 10000;
              if
              (a. signed_up && ! b. signed_up) // Sort signed-up-but-not-yet-friends people to the top
                total -= 100;
              if
              (!a. signed_up && b. signed_up) total += 100;
              try
              { total += a. name. toLowerCase().localeCompare(b. name. toLowerCase()); // Sort alphabetically
              } catch(e) {}
              returntotal;
            }); _. each( contacts, function (contact) {entries. push({name: contact. name, email: contact. email});
            }); this. setupTokenInput(entries);this. $('.gmail').hide();this. $('.import_success').show();this. $('.import_success .count').text(App. t('NUMBER_contacts_imported', contacts. length));this. $('#token-input-invite-input').click();
          },

          emailAddressRegexp: /^(([^<>()[\]\\.,;:\s@\"]+(\.[^<>()[\]\\.,;:\s@\"]+)*)|(\".+\"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/,isEmailAddress: function (text) {return
            this. emailAddressRegexp. test(text);
          },

          isPhoneNumber: function (text) {if
            (!text || text. length < 10) return
              false;

            var
            phone = text. replace(/[^0-9]/g,'');return
            (phone. length == 10);
          },

          addPerson: function (input) {if
            (input. length < 1) return
              false;

            if
            (this. isEmailAddress(input)) return
              {name: input, email: input};

            var
            that = this; if
            (this. isPhoneNumber(input)) {new
              App. Views. CustomPrompt({
                prompt: App. t('enter_a_name_for_this_person'),
                data: { email: input. replace(/[^0-9]/g,'') // phone number
                },validator: function (input) {return
                  ! (input == undefined || input. length == 0);
                },
                success: function (input) {this. data. name = input; // this.data refers to the local data attribute set above
                  $("#invite_friends .invite-input").tokenInput("add", this. data).focus();
                },
                failure: function () {$("#invite_friends .invite-input").focus();
                }
              });
            } else
            { new
              App. Views. CustomPrompt({
                prompt: App. t('enter_an_email_address_for_NAME', input),data: { name: input
                },
                validator: function (input) {return
                  ! (input == undefined || input. length == 0) &&(that. isEmailAddress(input) ||that. isPhoneNumber(input));
                },
                success: function (input) {this. data. email = input; // this.data refers to the local data attribute set above
                  $("#invite_friends .invite-input").tokenInput("add", this. data).focus();
                },
                failure: function () {$("#invite_friends .invite-input").focus();
                }
              });
            }

            // make the tokenized field ignore this entry for now (this is a hard-coded custom thing in the plugin)
            return
            {name: "DELETE ME", email: "deleteme@example.com"};
          }
        });App. Views. FirstLaunch = Backbone. View. extend({
          el: "#first_launch",
          template: JST["backbone/templates/modals/first-launch"],
          events: {
            "click a": "recordClick"
          },
          initialize: function (options) {_. bindAll(this, 'render');this. render();mpq. push(["track", "First launch: shown"]);
          },
          render: function () {$(this. el).html(this. template());return
            this;
          },
          recordClick: function (e) {mpq. push([
              "track",
              "First launch: clicked option", { choice: $(e. currentTarget).data("choice")
              }
            ]);
          }
        });App. Views. CustomPrompt = Backbone. View. extend({
          tagName: "div",
          className: "custom_prompt",
          template: JST["backbone/templates/modals/custom-prompt"],
          events: {
            "click .cancel": "cancel",
            "click .ok": "ok",
            "keydown": "keydown"
          },
          keys: { // keys "enum"
            TAB: 9, ENTER: 13, ESCAPE: 27, NUMPAD_ENTER: 108
          },
          initialize: function (options) {this. prompt = options. prompt; this. data = options. data; this. validator = options. validator; this. success = options. success; this. failure = options. failure; $(document. body).append(this. el);_. bindAll(this, 'render');this. render();this. $('input[type=text]').focus();
          },
          render: function () {$(this. el).html(this. template({prompt: this. prompt}));return
            this;
          },
          cancel: function () {this. failure(undefined);this. close();
          },
          ok: function () {var
            input = this. $('input[type=text]').val();if
            (this. validator(input)) {this. success(input);this. close();
            } else
             this. $(".error_message").show();
            }
          ,
          close: function () {this. remove();this. unbind();
          },
          keydown: function (event) {switch
            (event. keyCode) {
              case
                this. keys. TAB: event. preventDefault();return
                false; break;
              case
                this. keys. ENTER:
              case
                this. keys. NUMPAD_ENTER: this. ok();break;
              case
                this. keys. ESCAPE: this. cancel();break;
            }
          }
        });App. Views. DashboardBalances = Backbone. View. extend({
          el: "#dashboard_balances",
          template: JST["backbone/templates/dashboard-balances"],
          emptyTemplate: JST["backbone/templates/dashboard-no-expenses"],
          collection: App. notifications,
          events: {
            "click .toggle-root-view button": "toggleRootView",
            "click .toggle-chart-list button": "toggleChartList",
            "click .bar": function () {$('.tooltip').hide();return
              true
            }
          },

          initialize: function (options) {_. bindAll(this, 'render');this. render();App. groups. bind('reset', this. render, this);App. groups. bind('change', this. render, this);App. groups. bind('add', this. render, this);App. friends. bind('reset', this. render, this);App. friends. bind('change', this. render, this);App. friends. bind('add', this. render, this);
          },

          render: function () {var
            allSettled = true; _. each( App. friends. models. concat(App. groups. models),function (r) {allSettled = allSettled & r. mainBalance().amount == 0
            }); if
            (!allSettled && (App. groups. size() >1 || App. friends. size() >0)) {$(this. el).html(this. template());this. $('.negative .bar').tooltip({placement: 'left'});this. $('.positive .bar').tooltip({placement: 'right'});this. $('div.img').tooltip({placement: 'top'});this. $('.toggle-root-view button').tooltip({placement: 'bottom'});this. loadCookies();
            } else
            { $(this. el).html(this. emptyTemplate());
            }

            return
            this;
          },

          toggleRootView: function (event) {this. $('.toggle-root-view button').removeClass('active');$(event. currentTarget).addClass('active');if
            ($(event. currentTarget).hasClass('people')) {this. $('#people_summary').show();this. $('#groups_summary').hide();
            } else
            { this. $('#people_summary').hide();this. $('#groups_summary').show();
            }
            this. setCookies();
          },

          toggleChartList: function (event) {this. $('.toggle-chart-list button').removeClass('active');$(event. currentTarget).addClass('active');if
            ($(event. currentTarget).hasClass('view_as_list')) {this. $('.list').show();this. $('.chart').hide();
            } else
            { this. $('.list').hide();this. $('.chart').show();
            }
            this. setCookies();
          },

          loadCookies: function () {var
            existingCookie = $. cookies. get("dashboardView");if
            ($. cookies. test() &&existingCookie) {this. $('.toggle-root-view button.' + existingCookie. rootView).click();this. $('.toggle-chart-list button.' + existingCookie. chartList).click();
            }
          },

          setCookies: function () {if
            ($. cookies. test()) {$. cookies. set("dashboardView", {
                rootView: this. $('.toggle-root-view button.active').hasClass('people')
                  ?'people'
                  : 'groups', chartList: this. $('.toggle-chart-list button.active').hasClass('view_as_list')
                  ?'view_as_list'
                  : 'view_as_chart'
              });
            }
          },

          close: function () {this. undelegateEvents();
          }
        });App. Views. NotificationsView = Backbone. View. extend({
          el: "#recent_activity",
          template: JST["backbone/templates/notifications"],
          collection: App. notifications,

          initialize: function (options) {_. bindAll(this, 'render');App. notifications. bind('reset', this. render, this);App. notifications. bind('add', this. render, this);App. notifications. bind('remove', this. render, this);
          },

          setLocalReadTimestamp: function (timestamp) {this. read_timestamp = timestamp;
          },

          render: function () {this. el = "#recent_activity";

            // We pass in read_timestamp as a substitute for App.notifications_read
            // This way, if we re-render the view (to update the list of notifications, for example), we don't lose
            // the 'unread' state on notifications that are already on-screen.
            $(this. el).html(this. template({read_timestamp: this. read_timestamp}));

            // If we're rendering this screen AND this screen is visible AND there are new notifications, mark notifications as read
            if
            (App. notifications. first() &&Backbone. history. fragment == "/activity" && App. notifications_read != App. notifications. first().get("created_at") &&! currentUserObject. read_only) {$. ajax({
                url: "/api/v3.0/update_user/" + current_user, data: {
                  "notifications_read": App. notifications. first().get("created_at")
                },
                type: "POST", dataType: "json"
              });App. notifications_read = App. notifications. first().get("created_at");$('#notifications_link').removeClass('unread');

              // Remove our record of how many unread notifications there were when the page first loaded
              delete
              App. notifications_count_at_page_load;
            }

            return
            this;
          }
        });App. Views. ExternalAccountsView = Backbone. View. extend({
          el: "#external-accounts-list",
          template: JST["backbone/templates/external-account"],
          accountSettingsTemplate: JST["backbone/templates/external-account-settings"],
          emptyAccountsTemplate: JST["backbone/templates/external-account-empty"],
          collection: App. external_accounts, events: {
            "click .external-transactions .actions a": "setCurrentTransaction"
          },

          initialize: function (options) {_. bindAll(this, 'render');this. render();Backbone. Events. on("data:expenseUpdated", this. markCurrentTransactionImported, this);App. external_accounts. bind('reset', this. render, this);App. external_accounts. bind('add', this. render, this);
          },

          render: function () {var
            that = this; this. el = "#external-accounts-list"; $(this. el).empty();if
            (!App. external_accounts. loaded) $(this. el).html("<div id='loading-external-accounts'>Loading your external accounts...</div>")
            else
            { if
              (App. external_accounts. size() ==0) {$(this. el).html(this. emptyAccountsTemplate());
              } else
              { _. each( App. external_accounts. models, function (ea) {$(that. el).append(that. template(ea. toJSON()));
                });
              }
              $(this. el).append(this. accountSettingsTemplate());
            }
            return
            this;
          },

          setCurrentTransaction: function (event) {this. currentTransactionId = $(event. currentTarget).data().transaction_id;
          },

          markCurrentTransactionImported: function (expense) {App. external_accounts. loaded = false; App. external_accounts. reset();$. ajax({
              url: "/api/v3.0/mark_external_transaction_as_imported",
              data: { id: this. currentTransactionId, expense_id: expense. id
              },
              type: "POST", dataType: "json", success: function (data, status) {
                //Reload accounts
                App. external_accounts. fetch();
              },
              failure: function (error) {alert("Oops! We couldn't finalize the transaction import. Please contact support@splitwise.com.")
                //also reload accounts
                App. external_accounts. fetch();
              }
            })
          }
        });App. Views. RelationshipDetails = Backbone. View. extend({
          el: "#center_column",
          template: JST["backbone/templates/relationship-details"],
          dashboardTemplate: JST["backbone/templates/dashboard"],
          externalAccountsTemplate: JST["backbone/templates/external-accounts"],
          events: {
            'click #load_more_expenses_button': 'loadMoreExpenses',
            'click #show_settled_bills': 'toggleSettledBills',
            'click a[data-toggle="modal"]': 'showModal',
            'click .topbar .dropdown-toggle': function () {$('.tooltip').hide();setTimeout("$('#quick_add input').focus()", 50);
            }
          },

          initialize: function (options) {_. bindAll(this, 'setRelationship');this. detailsSidebar = new App. Views. DetailsSidebar();this. sendReminder = new App. Views. SendReminderForm();this. simplifyDebts = new App. Views. SimplifyDebtsModal();this. settleUpForm = new App. Views. SettleUpForm();this. groupMemberDetails = new App. Views. GroupMemberDetails();this. groupMemberDetails. render();
          },

          showModal: function (event) {if
            (event. target. hash == "#add_bill") {if
              ($(event. currentTarget).data('expenseId')) {
                // load an expense for editing
                var
                attributes = $. extend(true, {},App. expenses. get($(event. currentTarget).data('expenseId')).attributes);model = new App. Models. Expense(attributes);
              } else
              {
                // create a new expense
                // Set a default group for this expense
                var
                group_id; try
                { if
                  (App. currentRelationship && App. currentRelationship. isGroup()) group_id = App. currentRelationship. id;
                  else
                   group_id = App. groups. defaultGroup().id;
                  }
                catch
                (e) {group_id = 0
                }

                var
                model = new App. Models. Expense({group_id: group_id});
              }

              if
              (this. addABill) this. addABill. setModel(model);
              else
               this. addABill = new App. Views. AddBillForm({model: model});
              }
            else
            if (event. target. hash == "#settle_up_form") {
              // Set a default group for this payment
              var
              group_id; try
              { if
                (App. currentRelationship && App. currentRelationship. isGroup()) group_id = App. currentRelationship. id;
                else
                 group_id = App. groups. defaultGroup().id;
                }
              catch
              (e) {group_id = 0
              }

              var
              model = new App. Models. Expense({description: "Payment", group_id: group_id, payment: true, split: "payment"});var
              balance; if
              (App. currentRelationship && App. currentRelationship. isFriend()) {balance = App. currentRelationship. mainBalance();balance = { from: (balance. amount > 0
                    ? App. currentRelationship. id
                    : current_user),to: (balance. amount > 0
                    ? current_user
                    : App. currentRelationship. id),amount: Math. abs(balance. amount),currency_code: balance. currency_code
                };
              } else
              if (App. currentRelationship && App. currentRelationship. isGroup()) {balance = _. find( App. currentRelationship. repayments(current_user),function (r) {return
                  r. from == current_user
                }); if
                (!balance) {balance = App. currentRelationship. repayments(current_user)[0];
                }
              }

              if
              (!balance) {var
                other_user = current_user; try
                { if
                  (App. currentRelationship && App. currentRelationship. isGroup()) {
                    // We're in a group but there are no repayments so select one of the group members
                    other_user = _. find( App. currentRelationship. get("members"),function (m) {return
                      m. id != current_user
                    }). id;

                  } else
                  {
                    // We're on the dashaboard so return a friend who you owe money to or your first friend if you owe nothing
                    other_user = ( App. friends. owed()[0] ||App. friends. first()). id;
                  }
                } catch
                (e) {
                  // do nothing
                }

                balance = { from: current_user, to: other_user, currency_code: default_currency, amount: 0.0
                };
              }

              model. set("users", [
                {user_id: balance. from, paid_share: 0, owed_share: 0
                }, {
                user_id: balance. to, paid_share: 0, owed_share: 0
                }
              ]);model. set({
                cost: Math. abs(balance. amount),currency_code: balance. currency_code, onePayer: balance. from, onePayee: balance. to
              });this. settleUpForm. setModel(model);
            }
          },

          setRelationship: function (relationship) {if
            (relationship) {if
              (relationship == "all" || relationship. get("id") ==-1) {
                // Refresh all balances for all balances screen
                App. groups. fetch({url: "/api/v3.0/get_groups"}); // Refresh all groups
                App. friends. fetch({url: "/api/v3.0/get_friends"}); // Refresh all friends
              }

              if(relationship == "all") {App. currentRelationship = this. relationship = relationship = null;
              } else
              { App. setActive(relationship. get("relationship_type") +"-" + relationship. get("id"));App. currentRelationship = this. relationship = relationship;

                // don't reload relationship data right after opening the page (in the first 5 seconds)
                if
                (!(page_loaded && new Date() -page_loaded < 5000)) App. currentRelationship. fetch(); // Update balance info
                }
              this. render();

              // Need to clear these to force re-rendering
              App. expenses. relationship = this. relationship; $('#expenses_list').html('<div style="padding: 15px; text-align: center; padding: 40px; color: #ccc; font-size: 20px">' + _. escape(App. t('loading')) +'<br><img src="//dx0qysuen8cbs.cloudfront.net/assets/ajax-ab209a8c5c6ba63ddecd6c3abcf43f5f.gif"></div>');var
              limit = (App. currentExpenseId
                ? 0
                : 25);if
              (limit == 0) {$('#load_more_expenses_button').remove();App. expenses. fully_loaded = true;
              }

              if
              (App. currentRelationship == null) App. expenses. fetch({
                  data: { limit: limit
                  }
                });
              else
              if (App. currentRelationship. get("relationship_type") =="group" && App. currentRelationship. id == -1) // All expenses
                App. expenses. fetch({
                  data: { limit: limit
                  }
                });
              else
              if (App. currentRelationship. get("relationship_type") =="group") App. expenses. fetch({
                  data: { group_id: relationship. get("id"),limit: limit
                  }
                });
              else
               App. expenses. fetch({
                  data: { friend_id: relationship. get("id"),limit: limit, group_id: 0
                  }
                });
              }
            else
            { App. currentRelationship = this. relationship = relationship; this. render();
            }
          },

          setActiveExpenseId: function (expense_id) {App. currentExpenseId = expense_id;
          },

          render: function () {if
            (this. relationship) {App. setPageTitle(this. relationship. name() +" · " + STRINGS. App);$(this. el).html(this. template(this. relationship. toJSON()));this. detailsSidebar. render();if
              (this. quickAdd) this. quickAdd. close();
              this. quickAdd = new App. Views. QuickAddForm();this. quickAdd. render();if
              (this. relationship. id != -1 && this. relationship. id != 0) {this. sendReminder. render();this. simplifyDebts. render();
              }

              if
              (!this. expensesList) this. expensesList = new App. Views. ExpensesList();
              this. expensesList. render();$('#load_more_expenses').hide();
            } else
            if (App. dashboard) {
              // Render dashboard
              App. setPageTitle(App. t("dashboard") +" · " + STRINGS. App);$(this. el).html(this. dashboardTemplate());this. detailsSidebar. render();

              // Notifications and balances should refresh with time
              if
              (this. dashboardBalances) this. dashboardBalances. close();
              this. dashboardBalances = new App. Views. DashboardBalances();this. dashboardBalances. render();if
              (this. quickAdd) this. quickAdd. close();
              this. quickAdd = new App. Views. QuickAddForm();this. quickAdd. render();this. $('.dashboard.header h1').text(App. t("dashboard"));this. $('#dashboard_balances').show();this. $('#recent_activity').hide();

              // don't reload friends data right after opening the page (in the first 5 seconds)
              if
              (!(page_loaded && new Date() -page_loaded < 5000)) App. friends. fetch({url: "/api/v3.0/get_friends"});
              }
            else
            if (App. notifications_view) {
              // Render recent activity
              App. setPageTitle(App. t("recent_activity") +" · " + STRINGS. App);$(this. el).html(this. dashboardTemplate());this. detailsSidebar. render();if
              (!this. notificationsView) this. notificationsView = new App. Views. NotificationsView();
              this. notificationsView. setLocalReadTimestamp(App. notifications_read);this. notificationsView. render();this. $('.dashboard.header h1').text(App. t("recent_activity"));this. $('.dashboard.header .actions').hide();this. $('#dashboard_balances').hide();this. $('#recent_activity').show();
            } else
            if (App. external_accounts_view) {
              // Render companies page
              App. setPageTitle("Companies"+ " · " + STRINGS. App);$(this. el).html(this. externalAccountsTemplate());this. detailsSidebar. render();

              // Initialize biller accounts collection if necessary
              if
              (!App. external_accounts) {App. external_accounts = new App. Collections. ExternalAccounts();App. external_accounts. loaded = false;
              }

              if
              (!this. externalAccountsView) this. externalAccountsView = new App. Views. ExternalAccountsView();
              this. externalAccountsView. render();

              // Refresh account info
              App. external_accounts. fetch();
            } else
            {
              // Render empty screen
              App. setPageTitle(STRINGS. App);$(this. el).html("<div style='padding:20px;text-align:center;color:#999'>" + App. t('cannot_view_permission_error_html') +"</div>");
            }

            this. $('.topbar *[rel=tooltip]').tooltip({placement: 'bottom'});return
            this;
          },

          loadMoreExpenses: function () {if
            (App. currentRelationship. id == -1) App. expenses. loadMore({data: {}});
            else
            if (App. currentRelationship. get("relationship_type") =="group") App. expenses. loadMore({
                data: { group_id: App. currentRelationship. get("id")
                }
              });
            else
             App. expenses. loadMore({
                data: { friend_id: App. currentRelationship. get("id"),group_id: 0
                }
              });
            }
          ,

          toggleSettledBills: function () {App. settings. show_settled_bills = ! App. settings. show_settled_bills; if
            (App. settings. show_settled_bills) {$('#expenses_list .settle-point').hide();$('#load_more_expenses.settled').show();if
              (App. settings. show_items_not_involving_me) $('#expenses_list .settled').show();
              else
               $('#expenses_list .settled:not(.uninvolved)').show();
              }
            return
            false;
          }
        });App. Views. RelationshipBalances = Backbone. View. extend({
          el: "#relationship_balances",
          template: JST["backbone/templates/relationship-balances"],

          initialize: function (options) {_. bindAll(this, 'render');this. model. bind('change optimisticUpdate', this. render);App. groups. bind('change', this. render);App. friends. bind('change', this. render);
          },

          render: function () {$(this. el).html(this. template());

            // Draw "settle up" subview
            if
            (this. settleUp) this. settleUp. close();
            this. settleUp = new App. Views. SettleUp();this. settleUp. render();this. $('*[rel=tooltip]').tooltip({placement: 'left'});

            // If this group has balances in multiple currencies AND current user has Pro,
            // show convert button and load exchange rates for display
            if
            (App. currentRelationship && App. currentRelationship. isGroup() &&_. uniq(_. pluck(App. currentRelationship. repayments(),"currency_code")).length > 1 && currentUserObject. has_pro) {var
              currencies = _. uniq(_. pluck(App. currentRelationship. repayments(),"currency_code"));var
              default_currency = currentUserObject. default_currency; var
              exchange_list = this. $('.exchange_rates');$. get( "/api/v3.0/get_exchange_rates", function (r) {exchange_list. empty();_. each( currencies, function (from_currency) {try
                  { if
                    (from_currency != default_currency) {var
                      rate = r["rates"][default_currency] *1.0 / r["rates"][from_currency];exchange_list. append("<li>1 " + from_currency + " = " + rate. toFixed(4) +" " + default_currency + "</li>");
                    }
                  } catch
                  (e) {
                    // Print something for currencies with an unknown exchange rate (which will be ignored by the conversion)
                    this. $('.exchange_rates').html("<li>1 " + from_currency + " = ???? " + default_currency + "</li>");
                  }
                });
              });
            }

            return
            this;
          },

          onClose: function () {this. model. unbind('change optimisticUpdate', this. render);App. groups. unbind('change', this. render);App. friends. unbind('change', this. render);
          }
        });App. Views. QuickAddForm = Backbone. View. extend({
          el: "#quick_add",
          events: {
            "click button": "customSubmit",
            "click input": function (e) {e. stopPropagation();
            }
          },

          template: JST["backbone/templates/quick-add"],initialize: function (options) {_. bindAll(this, 'render');
          },

          render: function () {this. el = "#quick_add"; // Refresh element, since it was rerendered
            $(this. el).html(this. template(App. currentRelationship));return
            this;
          },

          customSubmit: function () {$('#quick_add button').button('loading');var
            expense_hash = {
              'autosave': true
            };
            expense_hash['input'] =this. $("input[type=text]").val();if
            (App. currentRelationship) {if
              (App. currentRelationship. get("relationship_type") =="group") {if
                (App. currentRelationship. id > 0) expense_hash["group_id"] =App. currentRelationship. get("id");
                }
              else
              { expense_hash["friend_id"] =App. currentRelationship. get("id");
              }
            }

            App. showLoader(App. t('saving'));var
            form = this. $("input[type=text]");$. ajax({
              url: "/api/v3.0/parse_sentence",
              data: expense_hash,
              type: "POST",
              dataType: "json",
              success: function (data, status) {var
                errors = null; if
                (status == "success") {if
                  ( data["expense"]["errors"]) { errors = App. t('an_unknown_quickadd_problem_occured');
                  } else
                  { if
                    (App. currentRelationship) // optimistic balance updating
                      App. currentRelationship. adjustBalances("add", new App. Models. Expense(data["expense"]));

                    App. expenses. add(data["expense"]);$( '#expense-' + data["expense"]['id']). hide().slideDown();$('#quick_add .sample').show();$('#quick_add .status').hide();form. val("");setTimeout("$('#quickadd').popover('hide');", 100);if
                    (App. currentRelationship && App. currentRelationship. id > 0) App. currentRelationship. fetch( // Refresh balance data
                      );
                    else
                     App. friends. fetch({url: "/api/v3.0/get_friends"});
                    }
                  }

                if
                (errors || status != "success") {App. closeLoader({type: 'error'});alert(errors
                    ? errors
                    : status);$('#quickadd').focus();
                } else
                { App. closeLoader({type: 'success', message: App. t('expense_added')});
                }

                $('#quick_add button').button('reset');
              }
            });return
            false; // Prevent form submission
          }
        });App. Views. ExpenseListGroupView = Backbone. View. extend({
          tagName: "div",
          className: "expense",
          template: JST["backbone/templates/expense-list-group"],

          initialize: function (options) {_. bindAll(this, 'render');this. currentRelationship = App. currentRelationship; this. currentRelationship. bind('change', this. render);this. settled = options. settled;
          },

          render: function () {try
            {
              // this.model.balance only contains balances with the current individual
              if
              (this. model && App. currentRelationship) {
                // Update balance data with each re-render
                var
                modelId = this. model. group_id; var
                latestData = _. find( App. currentRelationship. get("groups"),function (g) {return
                  g. group_id == modelId
                }); if
                (latestData) this. model = latestData;
                }

              var
              mainBalance = _. max( this. model. balance, function (b) {return
                Math. abs(b. amount);
              }); var
              renderedContent = this. template({
                group: App. groups. get(this. model. group_id),mainBalance: mainBalance, balance: this. model. balance, balanceCount: _. select( this. model. balance, function (b) {return
                  parseFloat(b. amount) !=0
                }). length
              });
            } catch
            (err) {var
              renderedContent = "<div style='padding: 10px; background: #fee'><div style='color: #c00; font-weight: bold; font-size: 18px; margin-bottom: 5px'>Render error!</div>" + _. escape(App. t('error_expense_list_group_render')) +"</div>";
            }

            $(this. el).html(renderedContent);if
            (this. settled) $(this. el).addClass('settled');
            return
            this;
          },

          onClose: function () {this. currentRelationship. unbind('change', this. render);
          }
        });App. Views. ExpenseView = Backbone. View. extend({
          tagName: "div",
          className: "expense",
          template: JST["backbone/templates/expense"],
          summaryTemplate: JST["backbone/templates/expense-summary"],
          detailsTemplate: JST["backbone/templates/expense-details"],events: {
            "click img.receipt:not(.image)": "showCategoryPicker",
            "click .category_picker img": "setCategory",
            "click a.cancel_recurrence": "cancelRecurrence",
            "click a.delete": "removeConfirm",
            "click div.main-block": "toggleDetails",
            "click div.cost": "toggleDetails",
            "click div.you": "toggleDetails",
            "click .add_comment button:not(.disabled)": "addComment",
            'keypress .add_comment textarea': 'addCommentOnEnter',
            "click a.delete_comment": "removeCommentConfirm"
          },

          initialize: function (options) {_. bindAll(this, 'render');this. model. bind('change', this. render);this. model. bind('remove', this. remove, this);this. settled = options. settled;

            // Initialize initial container
            this. id = this. model. Id; $(this. el).attr({
              'id': "expense-" + this. model. get("id"),
              'data-date': this. model. get("date")
            }).html(this. template());
          },

          toggleDetails: function (e) {this. $('.category_picker').fadeOut(100);if
            (!this. $('.users').is(':visible')) {
              // when opening details, re-render and fetch any updates
              this. $('.users').html(this. detailsTemplate(this. model. toJSON()));this. model. fetch({
                url: "/api/v3.0/get_comments?expense_id=" + this. model. id
              });
            }
            this. $('.users').slideToggle(250);
          },

          removeConfirm: function (e) {var
            promptString = App. t(this. model. isPayment()
              ?'delete_payment_confirmation'
              : 'delete_expense_confirmation')if
            (this. model. get("creation_method") =="debt_consolidation" || this. model. get("creation_method") =="debt_simplification") promptString += ' ' + App. t('delete_with_simplification')
            else
            if (!this. model. isPayment()) promptString += ' ' + App. t('delete_expense_confirmation_warning')

            if
            (confirm(promptString)) this. deleteAndRemove(e);
            return
            false
          },

          removeCommentConfirm: function (e) {if
            (confirm(App. t('delete_comment_confirmation'))) this. deleteAndRemoveComment(e);
            return
            false
          },

          showCategoryPicker: function (e) {e. stopPropagation();var
            content = ""; var
            firstLine = true; var
            activeCategory = this. model. get('category').id; _. each( App. categories. models, function (current_category) {if
              (current_category. get("parent_id")) {content += "<img src='" + current_category. get('icon') +"' class='category_icon " + (activeCategory == current_category. get("id")
                  ?"active"
                  : "") +"' data-id='" + current_category. get("id") +"' data-name='" + current_category. get("name") +"' title='" + App. categories. get(current_category. get("parent_id")).get("name") +": " + current_category. get("name") +"'>";
              } else
              { if
                (firstLine) firstLine = false;
                else
                 content += "<br>";

                content += "<span class='parent_category'>" + current_category. get("name") +":</span>";
              }
            }); if
            (!this. $('.category_picker').is(":visible")) $('.category_picker').fadeOut(100);

            this. $('.category_picker').html(content).fadeToggle(100);this. $('.category_picker .category_icon').tooltip({placement: 'top', delay: 0});
          },

          setCategory: function (image) {this. model. set("category", {
              id: $(image. currentTarget).data('id'),name: $(image. currentTarget).data('name')
            });this. $('.category_picker').fadeOut(100);$('.tooltip.top.fade.in').remove();App. showLoader(App. t('saving'));$. ajax({
              url: "/api/v3.0/update_expense/" + this. model. get("id"),type: "POST", data: { category_id: $(image. currentTarget).data('id')
              },
              dataType: "json", success: function (data, status) {var
                error = null; if
                (status == "success") {if
                  (data["errors"] &&data["errors"].count > 0) {error = _. reduce( data["errors"],function (memo, kv) {memo + "\n" + k + " " + v
                    },
                    "");
                  }
                }

                if
                (error || status != "success") {App. closeLoader({type: 'error'});alert(error
                    ? error
                    : status);
                } else
                { App. closeLoader({type: 'success', message: App. t('success')});
                }
              }
            });
          },

          addComment: function () {App. showLoader("Adding comment");this. $('.add_comment button').addClass('disabled');var
            that = this; $. ajax({
              url: "/api/v3.0/create_comment",
              type: "POST",
              data: { expense_id: this. model. get("id"),content: this. $('.add_comment textarea').val()
              },
              dataType: "json", success: function (data, status) {var
                error = null; if
                (status == "success") {if
                  (data["errors"] &&data["errors"].count > 0) {error = _. reduce( data["errors"],function (memo, kv) {memo + "\n" + k + " " + v
                    },
                    "");
                  }
                }

                if
                (error || status != "success") {App. closeLoader({type: 'error'});that. $('.add_comment button').removeClass('disabled');alert(error
                    ? error
                    : status);
                } else
                { App. closeLoader({type: 'success', message: App. t('success')});that. model. set({
                    comments_count: that. model. get("comments_count") +1
                  }, {silent: true});that. $('.add_comment textarea').val("");that. $('.add_comment button').removeClass('disabled');that. model. fetch({
                    url: "/api/v3.0/get_comments?expense_id=" + that. model. id
                  });
                }
              },
              error: function (status) {alert(App. t('general_unknown_error'));App. closeLoader({type: 'error'});that. $('.add_comment button').removeClass('disabled');
              }
            });
          },

          addCommentOnEnter: function (e) {
            // Do not add the comment for shift + enter as this is a common way to add a new line on the web
            if
            (e. keyCode != 13 || e. shiftKey) return;
            this. addComment();
          },

          cancelRecurrence: function (image) {if
            (confirm(App. t('cancel_recurrence_confirmation'))) {this. model. set({repeats: false, repeat_interval: "never"});App. showLoader(App. t('saving'));$. ajax({
                url: "/api/v3.0/update_expense/" + this. model. get("id"),data: { repeats: false, repeat_interval: "never"
                },
                dataType: "json", type: "POST", success: function (data, status) {var
                  error = null; if
                  (status == "success") {if
                    (data["errors"] &&data["errors"].count > 0) {error = _. reduce( data["errors"],function (memo, kv) {memo + "\n" + k + " " + v
                      },
                      "");
                    }
                  }

                  if
                  (error || status != "success") {App. closeLoader({type: 'error'});alert(error
                      ? error
                      : status);
                  } else
                  { App. closeLoader({type: 'success', message: App. t('success')});
                  }
                }
              });
            }
          },

          deleteAndRemove: function (e) {e. stopPropagation();e. preventDefault();App. showLoader(App. t('deleting'));var
            _this = this; // JS patern for closure of outter `this`
            $. ajax({
              url: "/api/v3.0/delete_expense/" + this. model. get("id"),type: "POST", dataType: "json", success: function (data, status) {var
                errors = null; if
                (status == "success") {if
                  (data["errors"] &&_. size(data["errors"]) >0) {errors = _. reduce( data["errors"],function (memo, v, k) {return
                      memo + _. reduce( v, function (memo2, u) {return
                        memo2 + "\n- " + (k == "base"
                          ? ""
                          : $. capitalize(k) +" ") +u;
                      },
                      "");
                    },
                    App. t('these_errors_occurred'));
                  } else
                  { if
                    (App. currentRelationship) // optimistic balance updating
                      App. currentRelationship. adjustBalances("subtract", _this. model);

                    $(_this. el).slideUp( "normal", function () {if
                      (_this. model. get("creation_method") =="debt_consolidation" || _this. model. get("creation_method") =="debt_simplification") App. groups. fetch({url: "/api/v3.0/get_groups"});
                      $(this).remove();App. expenses. remove(_this. model);if
                      (App. currentRelationship && App. currentRelationship. id > 0) App. currentRelationship. fetch(); // Refresh balance data
                      }
                    ); if
                    (!App. currentRelationship || App. currentRelationship. id == 0) App. friends. fetch({url: "/api/v3.0/get_friends"});
                    }
                  }

                if
                (errors || status != "success") {App. closeLoader({type: 'error'});alert(errors
                    ? errors
                    : status);
                } else
                { App. closeLoader({type: 'success', message: App. t('success')});
                }
              }
            });return
            false;
          },

          deleteAndRemoveComment: function (e) {e. stopPropagation();e. preventDefault();App. showLoader(App. t('deleting'));var
            that = this; $. ajax({
              url: "/api/v3.0/delete_comment/" + $(e. currentTarget).data("id"),type: "POST", dataType: "json", success: function (data, status) {var
                error = null; if
                (status == "success") {if
                  (data["errors"] &&data["errors"].count > 0) {error = _. reduce( data["errors"],function (memo, kv) {memo + "\n" + k + " " + v
                    },
                    "");
                  }
                }

                if
                (error || status != "success") {App. closeLoader({type: 'error'});alert(error
                    ? error
                    : status);
                } else
                { App. closeLoader({type: 'success', message: App. t('success')});that. model. set({
                    comments_count: that. model. get("comments_count") -1
                  }, {silent: true});that. model. fetch({
                    url: "/api/v3.0/get_comments?expense_id=" + that. model. id
                  });
                }
              },
              error: function (status) {alert(App. t('general_unknown_error'));App. closeLoader({type: 'error'});
              }
            });return
            false;
          },

          remove: function () {$(this. el).slideUp( "normal", function () {$(this).remove();
            });
          },

          render: function () {try
            { var
              renderedContent = this. summaryTemplate(this. model. toJSON());
            } catch
            (err) {var
              renderedContent = "<div class='expense payment' style='padding: 10px 20px; background: #fee'><div style='color: #c00; font-weight: bold; font-size: 18px'>Render error!</div>" + _. escape(App. t('error_expense_render_ID', this. model. id)) +"</div>";
            }

            this. $('.summary').html(renderedContent);if
            (this. settled) $(this. el).addClass('settled');
            else
             $(this. el).removeClass('settled')

            if
            (App. currentExpenseId == this. model. id) {var
              that = this. el; $(that).addClass('current-expense');if
              (this. settled && ! App. settings. show_settled_bills) App. relationshipsRouter. relationshipDetailsView. toggleSettledBills();

              setTimeout( function() {$("html, body").animate({
                  scrollTop: $(that).offset().top - 60
                },
                250);
              },
              400);
            } else
             $(this. el).removeClass('current-expense');

            // Update the details view, if it is visible
            if
            (this. $('.users').is(":visible")) {this. $('.users').html(this. detailsTemplate(this. model. toJSON()));
            }

            return
            this;
          }
        });App. Views. ExpensesList = Backbone. View. extend({
          el: "#expenses_list",
          template: JST["backbone/templates/no-expenses"],
          month_divider_template: JST["backbone/templates/month-divider"],
          settle_point_template: JST["backbone/templates/settle-point"],
          collection: App. expenses, initialize: function (options) {this. _expenseViews = [];_. bindAll(this, 'render');App. expenses. bind('add', this. render, this);App. expenses. bind('remove', this. render, this);App. expenses. bind('reset', this. render, this);
          },

          _allBalancesAreZero: function (balances) {return
            _. all( balances, function (balanceDetails) {return
              _. all( balanceDetails, function (balanceDetail) {
                // For floating point errors anything lower than 1/10 of a cent is settled
                return
                Math. abs(balanceDetail. amount) <0.001;
              });
            });
          },

          render: function () {
            // Don't render if we just received expenses after a long delay and have swapped views
            if
            (!App. currentRelationship) {return
              this;
            }

            this. el = "#expenses_list"; // Refresh element, since it was rerendered
            var
            currentYear, currentMonth, expensesCount = 0, groupsCount = 0, expenses_and_groups = App. expenses. models, settle_up_point_reached = false, balances = App. currentRelationship. balances(),groupIdsWithBalances = [];$(this. el).empty();while
            (this. _expenseViews. length > 0) {this. _expenseViews. pop().close();
            }

            $(this. el).hide(); // Hide parent div so that we don't re-render a bunch of times while adding expenses one by one

            // Print expenses with month dividers where appropriate
            if
            (App. currentRelationship. isFriend()) {expenses_and_groups = App. expenses. models. concat(App. currentRelationship. sharedTabs()).sort( function(a, b) {
                // group_id present => var is group data, otherwise expense object
                var
                updated_at_a = a. group_id
                    ? new Date()
                    :Date. fromISO(a. get('date')),updated_at_b = b. group_id
                    ? new Date()
                    :Date. fromISO(b. get('date'));if
                (a. group_id && App. groups. get(a. group_id)) {updated_at_a = Date. fromISO(App. groups. get(a. group_id).get('updated_at'));
                }

                if
                (b. group_id && App. groups. get(b. group_id)) {updated_at_b = Date. fromISO(App. groups. get(b. group_id).get('updated_at'));
                }

                return
                updated_at_b - updated_at_a;
              });
            }

            _. each( App. currentRelationship. get('groups'),function (group) {var
              balanceNotAllZero = _. any( group. balance, function (balance) {return
                safe_parse_float(balance. amount) !==0
              }) if
              (balanceNotAllZero && group. group_id > 0) {groupIdsWithBalances. push(group. group_id);
              }
            }); var
            that = this; _. each( expenses_and_groups, function (expense_or_group) {
              // if appropriate, draw "all settled up" row and stop drawing expenses
              if
              (!settle_up_point_reached && App. currentRelationship && App. currentRelationship. id > 0 && that. _allBalancesAreZero(balances) &&_. isEmpty(groupIdsWithBalances)) {$(that. el).append(that. settle_point_template({
                  expensesCount: expensesCount + groupsCount
                }));settle_up_point_reached = true;

              } else
              if (expense_or_group. group_id) {
                // we're in a friendship rendering a group balance cell; let's handle this accordingly
                var
                groupBalance = App. groups. get(expense_or_group. group_id).balanceWith(App. currentRelationship. id);_. each( groupBalance, function (amount, currency_code) {
                  // find current balance for current currency code
                  var
                  p1 = _. find( balances[current_user],function (b) {return
                    b. currency_code == currency_code
                  }); var
                  p2 = _. find( balances[App. currentRelationship. id],function (b) {return
                    b. currency_code == currency_code
                  }); if
                  (!p1) {p1 = { currency_code: currency_code, amount: 0.0
                    };
                    balances[current_user].push(p1);
                  }

                  if
                  (!p2) {p2 = { currency_code: currency_code, amount: 0.0
                    };
                    balances[current_user].push(p2);
                  }

                  p1. amount -= parseFloat(amount);p2. amount += parseFloat(amount);
                }); groupIdsWithBalances = _. without(groupIdsWithBalances, expense_or_group. group_id);

              } else
              if (!expense_or_group. has("deleted_at")) {_. each( balances, function (balance, user_id) {
                  // find current balance for current currency code
                  var
                  p = _. find( balance, function (b) {return
                    b. currency_code == expense_or_group. get("currency_code")
                  }); if
                  (!p) {p = { currency_code: expense_or_group. get("currency_code"),amount: 0.0
                    };
                    balance. push(p);
                  }

                  if
                  (App. currentRelationship && App. currentRelationship. isGroup()) {p. amount -= expense_or_group. netBalance(user_id);

                  } else
                  { if
                    (user_id == current_user) {p. amount -= expense_or_group. netBalance();
                    } else
                    { p. amount += expense_or_group. netBalance();
                    }
                  }
                });
              }

              // otherwise, time to draw actual stuff
              if
              (expense_or_group. group_id) { // this is a group
                var
                view = new App. Views. ExpenseListGroupView({model: expense_or_group, settled: settle_up_point_reached});try
                { var
                  date = App. groups. get(expense_or_group. group_id).get("updated_at");
                } catch
                (e) { // unknown group; probably newly created since page refresh
                  var
                  date = new Date;
                }
                var
                newYear = Date. fromISO(date).getFullYear();var
                newMonth = Date. fromISO(date).getMonth() +1; groupsCount++; that. _expenseViews. push(view);
              } else
              if (App. currentRelationship && App. currentRelationship. id == -1 && expense_or_group. has("group_id") &&! App. groups. get(expense_or_group. get("group_id"))) {
                // we're on the 'all expenses' screen, and this is an expense from a group that we left
                // let's not render it
                return;
              } else
              if (!expense_or_group. has("deleted_at")) {var
                view = new App. Views. ExpenseView({model: expense_or_group, settled: settle_up_point_reached});var
                newYear = Date. fromISO(expense_or_group. get('date')).getFullYear();var
                newMonth = Date. fromISO(expense_or_group. get('date')).getMonth() +1; expensesCount++;
              }

              if
              (newYear != currentYear || newMonth != currentMonth) {currentYear = newYear; currentMonth = newMonth; $(that. el).append(that. month_divider_template({month: currentMonth, year: currentYear, settled: settle_up_point_reached}));
              }

              $(that. el).append(view. render().el);
            }); if
            (expensesCount == 0 && (!App. currentRelationship. isFriend() ||App. currentRelationship. sharedTabs().length == 0)) {$(that. el).append(that. template({settled: settle_up_point_reached}));
            }

            if
            (App. expenses. fullyLoaded || App. expenses. models. length == 0) {$('#load_more_expenses').hide();

            } else
            { if
              (settle_up_point_reached && ! App. settings. show_settled_bills) {$('#load_more_expenses').addClass('settled').hide();
              } else
              { $('#load_more_expenses').removeClass('settled').show();
              }
            }

            if
            (App. settings. show_settled_bills) {$(this. el).find('.settled').show();$(this. el).find('.settle-point').hide();
            }

            if
            (!App. settings. show_items_not_involving_me) {$(this. el).find('.expense.uninvolved').hide();
            }

            $(this. el).show();$(this. el).find('i[rel=tooltip]').tooltip({placement: 'top'});return
            this;
          },

          clear: function () {$(this. el).empty();
          }
        });App. Views. MainTrends = Backbone. View. extend({
          el: "#main_trends",
          template: JST["backbone/templates/main-trends"],

          initialize: function (options) {_. bindAll(this, 'render');App. expenses. bind('add', this. render, this);App. expenses. bind('change', this. render, this);App. expenses. bind('reset', this. render, this);
          },
          render: function () {$(this. el).html(this. template({
              data: App. expenses. thisMonthSummary(newDate())
            }));return
            this;
          }
        });App. Views. MonthlyChart = Backbone. View. extend({
          el: "#charts_modal",
          template: JST["backbone/templates/modals/charts-modal"],
          events: {
            'click h4 a': "changeMonth"
          },

          initialize: function (options) {_. bindAll(this, 'render');App. expenses. bind('add', this. render, this);App. expenses. bind('change', this. render, this);App. expenses. bind('reset', this. render, this);this. time = new Date;
          },
          render: function () {var
            renderedContent = this. template({time: this. time});$(this. el).html(renderedContent);if
            (this. chartsList) this. chartsList. close();
            this. chartsList = new App. Views. ChartsList({time: this. time});this. chartsList. render();return
            this;
          },

          changeMonth: function (event) {var
            newMonth = this. time. getMonth() +($(event. currentTarget).hasClass('previous')
              ?-1
              : 1);var
            newFullYear = this. time. getFullYear();if
            (newMonth > 11) {newFullYear += 1; newMonth -= 12;
            } else
            if (newMonth < 0) {newFullYear -= 1; newMonth += 12;
            }
            this. time = new Date(newFullYear, newMonth);this. render();return
            false;
          },

          onClose: function () {App. expenses. unbind('add', this. render);App. expenses. unbind('change', this. render);App. expenses. unbind('reset', this. render);
          }
        });App. Views. ChartsList = Backbone. View. extend({
          el: "#charts_modal tbody",
          template: JST["backbone/templates/charts-details"],
          collection: App. expenses,

          initialize: function (options) {_. bindAll(this, 'render');App. expenses. bind('add', this. render, this);App. expenses. bind('change', this. render, this);App. expenses. bind('reset', this. render, this);this. time = options. time;
          },

          render: function () {var
            that = this, categories = {},currencyCodeToShow = undefined, PAYMENT_CATEGORY_ID = 100; this. el = "#charts_modal tbody"; // Refresh element, since it was rerendered
            $(this. el).empty();_. each( App. expenses. thisMonth(this. time),function (expense) {if
              (!currencyCodeToShow) currencyCodeToShow = expense. get("currency_code");

              if
              (!expense. has("deleted_at") &&expense. get("currency_code") ==currencyCodeToShow) {var
                category = expense. isPayment()
                    ?{ id: PAYMENT_CATEGORY_ID
                    }
                    :
                    expense. get('category'),share = _. find( expense. get('users'),function (u) {return
                    parseInt(u['user_id']) ==current_user
                  }); if
                (share == undefined) share = { paid_share: 0.0, owed_share: 0.0
                  };

                if
                (isNaN(share. paid_share) ||share. paid_share == null) share. paid_share = 0.0;
                if
                (isNaN(share. owed_share) ||share. owed_share == null) share. owed_share = 0.0;

                if
                (categories[category. id] ==undefined) {categories[category. id] ={ name: category. id === PAYMENT_CATEGORY_ID
                      ? App. t('payments')
                      :App. categories. get(category. id).get('name'),total: parseFloat(expense. get("cost")),paid: parseFloat(share. paid_share),owed: parseFloat(share. owed_share)
                  }
                } else
                { categories[category. id].total += parseFloat(expense. get('cost'));categories[category. id].paid += parseFloat(share. paid_share);categories[category. id].owed += parseFloat(share. owed_share);
                }
              }
            }); if
            (!currencyCodeToShow) currencyCodeToShow = currentUserObject. default_currency;

            _. each( categories, function (value, key) {var
              categoryName = value["name"];if
              (categoryName == "Other") {categoryName = App. t('other') +" (" + App. categories. get(key).parentCategory().get("name") +")";
              }

              $(that. el).append("<tr><td>" + categoryName + "</td>\
                             <td class='total'>" + App. currencies. print(value["total"],currencyCodeToShow) +"</td>\
                             <td>" + App. currencies. print(value["paid"],currencyCodeToShow) +"</td>\
                             <td class='small'>-</td>\
                             <td>" + App. currencies. print(value["owed"],currencyCodeToShow) +"</td>\
                             <td class='small'>=</td>\
                             <td class='summary'>" + App. currencies. print((value["paid"] -value["owed"]),currencyCodeToShow) +"</td></tr>");
            }); var
            total = _. reduce( categories, function (memo, category) {return
              memo + category. total;
            },
            0); var
            paid = _. reduce( categories, function (memo, category) {return
              memo + category. paid;
            },
            0); var
            owed = _. reduce( categories, function (memo, category) {return
              memo + category. owed;
            },
            0); $(that. el).append("<tr class='block total'><td>" + _. escape(App. t('total')) +"</td>\
                       <td class='total'>" + App. currencies. print(total, currencyCodeToShow) +"</td>\
                       <td>" + App. currencies. print(paid, currencyCodeToShow) +"</td>\
                       <td class='small'>-</td>\
                       <td>" + App. currencies. print(owed, currencyCodeToShow) +"</td>\
                       <td class='small'>=</td>\
                       <td class='summary'><div>" + _. escape(App. t(paid - owed > 0
              ? 'you_are_owed__header'
              : 'you_owe__header')) +"</div>" + App. currencies. print(Math. abs(paid - owed),currencyCodeToShow) +"</td></tr>");

            // Get rid of payments
            delete
            categories[PAYMENT_CATEGORY_ID];fractions = _. map( categories, function (value, key) {return
              value. total / total * 100;
            }). join(",");labels = _. map( categories, function (value, key) {return
              value. name
            }). join("|").replace(" ", "+");totals = _. map( categories, function (value, key) {return
              App. currencies. print(value. total, currencyCodeToShow)
            }). join("|");if
            (totals == "") { // No money to show in chart
              $('#charts_modal img').hide();$('#charts_modal .no_spending').show();
            } else
            {
              // Replace Google charts image
              $('#charts_modal img').attr("src", "https://chart.googleapis.com/chart?chf=a,s,00000091|bg,s,FFFFFF&chxs=0,000000,11&chxt=x&chs=550x250&cht=p&chco=3072F3,80C65A,FF3131,FF9900,9C4F82&" + "chd=t:" + fractions + "&chdl=" + labels + "&chp=0.1&chl=" + totals + "&chma=0,140,0,5|75&chts=676767,11&chdls=000000,12").show();$('#charts_modal .no_spending').hide();
            }

            return
            this;
          },

          clear: function () {$(this. el).empty();
          },

          close: function () {App. expenses. unbind('add', this. render);App. expenses. unbind('change', this. render);App. expenses. unbind('reset', this. render);Backbone. View. prototype. close();
          }
        });App. Views. RecurringList = Backbone. View. extend({
          el: "#recurring_list",
          collection: App. expenses,
          events: {
            "click .bill a": "showBill"
          },

          initialize: function (options) {_. bindAll(this, 'render');App. expenses. bind('add', this. render, this);App. expenses. bind('change', this. render, this);App. expenses. bind('reset', this. render, this);
          },

          render: function () {this. el = "#recurring_list"; // Refresh element, since it was rerendered
            var
            that = this; $(this. el).empty();

            // Print recurring expenses in a sorted list of next recurrence
            var
            recurring = App. expenses. recurringExpenses();var
            recurringCount = 0; _. each( recurring, function (expense) {if
              (!expense. has("deleted_at")) {var
                view = new App. Views. RecurringView({model: expense});$(that. el).append(view. render().el);recurringCount++;
              }
            }); if
            (recurringCount == 0) {$(this. el).append(App. t('no_recurring_bills_added_html'));
            }

            return
            this;
          },

          clear: function () {$(this. el).empty();
          },

          showBill: function (e) {
            // TODO: this is incomplete
            $('#expense-' + $(e. currentTarget).data('id')).click();return
            false;
          }
        });App. Views. RecurringView = Backbone. View. extend({
          tagName: "tr",
          className: "recurring",
          template: JST["backbone/templates/recurring"],

          events: {
            "click a.delete": "render"
          },

          initialize: function (options) {_. bindAll(this, 'render');this. model. bind('change', this. render);this. model. bind('remove', this. remove);
          },

          render: function () {var
            renderedContent = this. template(this. model. toJSON());this. id = this. model. Id; $(this. el).attr({
              'id': "recurring-" + this. model. get("id"),
              'data-date': this. model. get("date")
            }).html(renderedContent);return
            this;
          }
        });App. Views. SettleUp = Backbone. View. extend({
          el: "#settle_up",
          events: {
            "click #simplified_handler": 'toggleAndSave'
          },

          initialize: function (options) {_. bindAll(this, 'render');
          },

          render: function () {if
            (App. currentRelationship && App. currentRelationship. get("relationship_type") =="group") {$("#settle_up").html(JST["backbone/templates/modals/repayments"](App. currentRelationship. toJSON()));this. toggleSimplified(App. currentRelationship. get("simplify_by_default"));this. $('*[rel=tooltip]').tooltip({placement: 'top'});

            } else
            { $("#settle_up").empty();
            }

            return
            this;
          },

          toggleAndSave: function (simplified) {this. toggleSimplified(simplified);this. saveSimplifiedSetting();
          },

          toggleSimplified: function (simplified) {var
            state = typeof(simplified) =="boolean"
              ? simplified
              : ! !(this. $(':checkbox').attr('checked'));if
            (!state) {this. $('.simplified_repayments').slideUp();this. $('.raw_repayments').slideDown();

            } else
            { if
              (typeof(simplified) =="boolean") // Bug: raw repayments won't disappear on group load
                this. $('.raw_repayments').hide();
              else
               this. $('.raw_repayments').slideUp();

              this. $('.simplified_repayments').slideDown();this. $('.simplify').fadeOut();
            }
          },

          saveSimplifiedSetting: function () {App. showLoader(App. t('saving'));$. ajax({
              url: "/api/v2.0/update_group_settings/" + App. currentRelationship. get("id"),data: { simplify_by_default: ! !(this. $(':checkbox').attr('checked'))
              },
              type: "POST", dataType: "json", success: function (data, status) {var
                errors; if
                (status == "success" && data['errors'] &&data['errors'].length > 0) {errors = App. t("general_unknown_error");
                }

                if
                (errors || status != "success") {App. closeLoader({type: 'error'});alert(errors
                    ? errors
                    : status);

                } else
                { App. closeLoader({type: 'success', message: App. t('settings_updated_successfully')});App. currentRelationship. set( "simplify_by_default", data["group"]["simplify_by_default"]);
                }
              }
            });
          },

          close: function () {$(this. el).undelegate('#simplified_handler', 'click');
          }
        });App. Views. GroupMemberDetails = Backbone. View. extend({
          el: "#group_member_details",
          events: {
            "click .input-data": 'setMember',
            'click .resend_invite': 'resendInvite'
          },

          initialize: function (options) {_. bindAll(this, 'render');App. groups. bind('reset', this. render, this);App. groups. bind('change', this. render, this);App. friends. bind('reset', this. render, this);App. friends. bind('change', this. render, this);
          },

          render: function () {$(this. el).html(JST["backbone/templates/modals/group-member-details"]({member: this. member, group: this. group}));return
            this;
          },

          setMember: function () {var
            id = this. $(".input-data").data("id");var
            member; if
            (id == current_user) member = new App. Models. User(currentUserObject);
            else
             member = App. friends. get(id);

            // If we didn't find the member for some reason, fall back on the group's record of that user
            if
            (!member) member = App. currentRelationship. getUser(id);
            this. member = member; var
            groupId = this. $(".input-data").data("group-id");this. group = App. groups. get(groupId);this. render();
          },

          resendInvite: function () {var
            that = this; this. $('.resend_invite').attr('disabled', true).text(App. t('sending'));App. showLoader(App. t('sending'));$. ajax({
              url: "/api/v3.0/resend_invite/" + this. member. id, data: {},type: "POST", dataType: "json", success: function (data, status) {if
                (status == "success" && data["success"] ==true) {App. closeLoader({type: 'success', message: App. t('invite_resent')});that. $('.resend_invite').attr('disabled', true).text(App. t('invite_resent'));
                } else
                { alert(App. t('general_unknown_error'));App. closeLoader({type: 'error'});that. $('.resend_invite').attr('disabled', false).text(App. t('resend_invite'));
                }
              },
              error: function (data, status) {alert(App. t('general_unknown_error'));App. closeLoader({type: 'error'});that. $('.resend_invite').attr('disabled', false).text(App. t('resend_invite'));
              }
            });
          },

          close: function () {
            // Make sure .input-data doesn't fire multiple times after switching between
            // different relationship views
            this. undelegateEvents()
          }
        });App. Views. SendReminderForm = Backbone. View. extend({
          el: "#send_reminder",
          events: {
            'click .input-data': 'updateDefault',
            'click .dropdown-menu a': 'updateForm',
            'click #reminder_submit': 'sendReminder',
            'keypress input[type=text]': 'sendReminderOnEnter'
          },

          initialize: function (options) {_. bindAll(this, 'render');this. updateForm();
          },

          render: function () {if
            (App. currentRelationship) {$(this. el).html(JST["backbone/templates/modals/send-reminder"](App. currentRelationship. toJSON()));
            } else
            { $(this. el).empty();
            }

            return
            this;
          },

          updateDefault: function (e) {var
            data = this. $('.input-data').data();if
            (data. to) $('#select-group-reminder_user_id a[data-value=' + data. to + ']').click();
            }
          ,

          updateForm: function (e) {if
            (App. currentRelationship) {var
              reminderUser = App. currentRelationship. getUser($('#reminder_user_id').val());this. updateBalance(reminderUser);this. updateSend(reminderUser);
            }
          },

          updateBalance: function (reminderUser) {try
            { var
              balance = parseFloat( reminderUser. get("balance")[0].amount), currency = reminderUser. get("balance")[0].currency_code;
            } catch
            (e) {var
              balance = 0.0;
            }

            if
            (balance < 0) $('#reminder_summary').text(App. t('NAME_currently_owes_AMOUNT', reminderUser. firstNameLastInitial(),App. currencies. print(-balance, currency)));
            else
            if (balance > 0) $('#reminder_summary').text(App. t('NAME_is_currently_owed_AMOUNT', reminderUser. firstNameLastInitial(),App. currencies. print(balance, currency)));
            else
             $('#reminder_summary').text(App. t('NAME_currently_owes_nothing', reminderUser. firstNameLastInitial()));
            }
          ,

          updateSend: function (reminderUser) {var
            friend = App. friends. get(reminderUser. id),disabled = friend
                ? friend. noEmail()
                :false; this. $('#reminder_submit').attr('disabled', disabled);
          },

          sendReminderOnEnter: function (e) {if
            (e. keyCode != 13) return;
            this. sendReminder(e);
          },
          sendReminder: function (e) {var
            hash = {},userId = this. $('#reminder_user_id').val(),friend = App. friends. get(parseInt(userId));if
            (friend && friend. noEmail()) return;

            if
            (App. currentRelationship. get("relationship_type") =="group") {hash["group_id"] =App. currentRelationship. get("id");
            }
            hash["user_id"] =userId; hash["reminder_note"] =this. $('textarea').val();App. showLoader(App. t('sending'));$. ajax({
              url: "/api/v2.0/send_reminder",
              data: hash,
              dataType: 'json',
              type: "POST",
              success: function (data, status) {var
                errors = null; if
                (status == "success" && _. size(data["errors"]) >0) {errors = _. reduce( data["errors"],function (memo, v, k) {return
                    memo + _. reduce( v, function (memo2, u) {return
                      memo2 + "\n- " + (k == "base"
                        ? ""
                        : $. capitalize(k) +" ") +u;
                    },
                    "");
                  },
                  App. t('these_errors_occurred'));
                }

                if
                (errors || status != "success") {App. closeLoader({type: 'error'});alert(errors
                    ? errors
                    : status);
                } else
                { $('#send_reminder').modal('hide');App. closeLoader({type: 'success', message: App. t('reminder_sent')});
                }
              },
              error: function (status) {alert(App. t('general_unknown_error'));App. closeLoader({type: 'error'});
              }
            });return
            false;
          }
        });App. Views. SimplifyDebtsModal = Backbone. View. extend({
          el: "#simplify_debts",
          events: {
            'click #simplify_debts_submit': 'simplifyDebts'
          },

          initialize: function (options) {_. bindAll(this, 'render');
          },

          render: function () {if
            (App. currentRelationship) {template = JST["backbone/templates/modals/simplify-debts"](App. currentRelationship. toJSON());$(this. el).html(template);return
              this;
            } else
            { $(this. el).empty();return
              this;
            }
          },

          simplifyDebts: function (e) {if
            (App. currentRelationship. isFriend()) {App. showLoader(App. t('saving'));$. ajax({
                url: "/api/v2.1/consolidate_debts/" + App. currentRelationship. id, dataType: 'json', type: "POST", success: function (data, status) {var
                  errors = null; if
                  (status == "success") {if
                    (data["errors"] &&_. size(data["errors"]) >0) {errors = _. reduce( data["errors"],function (memo, v, k) {return
                        memo + _. reduce( v, function (memo2, u) {return
                          memo2 + "\n- " + (k == "base"
                            ? ""
                            : $. capitalize(k) +" ") +u;
                        },
                        "");
                      },
                      App. t('these_errors_occurred'));
                    }
                  }

                  if
                  (errors || status != "success") {App. closeLoader({type: 'error'});alert(errors
                      ? errors
                      : status);
                  } else
                  { $('#simplify_debts').modal('hide');App. groups. fetch({url: "/api/v3.0/get_groups"});App. currentRelationship. fetch();App. expenses. fetch({
                      data: { friend_id: App. currentRelationship. get("id"),limit: 25, group_id: 0
                      }
                    });App. closeLoader({type: 'success', message: App. t('success')});
                  }
                },
                error: function (status) {alert(App. t('general_unknown_error'));App. closeLoader({type: 'error'});
                }
              });
            }

            return
            false;
          }
        });

      }); // document.ready

      $(document).ready( function() {App. Routers. Relationships = Backbone. Router. extend({
          routes: {
            "/all": "all",
            "/all/": "all",
            "/all/expenses/:expense_id": "all",
            "/groups": "group",
            "/groups/:id": "group",
            "/groups/:id/": "group",
            "/groups/:id/:mode/:expense_id": "group",
            "/expenses/:id": "expense",
            "/friends": "friend",
            "/friends/": "friend",
            "/friends/:id": "friend",
            "/friends/:id/": "friend",
            "/dashboard": "dashboard",
            "/dashboard/": "dashboard",
            "/activity": "activity",
            "/activity/admin": "activity",
            "/admin/activity": "activity",
            "/external_accounts": "external_accounts",
            "/external_accounts/": "external_accounts",
            "_=_": "facebook_login"
          },

          initialize: function () {App. expenses = this. expenses = new App. Collections. Expenses();this. balancesSidebar = new App. Views. BalancesSidebar();this. relationshipDetailsView = new App. Views. RelationshipDetails();this. inviteFriends = new App. Views. InviteFriends();
          },

          activity: function (id) {App. dashboard = false; App. notifications_view = true; App. external_accounts_view = false; this. relationshipDetailsView. setRelationship(null);$('#left_sidebar a').removeClass('open');$('#view_links a[href="#/activity"]').addClass('open');this. scrollToTop();if
            (App. notifications. size() <10) App. notifications. loadMore();
            else
             App. notifications. fetch({upsert: true});
            }
          ,

          dashboard: function (id) {App. dashboard = true; App. notifications_view = false; App. external_accounts_view = false; this. relationshipDetailsView. setRelationship(null);$('#left_sidebar a').removeClass('open');$('#view_links a[href="#/dashboard"]').addClass('open');this. scrollToTop();
          },

          external_accounts: function (id) {App. external_accounts_view = true; App. dashboard = false; App. notifications_view = false; this. relationshipDetailsView. setRelationship(null);$('#left_sidebar a').removeClass('open');$('#view_links a[href="#/external_accounts"]').addClass('open');this. scrollToTop();
          },

          all: function (expense_id) {this. relationship("all", 0, null, expense_id);
          },

          facebook_login: function (expense_id) {App. relationshipsRouter. navigate("#/dashboard", true);
          },

          expense: function (id, mode, expense_id) {var
            that = this; var
            jqxhr = $. getJSON( "/api/v3.0/get_expense/" + id, function (d) {if
              (d && d. expense && d. expense. group_id) App. relationshipsRouter. navigate("#/groups/" + d. expense. group_id, true);
              else
               App. relationshipsRouter. navigate("#/all", true);
              }
            ). fail( function() {alert("It looks like you don't have permission to view this expense! This could be because you have been removed from the expense, or from the group that the expense was in. Sorry!");
            });
          },

          group: function (id, mode, expense_id) {if
            (id == undefined && App. groups. first()) id = App. groups. first().get('id');

            this. relationship("group", id, mode, expense_id);
          },

          friend: function (id, mode, expense_id) {if
            (id == undefined && App. friends. first()) id = App. friends. first().get('id');

            this. relationship("friend", id, mode, expense_id);
          },

          relationship: function (relationship_type, id, mode, expense_id) {$('#left_sidebar a').removeClass('open');if
            (relationship_type == "all") $('#view_links a[href="#/all"]').addClass('open');
            else
             $('#view_links a[href="#/' + relationship_type + 's/' + id + '"]').addClass('open');

            // Highlight a specific expense if appropriate
            if
            (expense_id) {this. relationshipDetailsView. setActiveExpenseId(parseInt(expense_id));console. log("find that expenseeeee: " + expense_id);
            } else
            { App. currentExpenseId = null;
            }

            if
            (App. currentRelationship && App. currentRelationship. get('relationship_type') ==relationship_type && App. currentRelationship. get('id') ==id) {
              // Already active; don't switch
            } else{ App. dashboard = false; App. notifications_view = false; App. external_accounts_view = false; App. settings. show_settled_bills = false; App. settings. show_items_not_involving_me = true; if
              (relationship_type == "all") this. relationshipDetailsView. setRelationship(newApp. Models. Group({id: -1, name: App. t("all_expenses"),members: []}));
              else
              if (id == null) // No relationships of this type yet
                this. relationshipDetailsView. setRelationship(null);
              else
              if (relationship_type == "group") this. relationshipDetailsView. setRelationship(App. groups. get(id));
              else
               this. relationshipDetailsView. setRelationship(App. friends. get(id));

              this. scrollToTop();
            }
          },

          scrollToTop: function () {if
            ($(window).scrollTop() >0) $("html, body").animate({
                scrollTop: 0
              },
              250);
            }
          });

      }); // document.ready
      var
      App = App || {};(
      function() {var
        TRANSLATIONS = {
            "date": {
              "formats": {
                "default": "%Y-%m-%d",
                "short": "%b %d",
                "long": "%B %d, %Y",
                "input": "%m\/%d\/%Y",
                "table": "%m\/%d"
              },
              "day_names": [
                "Sunday",
                "Monday",
                "Tuesday",
                "Wednesday",
                "Thursday",
                "Friday",
                "Saturday"
              ],
              "abbr_day_names": [
                "Sun",
                "Mon",
                "Tue",
                "Wed",
                "Thu",
                "Fri",
                "Sat"
              ],
              "month_names": [
                null,
                "January",
                "February",
                "March",
                "April",
                "May",
                "June",
                "July",
                "August",
                "September",
                "October",
                "November",
                "December"
              ],
              "abbr_month_names": [
                null,
                "Jan",
                "Feb",
                "Mar",
                "Apr",
                "May",
                "Jun",
                "Jul",
                "Aug",
                "Sep",
                "Oct",
                "Nov",
                "Dec"
              ],
              "order": ["year", "month", "day"]
            },
            "time": {
              "formats": {
                "default": "%a, %d %b %Y %H:%M:%S %z",
                "short": "%d %b %H:%M",
                "long": "%B %d, %Y %H:%M",
                "input": "%m\/%d\/%Y",
                "table": "%m\/%d"
              },
              "am": "am",
              "pm": "pm"
            },
            "support": {
              "array": {
                "words_connector": ", ",
                "two_words_connector": " and ",
                "last_word_connector": ", and "
              }
            },
            "errors": {
              "format": "%{attribute} %{message}",
              "messages": {
                "inclusion": "is not included in the list",
                "exclusion": "is reserved",
                "invalid": "is invalid",
                "confirmation": "doesn't match confirmation",
                "accepted": "must be accepted",
                "empty": "can't be empty",
                "blank": "can't be blank",
                "too_long": {
                  "one": "is too long (maximum is 1 character)",
                  "other": "is too long (maximum is %{count} characters)"
                },
                "too_short": {
                  "one": "is too short (minimum is 1 character)",
                  "other": "is too short (minimum is %{count} characters)"
                },
                "wrong_length": {
                  "one": "is the wrong length (should be 1 character)",
                  "other": "is the wrong length (should be %{count} characters)"
                },
                "not_a_number": "is not a number",
                "not_an_integer": "must be an integer",
                "greater_than": "must be greater than %{count}",
                "greater_than_or_equal_to": "must be greater than or equal to %{count}",
                "equal_to": "must be equal to %{count}",
                "less_than": "must be less than %{count}",
                "less_than_or_equal_to": "must be less than or equal to %{count}",
                "odd": "must be odd",
                "even": "must be even",
                "record_invalid": "Validation failed: %{errors}",
                "taken": "has already been taken",
                "carrierwave_processing_error": "failed to be processed",
                "carrierwave_integrity_error": "is not of an allowed file type",
                "carrierwave_download_error": "could not be downloaded",
                "extension_white_list_error": "You are not allowed to upload %{extension} files. Allowed file types include %{allowed_types}.",
                "extension_black_list_error": "You are not allowed to upload %{extension} files. Prohibited types include %{prohibited_types}.",
                "rmagick_processing_error": "Failed to manipulate with rmagick, maybe it is not an image?",
                "mime_types_processing_error": "Failed to process file with MIME::Types, maybe not valid content-type?",
                "mini_magick_processing_error": "could not be processed correctly. Please make sure you are uploading a valid file format (png, jpg, etc.)"
              },
              "template": {
                "body": "There were problems with the following fields:",
                "header": {
                  "one": "1 error prohibited this %{model} from being saved",
                  "other": "%{count} errors prohibited this %{model} from being saved"
                }
              }
            },
            "activerecord": {
              "errors": {
                "messages": {
                  "taken": "has already been taken",
                  "record_invalid": "Validation failed: %{errors}",
                  "accepted": "must be accepted",
                  "blank": "can't be blank",
                  "confirmation": "doesn't match confirmation",
                  "empty": "can't be empty",
                  "equal_to": "must be equal to %{count}",
                  "even": "must be even",
                  "exclusion": "is reserved",
                  "greater_than": "must be greater than %{count}",
                  "greater_than_or_equal_to": "must be greater than or equal to %{count}",
                  "inclusion": "is not included in the list",
                  "invalid": "is invalid",
                  "less_than": "must be less than %{count}",
                  "less_than_or_equal_to": "must be less than or equal to %{count}",
                  "not_a_number": "is not a number",
                  "not_an_integer": "must be an integer",
                  "odd": "must be odd",
                  "too_long": {
                    "one": "is too long (maximum is 1 character)",
                    "other": "is too long (maximum is %{count} characters)"
                  },
                  "too_short": {
                    "one": "is too short (minimum is 1 character)",
                    "other": "is too short (minimum is %{count} characters)"
                  },
                  "wrong_length": {
                    "one": "is the wrong length (should be 1 character)",
                    "other": "is the wrong length (should be %{count} characters)"
                  }
                },
                "format": "%{attribute} %{message}",
                "template": {
                  "body": "There were problems with the following fields:",
                  "header": {
                    "one": "1 error prohibited this %{model} from being saved",
                    "other": "%{count} errors prohibited this %{model} from being saved"
                  }
                },
                "models": {
                  "user": {
                    "attributes": {
                      "email": {
                        "taken": "has already been taken"
                      }
                    }
                  }
                }
              }
            },
            "number": {
              "format": {
                "separator": ".",
                "delimiter": ",",
                "precision": 2,
                "significant": false,
                "strip_insignificant_zeros": false
              },
              "currency": {
                "format": {
                  "format": "%u%n",
                  "unit": "$",
                  "separator": ".",
                  "delimiter": ",",
                  "precision": 2,
                  "significant": false,
                  "strip_insignificant_zeros": false
                }
              },
              "percentage": {
                "format": {
                  "delimiter": ""
                }
              },
              "precision": {
                "format": {
                  "delimiter": ""
                }
              },
              "human": {
                "format": {
                  "delimiter": "",
                  "precision": 3,
                  "significant": true,
                  "strip_insignificant_zeros": true
                },
                "storage_units": {
                  "format": "%n %u",
                  "units": {
                    "byte": {
                      "one": "Byte",
                      "other": "Bytes"
                    },
                    "kb": "KB",
                    "mb": "MB",
                    "gb": "GB",
                    "tb": "TB"
                  }
                },
                "decimal_units": {
                  "format": "%n %u",
                  "units": {
                    "unit": "",
                    "thousand": "Thousand",
                    "million": "Million",
                    "billion": "Billion",
                    "trillion": "Trillion",
                    "quadrillion": "Quadrillion"
                  }
                }
              }
            },
            "datetime": {
              "distance_in_words": {
                "half_a_minute": "half a minute",
                "less_than_x_seconds": {
                  "one": "less than 1 second",
                  "other": "less than %{count} seconds"
                },
                "x_seconds": {
                  "one": "1 second",
                  "other": "%{count} seconds"
                },
                "less_than_x_minutes": {
                  "one": "less than a minute",
                  "other": "less than %{count} minutes"
                },
                "x_minutes": {
                  "one": "1 minute",
                  "other": "%{count} minutes"
                },
                "about_x_hours": {
                  "one": "about 1 hour",
                  "other": "about %{count} hours"
                },
                "x_days": {
                  "one": "1 day",
                  "other": "%{count} days"
                },
                "about_x_months": {
                  "one": "about 1 month",
                  "other": "about %{count} months"
                },
                "x_months": {
                  "one": "1 month",
                  "other": "%{count} months"
                },
                "about_x_years": {
                  "one": "about 1 year",
                  "other": "about %{count} years"
                },
                "over_x_years": {
                  "one": "over 1 year",
                  "other": "over %{count} years"
                },
                "almost_x_years": {
                  "one": "almost 1 year",
                  "other": "almost %{count} years"
                }
              },
              "prompts": {
                "year": "Year",
                "month": "Month",
                "day": "Day",
                "hour": "Hour",
                "minute": "Minute",
                "second": "Seconds"
              }
            },
            "helpers": {
              "select": {
                "prompt": "Please select"
              },
              "submit": {
                "create": "Create %{model}",
                "update": "Update %{model}",
                "submit": "Save %{model}"
              },
              "button": {
                "create": "Create %{model}",
                "update": "Update %{model}",
                "submit": "Save %{model}"
              }
            },
            "activemodel": {
              "errors": {
                "format": "%{attribute} %{message}",
                "messages": {
                  "accepted": "must be accepted",
                  "blank": "can't be blank",
                  "confirmation": "doesn't match confirmation",
                  "empty": "can't be empty",
                  "equal_to": "must be equal to %{count}",
                  "even": "must be even",
                  "exclusion": "is reserved",
                  "greater_than": "must be greater than %{count}",
                  "greater_than_or_equal_to": "must be greater than or equal to %{count}",
                  "inclusion": "is not included in the list",
                  "invalid": "is invalid",
                  "less_than": "must be less than %{count}",
                  "less_than_or_equal_to": "must be less than or equal to %{count}",
                  "not_a_number": "is not a number",
                  "not_an_integer": "must be an integer",
                  "odd": "must be odd",
                  "record_invalid": "Validation failed: %{errors}",
                  "taken": "has already been taken",
                  "too_long": {
                    "one": "is too long (maximum is 1 character)",
                    "other": "is too long (maximum is %{count} characters)"
                  },
                  "too_short": {
                    "one": "is too short (minimum is 1 character)",
                    "other": "is too short (minimum is %{count} characters)"
                  },
                  "wrong_length": {
                    "one": "is the wrong length (should be 1 character)",
                    "other": "is the wrong length (should be %{count} characters)"
                  }
                },
                "template": {
                  "body": "There were problems with the following fields:",
                  "header": {
                    "one": "1 error prohibited this %{model} from being saved",
                    "other": "%{count} errors prohibited this %{model} from being saved"
                  }
                }
              }
            },
            "i18n": {
              "plural": {
                "keys": [
                  "one", "other"
                ],
                "rule": {}
              }
            },
            "_native_language": "English",
            "passcode_failed_once": "1 passcode failed attempt",
            "about_simplified_debts": "About simplified debts",
            "account_settings": "Account settings",
            "activity": "Activity",
            "add": "Add",
            "add_a_bill": "Add a bill",
            "add_expenses": "Add expenses",
            "add_image_or_notes": "Add image\/notes",
            "add_a_comment": "Add a comment",
            "add_a_group_trip": "Add a group trip",
            "add_a_person": "Add a person",
            "add_friends_on_splitwise": "Add friends on Splitwise",
            "add_group_member": "Add group member",
            "add_members": "Add members",
            "add_more_friends": "Add more friends",
            "add_notes": "Add notes",
            "add_your_apartment": "Add your apartment",
            "added_by_PERSON_on_DATE": "Added by %1$@ on %2$@",
            "added_by_you_on_DATE": "Added by you on %@",
            "adding": "Adding",
            "advanced_settings": "Advanced settings",
            "advanced_features": "Advanced features",
            "advanced_features_tagline": "Most users don\u2019t need these features \u2013 but here they are in case you do!",
            "all": "all",
            "all_expenses": "All expenses",
            "all_of_GROUP": "All of %@",
            "all_time": "All time",
            "AMOUNT_left": "%@ left",
            "AMOUNT_per_person": "%@\/person",
            "an_unexpected_NUMBER_server_error_occured": "An unexpected %@ server error occurred. Please try again or contact us if you have repeated issues. Sorry for the inconvenience!",
            "an_unknown_error_occured": "An unknown error occurred.",
            "an_unknown_quickadd_problem_occured": "An unknown problem occurred. Splitwise may not have been able to understand your message.",
            "and": "and",
            "and_split": "and split",
            "apartment": "Apartment",
            "are_you_absolutely_sure_you_want_to_delete_this_group": "Are you ABSOLUTELY sure you want to delete this group? This will remove this group for ALL users involved, not just yourself.",
            "are_you_sure_you_want_to_delete_this_expense": "Are you sure you want to delete this expense? This will remove this expense for ALL people involved, not just you.",
            "are_you_sure_you_want_to_delete_this_friend": "Are you sure you want to delete this friend? This will remove all of your past expenses with this person.",
            "are_you_sure_you_want_to_delete_this_payment": "Are you sure you want to delete this payment?",
            "are_you_sure_you_want_to_log_out": "Are you sure you want to log out?",
            "are_you_sure_you_want_to_remove_this_person_from_this_group": "Are you sure you want to remove this person from this group?",
            "are_you_sure_you_want_to_undelete_this_expense": "Are you sure you want to undelete this expense?",
            "are_you_sure_you_want_to_undelete_this_payment": "Are you sure you want to undelete this payment?",
            "back": "Back",
            "balances": "Balances",
            "before_you_use_quick_add_please_select_a_group_by_hitting_the_gray_button": "Before you use quick-add, please select a group by hitting the gray button.",
            "cancel": "Cancel",
            "category": "Category",
            "change": "Change",
            "change_passcode": "Change passcode",
            "checkmark_expense_saved": "\u2713 Expense saved!",
            "choose_payer": "Choose payer",
            "choose_a_person": "Choose a person",
            "choose_a_recipient": "Choose a recipient",
            "choose_a_payment_method": "Choose a payment method",
            "each_person_paid_own_share": "Each person paid for their own share",
            "each_person_gets_back": "Each person gets back",
            "choose_date": "Choose date",
            "choose_from_library": "Choose from Library",
            "choose_group": "Choose group",
            "choose_split_options": "Choose split options",
            "close": "Close",
            "comments": "Comments",
            "confirmation": "Confirmation",
            "confirmation_pending": "Confirmation pending",
            "confirm_convert_group_to_CURRENCY": "This will convert all transactions in this group to %@ (your default currency) at the current international exchange rate. This action cannot be reversed. Are you sure you wish to continue?",
            "convert_all_bills_to_CURRENCY": "Convert all bills to %@",
            "set_all_bills_to_CURRENCY": "Set all bills to %@",
            "set_all_bills_to_CURRENCY_warning": "WARNING: this is not reversible. This feature DOES NOT convert currencies, it fixes accounts that are accidentally using more than one currency. If you are intentionally using multiple currencies DO NOT do this.\n\nWould you like to change the currency code of ALL expenses with ALL of your groups and friends to %@?",
            "contact_us": "Contact us",
            "create_a_group": "Create a group",
            "currency": "Currency",
            "i_currently_owe_you_BALANCE": "I currently owe you %@.",
            "default_currency": "Default currency",
            "delete_expense": "Delete expense",
            "delete_friend": "Delete friend",
            "delete_group": "Delete group",
            "delete_payment": "Delete payment",
            "deleted": "Deleted",
            "deleting": "Deleting",
            "details": "Details",
            "do_this_later": "I'll do this later",
            "done": "Done",
            "edit_bill": "Edit bill",
            "edit_payment": "Edit payment",
            "email_address": "Email address",
            "enter_a_description": "Enter a description",
            "enter_a_description__short": "Enter a description",
            "enter_a_group_name": "Enter a group name",
            "enter_a_name_for_this_person": "Enter a name for this person",
            "we_will_send_them_a_link_via_sms": "We'll send them a link via SMS",
            "we_will_send_them_a_link": "We'll send them a link",
            "enter_a_phone_number": "Enter a phone number",
            "enter_a_reason_for_this_payment": "Enter a reason for this payment",
            "enter_an_email_address": "Enter an email address",
            "enter_an_email_address_or_phone_number_for_this_person": "Enter an email address or phone number for this person",
            "enter_name_email_or_phone": "Enter name, email, or phone #",
            "enter_names_emails_or_phone_numbers": "Enter names, emails, or phone #s",
            "enter_paid_amounts": "Enter paid amounts",
            "equally": "Equally",
            "money_received_by": "Money received by",
            "error": "Error",
            "error_MESSAGE": "Error: %@",
            "example_electric_bill": "Example: Electric bill $80",
            "expense_details": "Expense details",
            "expense_added": "Expense added",
            "export_as_spreadsheet": "Export as spreadsheet",
            "failed_to_sync": "Failed to sync",
            "N_days_early": "%@ days early",
            "for_bills_on_splitwise": "For bills on splitwise.com",
            "for_debts_in_GROUP": "For debts in %@",
            "forgot_your_password": "Forgot your password?",
            "fortnightly": "Fortnightly",
            "friend_settings": "Friend settings",
            "friends": "Friends",
            "from_your_contacts": "From your contacts",
            "full_name": "Full name",
            "generating_spreadsheet": "Generating spreadsheet",
            "gets_back": "gets back",
            "go_to_a_specific_friend_or_group_first": "Go to a specific friend or group first, then long-press the plus button.",
            "go_to_paypal": "Go to PayPal.com?",
            "groceries_20_dollars": "Groceries $20",
            "group_settings": "Group settings",
            "group_balances": "Group balances",
            "group_members": "Group members",
            "groups": "Groups",
            "groups_make_it_easy_to_split_apartment_bills": "Groups make it easy to split apartment bills, share travel expenses, and more.",
            "hey_friends_join_my_GROUP_on_splitwise_LINK__sms": "Hey friends! Join my group '%1$@' on Splitwise: %2$@",
            "home_house": "Home",
            "home_page": "Home",
            "house": "House",
            "how_was_this_bill_split": "How was this bill split?",
            "i_use_CODE_SYMBOL_as_my_currency": "I use %1$@ (%2$@) as my currency.",
            "image_uploaded": "Image uploaded!",
            "invalid_api_request": "Invalid API Request. If this seems weird, or persists, sorry! You can shoot us an email at app@splitwise.com and we\u2019ll see if we can fix the bug.",
            "invalid_phone_alert": "You did not enter a valid phone number. Please try again.",
            "invalid_email_alert": "Please enter a valid email address.",
            "invalid_email_or_phone_alert": "You did not enter a valid email address or phone number. Please try again.",
            "invalid_value_try_again": "Invalid value \u2013 please try again.",
            "invite": "Invite",
            "invite_a_friend_to_splitwise": "Invite a friend to Splitwise",
            "invite_pending": "Invite pending",
            "invite_PERSON_to_splitwise": "Invite %@ to Splitwise",
            "just_this_once": "Just this once",
            "kittens": "Kittens!",
            "last_month": "Last month",
            "last_updated_on_DATE__legacy": "Last updated on %@",
            "last_updated_by_you_on_DATE": "Last updated by you on %@",
            "last_updated_by_PERSON_on_DATE": "Last updated by %1$@ on %2$@",
            "lets_get_started": "Let's get started",
            "lets_get_you_set_up_NAME": "Let\u2019s get you set up, %@",
            "lets_settle_up_the_next_time_we_see_each_other": "Let's settle up the next time we see each other.",
            "already_have_an_account": "Already have a Splitwise account?",
            "would_you_like_to_merge_ACCOUNT_into_ACCOUNT_html": "This invite is for %1$@, but you\u2019re already signed in as %2$@.\n\nWould you like to merge accounts and accept this invite as %2$@?",
            "yes_merge_accounts": "Yes, merge the accounts",
            "no_do_not_merge_accounts": "No, treat them separately",
            "loading": "Loading",
            "log_in": "Log in",
            "log_in_to_splitwise": "Log in to Splitwise",
            "log_in_with_facebook": "Log in with Facebook",
            "log_out": "Log out",
            "logged_in_as__header": "Logged in as",
            "logged_out": "logged out",
            "logging_in": "Logging in",
            "made_with_smiles_in_YEAR_KITTENS": "Made with :) in Providence, RI, USA\nCopyright \u00a9 %1$@ Splitwise, Inc.\nP.S. %2$@",
            "made_with_smiles_KITTENS": "Made with :) in Providence, RI, USA\nCopyright \u00a9 2015 Splitwise, Inc.\nP.S. %@",
            "monthly": "Monthly",
            "more": "More",
            "more_options": "More options",
            "multiple_people": "Multiple people",
            "next": "Next",
            "next_payment_due_DATE": "Next payment due %@",
            "non_group_expenses__short": "No group",
            "no_balance__cell": "no balance",
            "no_email_address": "No email address",
            "no_expenses__cell": "no expenses",
            "no_expenses__friend": "no expenses",
            "no_expenses__group": "no expenses",
            "no_reminder": "No reminder",
            "non_group_expenses": "Non-group expenses",
            "none_of_the_people_on_this_expense_are_in_GROUP": "None of the people on this expense are in the group '%@'. Please choose a different group.",
            "not_able_to_access_this_group": "You're not able to access this group. You may have been removed from the group or it may have been deleted.",
            "not_in_a_group": "Not in a group",
            "not_involved__cell": "not involved",
            "note_paypal_payments_via_debit_or_credit_card_incur_fees": "Note: PayPal payments via debit or credit card incur fees of up to 4%. Venmo payments via credit card incur fees of 3%. Visit PayPal.com or Venmo.com for details.",
            "notes": "Notes",
            "notification_settings": "Notification settings",
            "passcode_failed_N_times": "%@ passcode failed attempts",
            "N_people": "%@ people",
            "N_people_paid_AMOUNT": "%1$@ people paid %2$@",
            "N_people_who_owe_you_AMOUNT": "%1$@ people owe you %2$@",
            "ok": "OK",
            "on_splitwise_you_can_add_expenses_that_dont_belong_to_any_group": "On Splitwise, you can add expenses that don't belong to any group \u2013 for example, lunch with a friend.\n\nYou can view all these expenses from the \u2018Non-group expenses\u2019 section of the Groups tab.",
            "on_the_day_of": "On the day of",
            "one_day_early": "1 day early",
            "one_week_early": "1 week early",
            "oops": "Oops",
            "oops_looks_like_youre_logged_out_of_splitwise": "Oops! Looks like you're logged out of Splitwise.",
            "or": "or",
            "other": "Other",
            "owes_you__cell_friend": "owes you",
            "owes_you__cell_group": "you are owed",
            "owes_you_AMOUNT": "owes you %@",
            "paid_by__legacy": "Paid by",
            "paid_by_PERSON": "Paid by %@",
            "paid_by_the_other_person_and_split_equally": "Paid by the other person and split equally",
            "paid_by_you": "Paid by you",
            "paid_by_you_and_split_equally": "Paid by you and split equally",
            "fallback_person_name": "the other person",
            "passcode": "Passcode",
            "passcodes_did_not_match": "Passcodes did not match. Try again.",
            "pay_your_friends_back_any_time": "Pay your friends back any time",
            "pay_your_friends_back_any_time_with_cash_paypal_or_venmo": "Pay your friends back any time with cash, Paypal, or Venmo.",
            "PERSON_paid_PERSON_AMOUNT": "%1$@ paid %2$@ %3$@",
            "PERSON_paid_PERSON_AMOUNT_for_DESCRIPTION": "%1$@ paid %2$@ %3$@ for \u2018%4$@\u2019",
            "payment": "Payment",
            "payments": "Payments",
            "paypal_only_allows_payments_up_to_500_per_week": "PayPal only allows payments up to $500 per week. Sorry :(",
            "PERCENT_left": "%@% left",
            "PERCENT_over": "%@% over",
            "PERSON_is_sending_PERSON": "%1$@ is sending %2$@",
            "you_are_sending_PERSON": "You are sending %@",
            "PERSON_paid_PERSON": "%1$@ paid %2$@",
            "you_are_not_involved": "You are not involved",
            "PERSON_is_not_involved": "%@ is not involved",
            "PERSON_is_settled_up": "%@ is settled up",
            "PERSON_paid_AMOUNT": "%1$@ paid %2$@",
            "phone_optional": "Phone # (optional)",
            "plus_N_other_balances": "Plus %@ other balances",
            "post": "Post",
            "processing_expenses": "Processing expenses",
            "rate_splitwise": "Rate Splitwise",
            "receipt": "Receipt",
            "recent": "Recent",
            "recent_activity": "Recent activity",
            "record_a_cash_payment": "Record a cash payment",
            "refreshing": "Refreshing",
            "remember_to_enter_a_cost_for_your_bill_first": "Remember to enter a cost for your bill first!",
            "remind": "Remind",
            "reminder": "Reminder",
            "reminder_sent": "Reminder sent",
            "reminder_text_NAME_owes_me_AMOUNT": "Hey %1$@,\n\nI just wanted to note that you currently owe me %2$@.",
            "reminder_text_i_owe_NAME_AMOUNT": "Hey %1$@,\n\nI just wanted to note that I currently owe you %2$@.",
            "reminder_text_NAME_owes_me_AMOUNT_in_GROUP": "Hey %1$@,\n\nI just wanted to note that you currently owe me %2$@ in the group \u2018%3$@\u2019.",
            "reminder_text_i_owe_NAME_AMOUNT_in_GROUP": "Hey %1$@,\n\nI just wanted to note that I currently owe you %2$@ in the group \u2018%3$@\u2019.",
            "reminder_text_NAME_owes_NAME_AMOUNT_in_GROUP": "Hey %1$@ and %2$@,\n\nI just wanted to note that %1$@ currently owes %2$@ %3$@ in the group \u2018%4$@\u2019.",
            "remove_group_member": "Remove group member",
            "removing": "Removing",
            "repeats": "Repeats",
            "repeats_interval": "Repeats %@",
            "request_money_with_venmo": "Request money with Venmo",
            "resend_invite": "Resend invite",
            "reset_password": "Reset password",
            "save": "Save",
            "save_and_resend_invite": "Save & resend invite",
            "save_and_send_invite": "Save & send invite",
            "saving": "Saving",
            "search": "Search",
            "search_by_name": "Search by name",
            "send": "Send",
            "send_a_reminder_ON_DATE": "Send a reminder %@",
            "send_an_invite_to_this_email_address": "Send an invite to this email address",
            "send_an_invite_to_this_number": "Send an invite to this number",
            "send_reminder": "Send reminder",
            "sending": "Sending",
            "sending_you_back_to_the_home_screen": "We're sending you back to the home screen to refresh your data. Geronimo!",
            "sent": "Sent",
            "sent_via_METHOD": "Sent via %@",
            "settings": "Settings",
            "settle_up": "Settle up",
            "settled_up__cell_friend": "settled up",
            "settled_up__cell_group": "settled up",
            "you_are_settled_up__watch_line_2": "settled up",
            "share_a_link": "Share a link",
            "share_or_shares": "Share(s)",
            "shared_group": "Shared group",
            "showing_all_outstanding_balances": "Showing all outstanding balances.",
            "showing_only_groups_that_owe_you": "Showing only groups that owe you.",
            "showing_only_groups_that_you_owe": "Showing only groups that you owe.",
            "showing_only_people_that_owe_you": "Showing only people that owe you.",
            "showing_only_people_that_you_owe": "Showing only people that you owe.",
            "sign_up": "Sign up",
            "simplify": "Simplify",
            "simplify_group_debts": "Simplify group debts",
            "simplify_debts_is_on_in_this_group": "Simplify debts is ON in this group",
            "in_the_group_GROUP": "In the group \u2018%@\u2019",
            "on__enabled": "On",
            "off__disabled": "Off",
            "simplify_debts_off_illustration_explanation": "Splitwise will not combine debts in this group, even if there are unnecessary extra payments.",
            "simplify_debts_on_illustration_explanation": "Splitwise will automatically combine debts in this group to get rid of unnecessary extra payments.",
            "sorry": "Sorry",
            "split_by_exact_amounts": "Split by exact amounts",
            "split_by_percentages": "Split by percentages",
            "split_by_shares": "Split by shares",
            "split_by_adjustment": "Split by adjustment",
            "reimbursement": "Reimbursement",
            "itemized_bill": "Itemized bill",
            "split_equally": "Split equally",
            "split_unequally": "Split unequally",
            "split_the_bill": "Split the bill",
            "splitwise_could_not_understand_your_message": "Splitwise could not understand your message.",
            "splitwise_helps_you_split_bills_with_friends": "Splitwise helps you split bills with friends.",
            "splitwise_is_temporarily_down_for_maintenance": "Splitwise is temporarily down for maintenance. Please check @splitwise on Twitter for updates. Sorry for the inconvenience!",
            "splitwise_keeps_track_of_balances_between_friends": "Splitwise keeps track of balances between friends.",
            "start_a_group": "Start a group",
            "start_a_new_group": "Start a new group",
            "still_working": "Still working",
            "syncing": "Syncing",
            "take_a_picture": "Take a picture",
            "tap_anywhere_to_begin": "Tap anywhere to begin.",
            "tap_the_plus_button_below_to_add_a_bill": "Tap the plus button below to add a bill.",
            "tap_the_plus_button_below_to_add_a_bill_with_this_friend": "Tap the plus button below to add a bill with this friend.",
            "tap_the_plus_button_below_to_add_a_bill_with_this_group": "Tap the plus button below to add a bill with this group.",
            "tap_to_show_old_settled_friends": "Tap to show old settled friends",
            "tap_to_show_old_settled_groups": "Tap to show old settled groups",
            "terms_of_service": "Terms of Service",
            "thanks_person": "Thanks!\n%@",
            "the_expense_could_not_be_deleted": "The expense '%1$@' could not be deleted: %2$@\nSorry!",
            "the_math_for_this_expense_doesnt_add_up": "The math for this expense doesn't add up. Please double-check that you've entered the correct amounts for each person!",
            "the_internet_connection_appears_to_be_offline": "The Internet connection appears to be offline. We will attempt to add this expense again when the device is online.",
            "the_payment_values_do_not_add_up_to_COST": "The payment values do not add up to the total cost of %@.",
            "there_is_no_activity_in_your_account_yet": "There is no activity in your account yet.\nTry adding an expense!",
            "they_owe_the_full_amount": "They owe the full amount",
            "this_bill_had_a_negative_total": "This bill had a negative total",
            "this_group_is_a_default_group_created_by_splitwise": "This group is a default group created by Splitwise \u2013 you cannot change its settings. Sorry for the trouble!",
            "this_expense_cannot_be_edited_while_splitwise_is_syncing_with_the_server": "This expense cannot be edited while Splitwise is syncing with the server. Please try again later.",
            "this_expense_has_been_deleted_and_cannot_be_edited": "This expense has been deleted and cannot be edited. Undelete the expense if you would like to update it.",
            "no_comments_yet": "No comments yet.",
            "this_expense_has_not_yet_synced_with_the_server": "This expense has not yet synced with the server.",
            "this_feature_isnt_available": "This feature isn't available on iOS right now. Please sign up with your email address instead.",
            "this_month": "This month",
            "this_person_has_been_sent_an_invite_but_has_not_claimed_their_account_yet": "This person has been sent an invite, but has not claimed their account yet. They will not receive any messages from Splitwise.",
            "this_person_has_been_sent_an_invite_but_has_not_yet_accepted_that_invite": "This person has been sent an invite, but has not yet accepted that invite. To send another invite to this person (or to send an invite to a different address), tap the settings icon in the upper-right.",
            "this_person_has_not_been_invited_to_splitwise_yet": "This person has not been invited to Splitwise yet, and cannot receive any messages.",
            "this_person_has_unsubscribed_from_all_splitwise_messages": "This person has unsubscribed from all Splitwise messages.",
            "this_person_has_not_claimed_their_invite_click_to_update": "This person has been sent an invite, but has not claimed their account yet. Click to update their contact info or to re-send an invite message.",
            "this_person_does_not_have_an_email_click_to_update": "This person does not have an email address, and will not receive notifications about bills. Click to add an email address and send an invite to this person.",
            "this_setting_automatically_combines_debts": "This setting automatically combines debts to reduce the total number of repayments between group members.\n\nFor example, if you owe Anna $10 and Anna owes Bob $10, a group with simplified debts will tell you to pay Bob $10 directly.",
            "to__email_field": "To:",
            "today": "Today",
            "tos_disclaimer": "By signing up, you accept the Splitwise Terms of Service.",
            "total": "Total",
            "total_AMOUNT_of_AMOUNT": "Total: %1$@ of %2$@",
            "total_PERCENT_of_100": "Total: %@% of 100%",
            "total_balance": "Total balance",
            "total_balance__header": "total balance",
            "total_group_spending": "Total group spending",
            "total_you_paid_for": "Total you paid for",
            "trip": "Trip",
            "trying_to_use_quick_add": "Trying to use quick-add?",
            "turn_off_passcode": "Turn off passcode",
            "two_weeks_early": "2 weeks early",
            "unable_to_load_user": "Unable to load user",
            "unable_to_parse_expense": "Unable to parse expense. Please make sure you've included both a description and an amount.",
            "unable_to_update_user": "Unable to update user",
            "undelete_expense": "Undelete expense",
            "undelete_payment": "Undelete payment",
            "undeleting": "Undeleting",
            "unequally": "Unequally",
            "update_friend_info": "Update friend info",
            "update_your_account_info": "Update your account info",
            "uploading_image": "Uploading image",
            "view_details": "View details",
            "view_all_group_balances": "View all group balances",
            "view_group_totals": "View group totals",
            "weekly": "Weekly",
            "welcome_to_splitwise_NAME": "Welcome to Splitwise,\n%@!",
            "welcome_to_splitwise": "Welcome to Splitwise",
            "what_would_you_like_to_do": "What would you like to do?",
            "whats_this": "What\u2019s this?",
            "where_should_we_send_this_invite": "Where should we send this invite?",
            "who_do_you_want_to_settle_up_with": "Who do you want to settle up with?",
            "who_is_getting_paid": "Who is getting paid?",
            "who_is_paying": "Who is paying?",
            "whoops": "Whoops!",
            "pay_your_friends_with_cash_paypal_or_venmo": "Pay your friends back any time with cash, Paypal, or Venmo.",
            "yearly": "Yearly",
            "you__legacy": "you",
            "you_and_PERSON_are_all_settled_up": "You and %@ are all settled up.",
            "you_are_settled_up__watch_line_1": "you are",
            "you_are_all_settled_up_for_these_expenses": "You are all settled up for these expenses.",
            "you_are_all_settled_up_in_this_group": "You are all settled up in this group.",
            "you_are_owed__header": "you are owed",
            "you_are_over_by_AMOUNT": "You are over by %@.",
            "you_are_short_by_AMOUNT": "You are short by %@.",
            "you_are_the_only_one_here": "You\u2019re the only one here!",
            "you_borrowed__expense_cell": "you borrowed",
            "you_can_only_include_one_group_in_an_expense": "You can only include one group in an expense.",
            "you_can_split_expenses_with_groups_or_with_individuals": "You can split expenses with groups or with individuals.",
            "you_cant_comment_on_a_deleted_expense": "You can't comment on a deleted expense. Undelete the expense if you would like to leave a comment.",
            "you_do_not_have_any_groups_yet": "You do not have any groups yet.",
            "you_have_balances_in_multiple_currencies": "* You have balances in multiple currencies.",
            "this_group_has_balances_in_multiple_currencies": "This group has balances in multiple currencies.",
            "you_have_not_added_any_bills_with_this_friend_yet_tap_the_plus_button_below_to_add_a_bill_with_this_friend": "You have not added any bills with this friend yet.\n\nTap the plus button below to add a bill with this friend.",
            "you_have_not_added_any_bills_with_this_group_yet_tap_the_plus_button_below_to_add_a_bill_with_this_group": "You have not added any bills with this group yet.\n\nTap the plus button below to add a bill with this group.",
            "you_have_not_added_any_non_group_expenses_yet_tap_the_plus_button_below_to_add_a_bill": "You have not added any non-group expenses yet.\n\nTap the plus button below to add a bill.",
            "you_have_not_added_any_friends_yet": "You have not added any friends yet.",
            "you_have_not_entered_a_name_for_your_group_yet": "You haven't entered a name for your group yet!",
            "you_just_added_your_first_non_group_expense": "You just added your first non-group expense!",
            "you_lent__expense_cell": "you lent",
            "you_lent_NAME__expense_cell": "you lent %@",
            "you_may_not_enter_a_negative_amount_for_this_expense": "You may not enter a negative amount for this expense.",
            "you_owe__header": "you owe",
            "you_owe__friend": "you owe",
            "you_owe__group": "you owe",
            "you_owe_PERSON": "You owe %@",
            "you_owe_PERSON_AMOUNT": "You owe %1$@ %2$@",
            "you_owe_the_full_amount": "You owe the full amount",
            "you_paid_for_yourself": "You paid for yourself",
            "you_paid_PERSON": "You paid %@",
            "you_were_not_involved": "You were not involved",
            "your_account": "Your account",
            "your_comment_failed_to_send": "Your comment failed to send. Please try again.",
            "your_email_address": "Your email address",
            "your_invalid_expense_was_unable_to_sync": "Your expense was unable to sync because it is invalid. Please edit the expense and try again.",
            "your_password": "Your password",
            "your_password_must_be_at_least_4_characters_long": "Your password must be at least 4 characters long.",
            "your_total_share": "Your total share",
            "youre_the_only_member_in_this_group": "You're the only member in this group, and there's no point in settling up with yourself :)",
            "add_group__short": "Add",
            "add_friend__short": "Add",
            "allow_find_by_email_or_phone": "Allow other Splitwise users to find me by email or phone number",
            "change_your_password": "Change your password",
            "dashboard": "Dashboard",
            "these_errors_occurred": "The following errors occurred:",
            "email_notifications": "Email notifications",
            "filter_by_name": "Filter by name",
            "groups_and_friends": "Groups and friends",
            "major_splitwise_news_and_updates": "Major Splitwise news and updates",
            "mobile_notifications": "Mobile notifications",
            "monthly_summary_of_my_activity": "Monthly summary of my activity",
            "news_and_updates": "News and updates",
            "phone_number": "Phone number",
            "post_to_facebook__short": "Share",
            "post_to_twitter__short": "Tweet",
            "reset_password_prompt": "Enter your email address or phone number and we\u2019ll send you a link to reset your password.",
            "reset_password_success_message": "A message has been sent with instructions to reset your password.",
            "reset_password_if_you_have_issues": "If you have any further issues, please contact support@splitwise.com and we\u2019ll respond as quickly as we\u2019re able.",
            "reset_your_password": "Reset your password",
            "save_changes": "Save changes",
            "success": "Success",
            "time_zone": "Time zone",
            "bunnies_photo_credit": "Photo by Isaie Simonnet. Thanks, Isaie!",
            "unsubscribed_all_emails": "You have unsubscribed from all Splitwise emails.",
            "when_a_bill_is_added": "When a bill is added",
            "when_a_bill_is_edited_or_deleted": "When a bill is edited\/deleted",
            "when_a_bill_is_commented_on": "When someone comments on a bill",
            "when_a_bill_is_due": "When a bill is due",
            "when_added_as_a_friend": "When someone adds me as a friend",
            "when_added_to_a_group": "When someone adds me to a group",
            "when_someone_pays_me": "When someone pays me",
            "your_email_address_or_phone_number": "Your email address\/phone #",
            "hiding_accounts_explanation": "Hiding accounts settled for more than 30 days. Show \u00bb",
            "invite_friends": "Invite friends",
            "send_invite": "Send invite",
            "send_a_message_to": "Send a message to",
            "invite_sent_smiley": "Invite sent! :)",
            "you_do_not_owe_anything": "You do not owe anything",
            "you_received_AMOUNT": "You received %@",
            "you_owe_AMOUNT": "You owe %@",
            "you_paid_AMOUNT": "You paid %@",
            "you_get_back_AMOUNT": "You get back %@",
            "you_added_DESCRIPTION_html": "<strong>You<\/strong> added <strong>\u201c%2$@\u201d<\/strong>.",
            "you_updated_DESCRIPTION_html": "<strong>You<\/strong> updated <strong>\u201c%2$@\u201d<\/strong>.",
            "you_deleted_DESCRIPTION_html": "<strong>You<\/strong> deleted <strong>\u201c%2$@\u201d<\/strong>.",
            "you_undeleted_DESCRIPTION_html": "<strong>You<\/strong> undeleted <strong>\u201c%2$@\u201d<\/strong>.",
            "NAME_added_DESCRIPTION_html": "<strong>%1$@<\/strong> added <strong>\u201c%2$@\u201d<\/strong>.",
            "NAME_updated_DESCRIPTION_html": "<strong>%1$@<\/strong> updated <strong>\u201c%2$@\u201d<\/strong>.",
            "NAME_deleted_DESCRIPTION_html": "<strong>%1$@<\/strong> deleted <strong>\u201c%2$@\u201d<\/strong>.",
            "NAME_undeleted_DESCRIPTION_html": "<strong>%1$@<\/strong> undeleted <strong>\u201c%2$@\u201d<\/strong>.",
            "show_more": "Show more",
            "undelete_group": "Undelete group",
            "yesterday": "Yesterday",
            "click_add_bill_or_add_some_friends_first": "Click \u201cAdd a bill\u201d above to get started, or invite some friends first!",
            "to_add_an_expense_click_add_bill": "To add a new expense, click the orange \u201cAdd a bill\u201d button.",
            "youre_all_settled_up_awesome": "You\u2019re all settled up. Awesome!",
            "view_as_chart__web_dashboard": "view chart",
            "view_as_list__web_dashboard": "view as list",
            "you_are_not_owed_anything": "You are not owed anything",
            "unknown_group_name": "[Unknown group]",
            "quickadd": "Quick-add",
            "unsubscribed": "Unsubscribed",
            "view_printable_summary": "View printable summary",
            "you_are_all_settled_up": "You are all settled up",
            "unknown_user_name__proper_noun": "Someone",
            "unknown_user_name__common_noun": "someone",
            "NAME_paid_you_AMOUNT": "%1$@ paid you %3$@",
            "you_paid_NAME_AMOUNT": "You paid %2$@ %3$@",
            "NAME_paid_NAME_AMOUNT": "%1$@ paid %2$@ %3$@",
            "for_DESCRIPTION_html": "for %@",
            "sms_invite_reminder_FROM": "%1$@ wants to remind you to join Splitwise! Sign up for free: http:\/\/splitwise.com\/i\/%2$@",
            "sms_GROUP_invite_FROM": "%2$@ just invited you to the group '%1$@' on Splitwise! Sign up now to split expenses: http:\/\/splitwise.com\/i\/%3$@",
            "sms_invite_FROM": "Your friend %1$@ has invited you to split expenses on Splitwise: http:\/\/splitwise.com\/i\/%2$@",
            "sms_password_reset_LINK": "Need to reset your Splitwise password? Here's a link: http:\/\/splitwise.com%@",
            "sms_password_reset_info": "P.S. If you didn't request a password reset, or are having any trouble logging in, let us know at support@splitwise.com.",
            "NAME_added_NAME_to_GROUP_html": "<strong>%1$@<\/strong> added <strong>%2$@<\/strong> to the group <strong>\u201c%3$@\u201d<\/strong>.",
            "you_added_NAME_to_GROUP_html": "<strong>You<\/strong> added %2$@ to the group <strong>\u201c%3$@\u201d<\/strong>.",
            "NAME_added_you_to_GROUP_html": "<strong>%1$@<\/strong> added you to the group <strong>\u201c%3$@\u201d<\/strong>.",
            "you_were_added_to_GROUP_html": "<strong>You<\/strong> were added to the group <strong>\u201c%3$@\u201d<\/strong>.",
            "NAME_was_added_to_GROUP_html": "<strong>%2$@<\/strong> was added to the group <strong>\u201c%3$@\u201d<\/strong>.",
            "you_created_GROUP_html": "<strong>You<\/strong> created the group <strong>\u201c%2$@\u201d<\/strong>.",
            "NAME_commented_on_EXPENSE_COMMENT_html": "<strong>%1$@<\/strong> commented on <strong>\u201c%2$@\u201d<\/strong>: \u201c%3$@\u201d",
            "you_commented_on_EXPENSE_COMMENT_html": "<strong>You<\/strong> commented on <strong>\u201c%2$@\u201d<\/strong>: \u201c%3$@\u201d",
            "new_recurring_bill__prepend_html": "<strong>New recurring bill:<\/strong>",
            "payment_updated__prepend": "Payment updated:",
            "payment_deleted__prepend": "Payment deleted:",
            "payment_undeleted__prepend": "Payment undeleted:",
            "expense_updated__prepend": "Expense updated:",
            "expense_deleted__prepend": "Expense deleted:",
            "expense_undeleted__prepend": "Expense undeleted:",
            "simplify_turned_on_in_GROUP_html": "<strong>\u201cSimplify debts\u201d<\/strong> was turned <strong>on<\/strong> in the group <strong>\u201c%@\u201d<\/strong>.",
            "simplify_turned_off_in_GROUP_html": "<strong>\u201cSimplify debts\u201d<\/strong> was turned <strong>off<\/strong> in the group <strong>\u201c%@\u201d<\/strong>.",
            "hey_NAME": "Hey %@!",
            "new_expense_EXPENSE_was_just_added_html": "A new expense for %@ was just added on Splitwise.",
            "NAME_added_EXPENSE_to_GROUP_html": "<strong>%1$@<\/strong> just added <strong>\u201c%2$@\u201d<\/strong> to the group <strong>\u201c%3$@\u201d<\/strong>.",
            "NAME_added_EXPENSE_on_splitwise_html": "<strong>%1$@<\/strong> just added the expense <strong>\u201c%2$@\u201d<\/strong> on Splitwise.",
            "view_on_splitwise": "View on Splitwise",
            "have_a_great_day": "Have a great day!",
            "the_splitwise_team": "The Splitwise Team",
            "NAME_just_deleted_EXPENSE_in_GROUP_html": "<strong>%1$@<\/strong> just deleted <strong>\u201c%2$@\u201d<\/strong> in the group <strong>\u201c%3$@\u201d<\/strong>.",
            "NAME_just_updated_EXPENSE_in_GROUP_html": "<strong>%1$@<\/strong> just updated <strong>\u201c%2$@\u201d<\/strong> in the group <strong>\u201c%3$@\u201d<\/strong>.",
            "NAME_just_deleted_EXPENSE_on_splitwise_html": "<strong>%1$@<\/strong> just deleted <strong>\u201c%2$@\u201d<\/strong> on Splitwise.",
            "NAME_just_updated_EXPENSE_on_splitwise_html": "<strong>%1$@<\/strong> just updated <strong>\u201c%2$@\u201d<\/strong> on Splitwise.",
            "NAME_deleted_GROUP_html": "<strong>%1$@<\/strong> deleted the group <strong>\u201c%2$@\u201d<\/strong>.",
            "you_deleted_GROUP_html": "<strong>You<\/strong> deleted the group <strong>\u201c%2$@\u201d<\/strong>.",
            "NAME_removed_you_from_GROUP_html": "<strong>%1$@<\/strong> removed you from the group <strong>\u201c%2$@\u201d<\/strong>.",
            "you_removed_yourself_from_GROUP_html": "<strong>You<\/strong> removed yourself from the group <strong>\u201c%2$@\u201d<\/strong>.",
            "you_removed_NAME_from_GROUP_html": "<strong>You<\/strong> removed <strong>%2$@<\/strong> from the group <strong>\u201c%3$@\u201d<\/strong>.",
            "NAME_removed_NAME_from_GROUP_html": "<strong>%1$@<\/strong> removed <strong>%2$@<\/strong> from the group <strong>\u201c%3$@\u201d<\/strong>.",
            "NAME_left_GROUP_html": "<strong>%1$@<\/strong> left the group <strong>\u201c%3$@\u201d<\/strong>.",
            "you_removed_NAME_as_friend_html": "<strong>You<\/strong> removed <strong>%2$@<\/strong> as a friend.",
            "NAME_removed_you_as_friend_html": "<strong>%1$@<\/strong> removed you as a friend.",
            "you_undeleted_GROUP_html": "<strong>You<\/strong> undeleted the group <strong>\u201c%2$@\u201d<\/strong>.",
            "NAME_undeleted_GROUP_html": "<strong>%1$@<\/strong> undeleted the group <strong>\u201c%2$@\u201d<\/strong>.",
            "you_converted_GROUP_to_CURRENCY_html": "<strong>You<\/strong> converted all expenses in <strong>\u201c%2$@\u201d<\/strong> to the currency <strong>%3$@<\/strong>.",
            "NAME_converted_GROUP_to_CURRENCY_html": "<strong>%1$@<\/strong> converted all expenses in <strong>\u201c%2$@\u201d<\/strong> to the currency <strong>%3$@<\/strong>.",
            "you_converted_NAME_to_CURRENCY_html": "<strong>You<\/strong> converted all expenses with <strong>%2$@<\/strong> to the currency <strong>%3$@<\/strong>.",
            "NAME_converted_you_to_CURRENCY_html": "<strong>%1$@<\/strong> converted all expenses with you to the currency <strong>%3$@<\/strong>.",
            "reminder_EXPENSE_is_due_today_html": "Reminder: <strong>\u201c%1$@\u201d<\/strong> is due <strong>today<\/strong>!",
            "reminder_EXPENSE_is_due_tomorrow_html": "Reminder: <strong>\u201c%1$@\u201d<\/strong> is due <strong>tomorrow<\/strong>!",
            "reminder_EXPENSE_is_due_in_N_days_html": "Reminder: <strong>\u201c%1$@\u201d<\/strong> is due <strong>in %2$@ days<\/strong>!",
            "email_confused_about_this_email_NAME_html": "If you\u2019re confused about this, just hit reply to send an email to %@ and figure out what\u2019s going on.",
            "reminder_EXPENSE_is_due_today": "Reminder: '%@' is due today",
            "reminder_EXPENSE_is_due_tomorrow": "Reminder: '%@' is due tomorrow",
            "reminder_EXPENSE_is_due_in_N_days": "Reminder: '%1$@' is due in %2$@ days",
            "NAME_recorded_payment_to_you_in_GROUP_html": "FYI: %1$@ just recorded a payment to you in the group \u201c%3$@\u201d.",
            "NAME_recorded_payment_to_you_on_splitwise_html": "FYI: %1$@ just recorded a payment to you on Splitwise.",
            "NAME_recorded_payment_to_you_from_NAME_in_GROUP_html": "FYI: %1$@ just recorded a payment to you from %2$@ in the group \u201c%3$@\u201d.",
            "NAME_recorded_payment_to_you_from_NAME_on_splitwise_html": "FYI: %1$@ just recorded a payment to you from %2$@ on Splitwise.",
            "payment_for_DESCRIPTION": "Payment for %@",
            "payment_to_NAME": "Payment to %@",
            "you_received_nothing": "You received nothing",
            "NAME_EMAIL_added_you_to_GROUP_html": "<strong>%1$@<\/strong> (%2$@) just added you to the group <strong>\u201c%3$@\u201d<\/strong> on Splitwise.",
            "visit_now": "Visit now",
            "hope_youre_enjoying_splitwise": "We hope you\u2019re enjoying Splitwise!",
            "have_questions_let_us_know_at_ADDRESS": "If you have any questions or comments, be sure to let us know at %@.",
            "visit_splitwise_now": "Visit Splitwise now",
            "any_comments_hit_reply": "Any comments, thoughts, or suggestions? Hit reply and let us know.",
            "youre_settled_up_with_everyone": "You're settled up with everyone!",
            "see_all_friends": "See all friends",
            "plus_N_more_friends": "Plus %@ more friends",
            "largest_expenses": "Largest expenses",
            "bars_not_to_scale_for_multiple_currencies": "(bars not to scale for multiple currencies)",
            "see_all_transactions": "See all transactions",
            "see_more_details": "See more details",
            "payments_made": "Payments made",
            "payments_received": "Payments received",
            "your_balance_for_MONTH": "Your balance for %@",
            "payment_added_subject_line": "%1$@ paid you %2$@ on Splitwise",
            "expense_added_subject_line": "'%1$@' (%2$@) added by %3$@",
            "expense_updated_subject_line": "'%1$@' (%2$@) updated by %3$@",
            "expense_deleted_subject_line": "'%1$@' (%2$@) deleted by %3$@",
            "comment_added_subject_line": "%1$@ commented on '%2$@'",
            "added_to_group_subject_line": "%1$@ added you to the group '%2$@' on Splitwise",
            "manual_invite_reminder_subject_line": "A reminder from %@: come join Splitwise!",
            "automatic_invite_reminder_subject_line": "%@ is still waiting for you to join Splitwise...",
            "group_invite_subject_line": "[%1$@] %2$@ wants to share bills with you on Splitwise!",
            "friendship_invite_subject_line": "%@ wants to share bills with you on Splitwise!",
            "join_splitwise": "Join Splitwise",
            "NAME_is_still_waiting_for_you_to_join_html": "%@ is still waiting for you to join Splitwise...",
            "if_youre_not_interested_we_wont_bother_you_again": "(If you\u2019re not interested in Splitwise, we won\u2019t bother you again.)",
            "give_it_a_try": "Give it a try and see what you think!",
            "NAME_just_invited_you_to_join_html": "%@ just invited you to join Splitwise!",
            "NAME_EMAIL_just_invited_you_to_join_GROUP_html": "<strong>%1$@<\/strong> (<a href='mailto:%2$@'>%2$@<\/a>) has invited you to join the group <strong>\u201c%3$@\u201d<\/strong> on Splitwise.",
            "splitwise_explanation_for_group_invite_html": "<strong>Splitwise makes it easy to split expenses with your friends.<\/strong> Use Splitwise any time you split a bill \u2013 we\u2019ll keep track of how much each person owes in total, and make sure that everyone gets paid back.",
            "sign_up_now_for_group_invite": "Sign up now to see all of your group\u2019s bills, and to start adding bills of your own!",
            "nice_to_meet_you_NAME": "Nice to meet you, %@!",
            "already_seen_mobile_be_sure_to_check_out_our_website_html": "You\u2019ve already discovered our mobile app, but be sure to also check out our <a href='https:\/\/www.splitwise.com'>website<\/a> for spending charts, fairness calculators, and more.",
            "already_seen_web_be_sure_to_check_out_our_mobile_apps_html": "You\u2019ve already seen <a href='https:\/\/www.splitwise.com'>Splitwise.com<\/a>, but make sure to check out our free mobile apps for <a href='https:\/\/itunes.apple.com\/us\/app\/splitwise-split-bills-expenses\/id458023433?mt=8&uo=4&at=11l4CC'>iPhone<\/a> and <a href='http:\/\/market.android.com\/details?id=com.Splitwise.SplitwiseMobile'>Android<\/a> (plus unofficial Splitwise apps for <a href='http:\/\/www.windowsphone.com\/en-us\/search?q=splitwise'>Windows Phone<\/a>):",
            "have_questions_or_feedback_hit_reply_html": "If you have any questions or feedback, hit reply and let us know \u2013 we\u2019d love to hear from you. (Really!)",
            "organic_welcome_subject_line": "Hey there!",
            "visit_splitwise": "Visit Splitwise",
            "lapsed_user_how_are_you_html": "How are ya? It\u2019s been a while since we last saw you at Splitwise, so we wanted to check in and see how you\u2019re doing.",
            "lapsed_user_hit_reply_if_you_need_anything_html": "If there\u2019s anything we can do to make your Splitwise experience better, <strong>just hit reply and let us know<\/strong>. Otherwise, we won\u2019t bother you like this again :)",
            "lapsed_user_subject_line": "Long time no see, %@!",
            "ryan_from_splitwise": "Ryan from Splitwise",
            "lapsed_24_user_how_are_you_doing_html": "How are you doing? I noticed that you haven\u2019t added any expenses on Splitwise yet, so I wanted to check in and see if there\u2019s anything I can help you with.",
            "lapsed_24_user_hit_reply_if_you_need_anything_html": "If you have any thoughts or questions at all, <strong>just hit reply and let me know<\/strong>. We\u2019d all love to know what you\u2019re thinking \u2013 it\u2019ll help us make Splitwise better, for you and for all our users :)",
            "lapsed_24_user_subject_line": "Just checking in - anything we can help you with?",
            "forgot_password_subject_line": "Forgot your password? Fear not!",
            "NAME_forgot_your_password_it_happens": "We get it, %@ \u2013 you forgot your password. It happens to the best of us. We feel your pain.",
            "get_back_to_expense_splitting_html": "Click here to make up a new password and get back to expense-splittin\u2019:",
            "password_reset_failed_subject_line": "Password reset attempt",
            "password_reset_email_ps_html": "P.S. If you did not request a password reset, or are having any trouble logging in, please let us know at <a href='mailto:support@splitwise.com'>support@splitwise.com<\/a>.",
            "password_reset_failed_opener_html": "You (or someone else) entered this email address when attempting to reset your password on Splitwise. <strong>Unfortunately, there is no account on Splitwise with this email address.<\/strong>",
            "password_reset_failed_contact_us": "If you are a Splitwise user and were expecting this email, please try again with the email address that you used to register for Splitwise.",
            "password_reset_failed_not_sw_user": "If you are not a Splitwise user, please ignore this email. (And sorry for the spam!)",
            "visit_your_group_now": "Visit your group now",
            "you_are_settled_up_GROUP": "You are currently settled up for '%1$@'",
            "you_are_settled_up_FRIEND": "You are currently settled up with %1$@",
            "you_owe_AMOUNT_GROUP": "You currently owe %2$@ for '%1$@'",
            "you_owe_AMOUNT_FRIEND": "You currently owe %2$@ to %1$@",
            "you_are_owed_AMOUNT_GROUP": "You are currently owed %2$@ for '%1$@'",
            "you_are_owed_AMOUNT_FRIEND": "You are currently owed %2$@ by %1$@",
            "note_NOTE": "Note: %@",
            "added_as_friend_subject_line": "%@ added you as a friend on Splitwise",
            "NAME_EMAIL_added_you_as_a_friend_html": "%1$@ (<a href='mailto:%2$@'>%2$@<\/a>) just added you as a friend on Splitwise. Now you can easily share expenses and IOUs.",
            "p_s_check_us_out_on_mobile_html": "P.S. Be sure to check us out on <a href='https:\/\/itunes.apple.com\/us\/app\/splitwise-split-bills-expenses\/id458023433?mt=8&uo=4&at=11l4CC'>iPhone<\/a> and <a href='http:\/\/market.android.com\/details?id=com.Splitwise.SplitwiseMobile'>Android<\/a> to split expenses on the go!",
            "EXPENSE_is_almost_due": "\u2018%@\u2019 is almost due!",
            "including_this_bill_you_owe_AMOUNT_in_this_group_html": "Including this bill, you currently owe %@ in this group.",
            "including_this_bill_you_are_owed_AMOUNT_in_this_group_html": "Including this bill, you are currently owed %@ in this group.",
            "you_owe_nothing": "You owe nothing",
            "please_pay_promptly": "Please remember to pay up promptly.",
            "NAME_EMAIL_removed_you_from_GROUP_html": "<strong>%1$@<\/strong> (<a href='mailto:%2$@'>%2$@<\/a>) just removed you from the group <strong>\u201c%3$@\u201d<\/strong> on Splitwise.",
            "reply_to_email_NAME_if_this_seems_wrong": "If this seems wrong, just hit reply to send an email to %@ and ask what's up.",
            "NAME_removed_you_from_GROUP": "%1$@ removed you from the group '%2$@' on Splitwise",
            "NAME_deleted_GROUP": "%1$@ deleted the group '%2$@' on Splitwise",
            "undelete_group_from_account_settings_html": "If you wish, you may also undelete this group from your <a href='https:\/\/secure.splitwise.com\/account\/settings'>account settings page<\/a> on Splitwise.com.",
            "NAME_EMAIL_deleted_GROUP_html": "<strong>%1$@<\/strong> (<a href='mailto:%2$@'>%2$@<\/a>) just deleted the group <strong>\u201c%3$@\u201d<\/strong> on Splitwise.",
            "incorrect_email_or_password": "The email or password you entered is incorrect - please try again",
            "category_1": "Utilities",
            "category_27": "Home",
            "category_25": "Food and drink",
            "category_31": "Transportation",
            "category_40": "Life",
            "category_2": "Uncategorized",
            "category_19": "Entertainment",
            "category_48": "Cleaning",
            "category_37": "Trash",
            "category_7": "Water",
            "category_11": "Other",
            "category_8": "TV\/Phone\/Internet",
            "category_6": "Heat\/gas",
            "category_5": "Electricity",
            "category_18": "General",
            "category_20": "Games",
            "category_22": "Music",
            "category_23": "Other",
            "category_24": "Sports",
            "category_21": "Movies",
            "category_26": "Other",
            "category_12": "Groceries",
            "category_38": "Liquor",
            "category_13": "Dining out",
            "category_4": "Mortgage",
            "category_39": "Electronics",
            "category_3": "Rent",
            "category_30": "Services",
            "category_29": "Pets",
            "category_28": "Other",
            "category_14": "Household supplies",
            "category_16": "Furniture",
            "category_17": "Maintenance",
            "category_47": "Hotel",
            "category_46": "Bicycle",
            "category_36": "Taxi",
            "category_15": "Car",
            "category_35": "Plane",
            "category_34": "Other",
            "category_9": "Parking",
            "category_33": "Gas\/fuel",
            "category_32": "Bus\/train",
            "category_10": "Insurance",
            "category_45": "Taxes",
            "category_44": "Other",
            "category_43": "Medical expenses",
            "category_41": "Clothing",
            "category_42": "Gifts",
            "NAME_undeleted_GROUP": "%1$@ undeleted the group '%2$@' on Splitwise",
            "NAME_EMAIL_undeleted_GROUP_html": "<strong>%1$@<\/strong> (<a href='mailto:%2$@'>%2$@<\/a>) just undeleted the group <strong>\u201c%3$@\u201d<\/strong> on Splitwise.",
            "view_your_group_now": "View your group now",
            "NAME_updated_this_transaction": "%@ updated this transaction:",
            "bullet_moved_from_GROUP_to_GROUP": "- Moved from '%1$@' to '%2$@'",
            "bullet_description_changed_from_DESCRIPTION_to_DESCRIPTION": "- Description changed from '%1$@' to '%2$@'",
            "bullet_cost_changed_from_AMOUNT_to_AMOUNT": "- Cost changed from %1$@ to %2$@",
            "bullet_currency_changed_from_DESCRIPTION_to_DESCRIPTION": "- Currency changed from %1$@ to %2$@",
            "bullet_payer_changed_from_X_to_Y": "- Payer changed from %1$@ to %2$@",
            "NAME_AMOUNT": "%1$@ (%2$@)",
            "error_expense_cannot_involve_non_group_members": "This expense cannot be saved because it involves people who do not currently belong to the specified group. Saving this expense would throw off the balances of other group members such that they no longer added up correctly. If you wish to make this change, you must first add all of these people to the group.",
            "error_expense_you_do_not_belong_to_group": "You cannot add an expense to a group that you are not a member of.",
            "error_expense_must_involve_you": "You cannot add an expense that does not involve yourself, unless that expense is in a group.",
            "error_number_limited_to_two_decimals": "is limited to two decimal places",
            "error_expense_shares_owed_TOTAL_different_than_COST": "The total of everyone's owed shares (%1$@) is different than the total cost (%2$@)",
            "error_expense_shares_paid_TOTAL_different_than_COST": "The total of everyone's paid shares (%1$@) is different than the total cost (%2$@)",
            "error_expense_person_has_multiple_shares": "A person was included on this expense multiple times",
            "error_expense_date_invalid": "Date must be between the year 2000 and the year 2050",
            "error_expense_quickadd_nongroup_with_more_than_20_people": "Quick-add cannot split a non-group expense with more than 20 people. Sorry!",
            "error_expense_quickadd_N_people_confirmation": "This input would split an expense with all %@ of your friends. If you're sure you want to do this, please add 'with everyone' to the end of your sentence.",
            "error_friendship_already_exists": "These two users are already friends",
            "error_friendship_cant_delete_because_of_shared_group": "This person is in a group with you. If you wish to delete them from your friends list, you will need to delete them from your group first, or remove the group entirely.",
            "error_friendship_cant_delete_not_settled_up": "You still have outstanding debts with this person. If you wish to delete them from your friends list, you will need to settle those debts first.",
            "paid_share": "A person's paid share",
            "owed_share": "A person's owed share",
            "bullet_NAME_share_changed_from_AMOUNT_to_AMOUNT": "- %1$@'s share changed from %2$@ to %3$@",
            "bullet_NAME_was_added_to_the_transaction": "- %@ was added to the transaction",
            "bullet_NAMES_were_added_to_the_transaction": "- %@ were added to the transaction",
            "bullet_NAME_was_removed_from_the_transaction": "- %@ was removed from the transaction",
            "bullet_NAMES_were_removed_from_the_transaction": "- %@ were removed from the transaction",
            "NAME_converted_GROUP_to_CURRENCY": "%1$@ converted all expenses in the group '%2$@' to the currency %3$@",
            "NAME_EMAIL_converted_GROUP_to_CURRENCY_html": "<strong>%1$@<\/strong> (<a href='mailto:%2$@'>%2$@<\/a>) just converted all expenses in the group <strong>\u201c%3$@\u201d<\/strong> to the currency <strong>%4$@<\/strong>.",
            "settle_all_balances": "Settle all balances",
            "settle_all_balances_explanation": "Because %1$@ and %2$@ had a total balance of zero across all of Splitwise, Splitwise has automatically settled their balance with each other in every group (as well as settling any non-group expenses). This transaction is one part of a set. To see all parts of the 'Settle all balances' transaction, go to the 'All expenses' screen.",
            "one_on_one_debt_simplification": "One-on-one debt simplification",
            "one_on_one_debt_simplification_explanation": "This transaction consolidates the balance between %1$@ and %2$@ in one place.",
            "debt_simplification": "Debt simplification",
            "debt_simplification_explanation": "This expense consolidates the balances between multiple different friends. Go to the 'All expenses' screen to see all of the parts of this debt simplification that affect you, and to see how it changed your balances with other friends. (Your total balance across all friends has not changed.)",
            "user_email": "Email address",
            "user_name": "Name",
            "user_first_name": "First name",
            "user_password": "Password",
            "user_phone": "Phone number",
            "group_name": "Group name",
            "expense_description": "Description",
            "expense_cost": "Cost",
            "description": "Description",
            "expense_date": "Date",
            "cost": "Cost",
            "subtotal": "Subtotal",
            "grand_total": "Grand total",
            "itemized_bill_item": "Item",
            "bill_tax": "Tax",
            "bill_tip": "Tip",
            "memberships_user_email": "A member's email address",
            "memberships_user_name": "A member's name",
            "memberships_user_phone": "A member's phone number",
            "error_user_misspelled_email_address": "It looks like you misspelled the end of your email address. Please fix any mistakes and try again!",
            "error_user_cant_use_splitwise_email": "Sorry, but you can't sign up with an email address ending in '@splitwise.com'. Please enter another email address where we can reach you.",
            "error_user_password_is_too_common": "is too common (e.g. '12345', 'password', etc) - please choose something more complex or unique",
            "error_user_phone_looks_like_nonUS_number": "It looks like you're trying to enter a non-US phone number. If so, please include a plus symbol and country code at the beginning of the number (for example, \"+44\" for the United Kingdom). Thanks!",
            "error_user_merge_shared_expenses": "This action would merge two user accounts that have expenses in common. If you really want to combine these accounts, first you'll need to delete any expenses that they share. Sorry for the trouble!",
            "error_user_merge_shared_groups": "Sorry, but Splitwise requires all group members to have unique email addresses! This action would merge two user accounts in the same group under one email address. If you think you've received this message in error, please let us know at support@splitwise.com.",
            "error_group_cannot_turn_off_simplify_debts_with_REMOVED_MEMBERS": "'Simplify debts' cannot be turned off after a group member has been removed, as it would cause the following removed members to have balances again: %@. If you wish to disable 'simplify debts', please add these members back to the group first.",
            "error_group_must_have_members": "A group must have at least one member",
            "error_group_cannot_add_member_by_user_id": "You cannot add unknown users to a group by user_id",
            "error_group_member_merge_failed_DETAILS": "An error occurred when attempting to merge accounts: %@",
            "error_membership_duplicate_member": "A user cannot belong to a group more than once",
            "error_membership_delete_not_settled_up_simplify_on": "You can't delete someone from your group until that person has a balance of zero",
            "error_membership_delete_not_settled_up_simplify_off": "You can't delete someone from your group who still has outstanding debts to other people",
            "settings_updated_successfully": "Settings updated successfully",
            "password_reset_sent_html": "A message has been sent to %@ with instructions to reset your password.",
            "language": "Language",
            "group_tooltip": "Groups are perfect for apartments, trips, and other situations where the same set of people share a large number of bills.",
            "empty_GROUP_subject": "Adding friends to %@",
            "trouble_adding_friends_to_GROUP": "I got an alert that you may be having trouble adding friends to %@.",
            "group_share_link_html": "To make it easier I wanted to give you this group share link: <a href='http:\/\/www.splitwise.com\/join\/%1$@'>http:\/\/www.splitwise.com\/join\/%1$@<\/a>.",
            "GROUP_share_link_explaination": "Anyone who clicks that link will be automatically added to your group \u201c%@\u201d. You can distribute the link by forwarding this email on to your friends, pasting it into a text message, etc.",
            "write_me_for_more_help": "If you need any more help getting started just write to me at this email address and I'll do my best to get you sorted ASAP. You can also find lots of good tips about using Splitwise in our knowledge base.",
            "zoe_signoff_html": "All my best,<br>Zoe",
            "invalid_login_code": "Your login code is no longer valid. Please log in with your email address and password instead.",
            "splitwise_on_the_go": "Splitwise on the go",
            "get_the_app_and_add_ious_anywhere": "Get the free Splitwise app and add IOUs from anywhere:",
            "get_the_splitwise_app": "Get the Splitwise app",
            "or_continue_to_the_Splitwise_website": "or continue to the Splitwise website",
            "mobile_splash_tagline": "Split bills, IOUs, and other expenses with your friends, stress-free.",
            "flash_after_invite_app_download_prompt": "Account created successfully! Now get the app and start splitting expenses:",
            "plus_third_party_apps": "+ third-party apps for",
            "windows_phone": "Windows Phone",
            "happy_summer": "Happy summer!",
            "get_outside_and_play_use_splitwise_for_post_game_dinner": "Get outside and play! Use Splitwise for team expenses, or to split a post-game dinner with friends.",
            "split_the_dinner_bill": "Split the dinner bill",
            "check_out_plates_html": "Check out <strong>Plates<\/strong>, our free iOS app to quickly and easily split dinner bills with friends.",
            "check_out_plates_LINK_html": "Check out <a href='%@'>Plates<\/a>, our free iPhone app to help you split restaurant bills.",
            "download_plates": "Download Plates",
            "upcoming_bills": "Upcoming bills",
            "trends": "Trends",
            "whiteboard": "Whiteboard",
            "trends_this_month": "Trends this month",
            "view_full_charts": "View full charts",
            "click_to_edit_whiteboard": "Click here to edit the whiteboard!",
            "whiteboard_description": "Use the whiteboard to remember important info, like your landlord\u2019s address or emergency contact info.",
            "edit_friend_info": "Edit friend info",
            "remove_this_friend": "Remove this friend",
            "send_a_balance_reminder": "Send a balance reminder",
            "simplify_debts_with_this_person": "Simplify debts with this person",
            "nongroup_currency_conversion_confirmation": "This will convert all non-group transactions with this friend to %@ (your default currency) at the current international exchange rate. This action cannot be reversed. Are you sure you wish to continue?",
            "group_currency_conversion_confirmation": "This will convert all transactions in this group to %@ (your default currency) at the current international exchange rate. This action cannot be reversed. Are you sure you wish to continue?",
            "pro": "Pro",
            "convert_to_CURRENCY": "Convert to %@",
            "edit_group_settings": "Edit group settings",
            "hide_items_without_me": "Hide items not involving me",
            "show_items_without_me": "Show items not involving me",
            "pending": "Pending",
            "you_paid__expense_cell": "you paid",
            "you_received__expense_cell": "you received",
            "recurring": "Recurring",
            "NAME_paid__expense_cell": "%@ paid",
            "N_people_paid__expense_cell": "%@ people paid",
            "not_involved__expense_cell_oneline_html": "not involved",
            "not_involved__expense_cell_html": "not<br>involved",
            "NAME_lent_you__expense_cell": "%@ lent you",
            "you_borrowed_nothing__expense_cell_html": "you borrowed<br>nothing",
            "delete_expense_confirmation": "Are you sure you want to delete this expense?",
            "delete_expense_confirmation_warning": "This will completely remove this expense for ALL people involved, not just you.",
            "delete_payment_confirmation": "Are you sure you want to delete this payment?",
            "delete_with_simplification": "This will undo all parts of this debt simplification.",
            "recurring_bill_next_on_DATE": "Recurring bill (next occurrence on %@)",
            "cancel_future_recurrences": "Cancel future recurrences",
            "sent_via_METHOD_STATUS": "Sent via %1$@ (%2$@)",
            "confirmed__payment_status": "Payment confirmed",
            "incomplete__payment_status": "Payment incomplete",
            "venmo_incomplete_explanation": "We have not yet received confirmation from Venmo that the funds for this payment were transferred.",
            "payment_is_pending": "This payment is pending.",
            "paypal_incomplete_explanation": "Funds have not yet been transferred for this payment. Usually this is because the person who added the payment failed to complete the process on PayPal.com.",
            "finish_sending_payment": "Finish sending payment",
            "NAME_paid_AMOUNT_and_received_AMOUNT_html": "%1$@ paid %2$@ and received %3$@",
            "NAME_paid_AMOUNT_and_owes_AMOUNT_html": "%1$@ paid %2$@ and owes %3$@",
            "NAME_paid_AMOUNT_html": "%1$@ paid %2$@",
            "NAME_received_AMOUNT_html": "%1$@ received %2$@",
            "NAME_owes_AMOUNT_html": "%1$@ owes %2$@",
            "NAME_owes_AMOUNT_to_NAME_html": "%1$@ owes %2$@ to %3$@",
            "NAME_owes_NAME_AMOUNT_html": "%1$@ owes %2$@ %3$@",
            "notes_and_comments": "Notes and comments",
            "no_results_found": "No results found",
            "attach_an_image": "Attach an image",
            "attach_an_image_or_pdf": "Attach an image or PDF",
            "include_a_memo": "Include a memo",
            "split_this_expense": "Split this expense",
            "enter_each_persons_share": "Enter each person's share:",
            "tap_to_show_settled_bills": "Tap to show settled bills",
            "simplify_debts_is_on": "Simplify debts is ON",
            "what_would_you_like_to_do_first": "What would you like to do first?",
            "skip_setup_for_now": "Skip setup for now",
            "device_settings": "Device settings",
            "all_bills_before_this_date_have_been_settled_up": "All bills before this date have been settled up.",
            "never": "Never",
            "choose_a_currency": "Choose a currency",
            "add_bill": "Add bill",
            "unable_to_restore_local_edits_on_the_expense": "Unable to restore local edits on the expense.",
            "you_must_have_a_friend_chosen_to_have_an_iou": "You must have a friend chosen to have an IOU.",
            "you__with_YOU_and__add_bill": "you",
            "with_YOU_and__add_bill": "With %@ and:",
            "with__add_bill": "With:",
            "with_you_and__add_bill_html": "With <strong>you<\/strong> and:",
            "i_owe_you": "I owe you",
            "you_owe_me": "You owe me",
            "split_this_bill": "Split this bill",
            "NAME_owes_you_the_full_total": "%@ owes you the full total",
            "two_plus_people": "2+ people",
            "choose_a_category": "Choose a category",
            "unable_to_process_image": "Unable to process image.",
            "sync_in_progress": "Sync in progress",
            "now_loading_expenses_wait": "Now loading your expenses...this may take a moment.",
            "server_error_alert_for_failed_background_sync": "A server error prevented this transaction from originally saving to the server. To try adding this bill again, please hit 'Edit' and then 'Save'.",
            "add_friend": "Add friend",
            "you_cannot_remove_this_person_until_you_have_saved_changes_to_the_group": "You cannot remove this person until you have saved changes to the group",
            "you_owe_PERSON_the_full_total": "You owe %@ the full total",
            "add_person_to_group": "Add person to group",
            "choose_person": "Choose person",
            "this_will_restore_the_expense_for_everyone_involved": "This will restore the expense for everyone involved.",
            "whoops_you_cannot_add_a_comment_until_the_expense_has_been_synced_with_the_server": "Whoops! You cannot add a comment until the expense has been synced with the server.",
            "downloading": "Downloading",
            "on_DATE": "On %@",
            "for_MEMO": "For \u2018%@\u2019",
            "you_must_select_at_least_one_person_to_split_with": "You must select at least one person to split with.",
            "total_per_share_AMOUNT": "Total per share: %@",
            "total_share_AMOUNT": "Total share: %@",
            "this_expense_failed_to_sync": "This expense failed to sync",
            "enter_new_name_and_email_address": "Enter new name and email address:",
            "you_must_enter_a_name": "You must enter a name",
            "this_person_is_not_yet_synced_to_our_server_please_sync_first": "This person is not yet synced to our server \u2013 please sync and then try again.",
            "unable_to_find_program_that_can_send_email": "Unable to find program that can send email",
            "send_file_with__choose_program": "Send file with",
            "push_notifications_are_disabled_because_google_play_services_are_unavailable": "Push notifications are disabled because Google Play Services are unavailable.",
            "none__choice_of_alert_sound": "None",
            "splitwise_export_for_RELATIONSHIP": "Splitwise export for %@",
            "NAME_gets_back_AMOUNT_in_total": "%1$@ gets back %2$@ in total",
            "NAME_owes_AMOUNT_in_total": "%1$@ owes %2$@ in total",
            "NAME_owes_AMOUNT_to_NAME": "%1$@ owes %2$@ to %3$@",
            "connecting_to_google": "Connecting to Google",
            "news": "News",
            "this_will_restore_all_expenses_and_balances_for_this_group": "This will restore all expenses and balances for this group.",
            "working": "Working",
            "paypal_was_unable_to_complete_your_payment": "PayPal was unable to complete your payment:",
            "please_contact_service_at_paypal_dot_com_for_support": "Please contact service@paypal.com for support.",
            "bunnies_title": "Bunnies!",
            "this_transaction_failed_to_sync_with_the_server": "This transaction failed to sync with the server.",
            "could_not_launch_the_google_play_store": "Could not launch the Google Play store",
            "android_tour_left_menu_top": "Split with groups and individual friends",
            "android_tour_left_menu_bottom": "Keep track of apartment bills, group trips, random IOUs, and more",
            "android_tour_payment_methods_top": "Settle up instantly, any way you like",
            "android_tour_payment_methods_bottom": "Send money for free with PayPal and Venmo (or just use cash)",
            "android_tour_laptop_top": "Works on your phone and on the web",
            "android_tour_laptop_bottom": "Everyone can log in and add bills, even without a smartphone",
            "android_tour_logo_top": "Time to get started!",
            "android_tour_logo_bottom": "Tap anywhere to begin.",
            "expenses": "Expenses",
            "undelete_this_payment": "Undelete this payment",
            "undelete_this_expense": "Undelete this expense",
            "delete_this_payment": "Delete this payment",
            "delete_this_expense": "Delete this expense",
            "unable_to_find_program_that_can_view_EXTENSION_files": "Unable to find program that can view .%@ files.",
            "invite_resent": "Invite re-sent",
            "failed": "Failed",
            "enter_names_or_emails": "Enter names or email addresses",
            "hit_enter_to_add_person": "Hit enter to add this person",
            "NUMBER_contacts_imported": "%@ contacts imported",
            "enter_an_email_address_for_NAME": "Enter an email address for %@",
            "general_unknown_error": "An unknown error occured. Please try again or contact support@splitwise.com if you experience repeated issues. Sorry for the trouble!",
            "cannot_view_permission_error_html": "Whoops \u2013 you don't have permission to view this friend or group! Make sure you're logged into the correct Splitwise account. Sorry! :(",
            "NAME_currently_owes_AMOUNT": "%1$@ currently owes %2$@",
            "NAME_is_currently_owed_AMOUNT": "%1$@ is currently owed %2$@",
            "NAME_currently_owes_nothing": "%1$@ currently owes nothing",
            "no_recurring_bills_added_html": "You have not added any recurring bills yet",
            "error_expense_render_ID": "Please report this expense ID to us at support@splitwise.com: ID #%@. Thanks!",
            "cancel_recurrence_confirmation": "Are you sure you want to stop this bill from recurring in the future?",
            "delete_comment_confirmation": "Are you sure you want to delete this comment?",
            "error_expense_list_group_render": "The data on this page may be out of date. Please try refreshing the page, or contact us at support@splitwise.com if you experience this error repeatedly. Thanks!",
            "simplify_debts_with_NAME": "Simplify debts with %@",
            "you_have_multiple_balances_with_NAME_html": "You have multiple balances with %@.",
            "simplify_explaination_with_NAME_NAME_html": "If you click \u201cSimplify debts\u201d, all of your group balances with %1$@ will be settled, and the outstanding balance will be consolidated into one non-group expense with %2$@.",
            "send_money_via_paypal": "Send money via PayPal",
            "finish_payment_with_SERVICE": "Finish payment with %@",
            "alert_no_users_involved": "There are zero people involved in this expense! Make sure to add some before saving.",
            "alert_only_one_user_confirmation": "There is only one person involved in this expense. Do you still want to save it?",
            "you_must_enter_an_amount": "You must enter an amount",
            "you_must_enter_a_description": "You must enter a description",
            "alert_COMPANY_only_accepts_usd": "%@ only accepts payments in USD. Sorry!",
            "alert_request_via_venmo_unsupported": "Splitwise doesn't support requesting money via Venmo yet. If you want someone else to settle up with you via Venmo, they'll need to log in and initiate the transaction from their account. Our apologies!",
            "this_will_send_AMOUNT_to_NAME_from_venmo_html": "This will send a payment for %1$@ to %2$@. These funds will be taken from your Venmo account. Please click the \u201cSend\u201d button below to confirm.",
            "send_AMOUNT_via_SERVICE": "Send %1$@ via %2$@",
            "alert_file_size_exceeded_confirmation": "Splitwise does not allow file uploads larger than 2MB. Would you like to save this expense without the attachment?",
            "hey_there": "Hey there",
            "simplify_debts_tooltip": "'Simplify debts' automatically combines debts between members of your group to reduce the total number of payments. Turn this feature on and off from the group settings page.",
            "it_looks_like_you_use_an_ad_blocker": "It looks like you use an ad blocker. That\u2019s cool! So do we :)",
            "please_support_splitwise_by_telling_friends": "Please support Splitwise by telling your friends about us!",
            "edit": "Edit",
            "tap_the_plus_button_in_the_upper_right_to_add_a_bill": "Tap the plus button in the upper right to add a bill.",
            "tap_the_plus_button_to_add_your_first_bill_or_add_some_friends": "Tap the plus button to add your first bill, or add some friends first!",
            "notification_sound": "Notification sound",
            "vibrate": "Vibrate",
            "led_lights": "LED lights",
            "led_lights_description": "Flash LED lights when a notification arrives",
            "disable_notifications": "Disable notifications",
            "disable_notifications_description": "Prevent this device from receiving notifications.\nDoes not disable notifications on other devices.",
            "fairness_calculators": "Fairness calculators",
            "splitwise_pro": "Splitwise Pro",
            "charts": "Charts",
            "total_change_in_balance": "Total change in balance",
            "this_group_has_simplify_turned_on_explanation": "This group has the 'simplify debts' setting turned on. If you're confused why you owe this amount, visit this group and click 'More details' for further explanation.",
            "you_have_not_added_any_expenses_yet": "You have not added any expenses yet",
            "your_balance": "Your balance",
            "your_total_balance": "Your total balance",
            "write_me_for_more_help_html": "If you need any more help getting started just write to me at this email address and I'll do my best to get you sorted ASAP. You can also find lots of good tips about using Splitwise in our <a href='http:\/\/feedback.splitwise.com\/knowledgebase'>knowledge base<\/a>.",
            "show_settled_bills": "Show settled bills",
            "add_friends_from_gmail": "Add friends from Gmail",
            "invite_friends_by_email_address": "Invite friends by email address",
            "include_an_optional_message": "Include an optional message",
            "send_invites_and_add_friends": "Send invites and add friends",
            "preview_the_message_youll_send": "Preview the message you'll send",
            "suggested_repayments_for_GROUP": "Suggested repayments for \u201c%@\u201d",
            "NAME_is_all_settled_up": "%@ is all settled up",
            "bullet_owes_AMOUNT_to_NAME__short_html": "\u2022 owes %1$@ to %2$@",
            "bullet_gets_back_AMOUNT_from_NAME__short_html": "\u2022 gets back %1$@ from %2$@",
            "looking_for_our_fairness_calculators": "Looking for our fairness calculators?",
            "click_here": "Click here",
            "or_log_in_with": "Or log in with",
            "flash_login_failed_reset_password": "Whoops! We couldn\u2019t find an account for that email address and password. Maybe you\u2019ve <a href='%@'>forgotten your password?<\/a>",
            "my_group_shall_be_called": "My group shall be called",
            "my_group_is_called": "My group is called",
            "tip_group_invite_link_ONCLICK_html": "Tip: Lots of people to add? Send your friends an <a href='#' onclick=\"%@\">invite link<\/a>.",
            "alert_removal_criteria": "A person must zero out their account (i.e. have a balance of $0.00) before he or she can be removed.",
            "invite_group_members_by_link": "Invite group members by link",
            "invite_group_link_explanation": "Send this link to your friends, and when they click it, they'll automatically be added to this group.",
            "or_add_group_members_manually": "Or add group members manually",
            "whoops_emails_must_be_unique_html": "Whoops! Please use a unique email for each group member.",
            "view_receipt_EXTENSION_with": "View receipt .%@ with",
            "PERSON_received_AMOUNT": "%1$@ received %2$@",
            "PERSON_owes_AMOUNT": "%1$@ owes %2$@",
            "PERSON_paid_AMOUNT_and_owes_AMOUNT": "%1$@ paid %2$@ and owes %3$@",
            "YOU_paid_AMOUNT_and_owe_AMOUNT": "%1$@ paid %2$@ and owe %3$@",
            "select_source": "Select source",
            "nothing__amount": "nothing",
            "my_account": "My account",
            "create_a_new_password": "Create a new password",
            "very_sorry_for_the_trouble_NAME": "Very sorry for the trouble, %@!",
            "please_enter_a_new_password_below": "Please enter a new password below:",
            "your_new_password": "Your new password",
            "your_name": "Your name",
            "get_started": "Get started!",
            "change_your_avatar": "Change your avatar",
            "check_out_splitwise_pro": "Check out Splitwise Pro",
            "simplify_your_debts": "Simplify your debts",
            "privacy_settings": "Privacy settings",
            "your_apps": "Your apps",
            "log_out_on_all_devices": "Log out on all devices",
            "log_out_on_all_devices_confirmation": "Are you sure? This will log you out of Splitwise.com and the Splitwise mobile apps, and will revoke access to all third-party apps that access your account.",
            "download_json_backup": "Download JSON backup",
            "delete_your_account": "Delete your account",
            "delete_your_account_confirmation": "Are you ABSOLUTELY sure you want to delete your account? This cannot be undone.",
            "merge_with_another_account": "Merge with another account",
            "select_a_group_to_undelete": "Select a group to undelete:",
            "deleted_on_DATE_by_NAME": "deleted on %1$@ by %2$@",
            "your_default_currency": "Your default currency",
            "for_new_expenses": "for new expenses",
            "your_time_zone": "Your time zone",
            "connect_your_EXTERNAL_SERVICE_account": "Connect your %@ account",
            "disconnect_your_external_accounts": "Disconnect your external accounts",
            "disconnect_your_external_accounts_confirmation": "Are you sure you want to disconnect your external accounts? You will still be able to log in to Splitwise with your email address and password.",
            "get_splitwise_pro": "Get Splitwise Pro!",
            "subscribe_to_sw_pro_for_BENEFITS_html": "Subscribe to <strong>Splitwise Pro<\/strong> for charts, search, %@, and more!",
            "early_access_to_new_features": "early access to new features",
            "an_adfree_experience": "an ad-free experience",
            "you_are_a_sw_pro_member_html": "You are a <strong>Splitwise Pro<\/strong> member.",
            "thanks_for_your_support": "Thanks for your support!",
            "you_currently_pay_splitwise_AMOUNT_each_month_html": "You currently pay Splitwise %@ each month.",
            "you_currently_pay_splitwise_AMOUNT_every_NUM_months_html": "You currently pay Splitwise %1$@ every %2$@ months.",
            "if_you_like_splitwise_please_consider_contributing": "If you like Splitwise, please consider contributing! :)",
            "update_subscription": "Update subscription",
            "cancel_subscription": "Cancel subscription",
            "join_GROUP": "Join \u201c%@\u201d",
            "introduce_yourself": "Introduce yourself",
            "hi_there_my_name_is": "Hi there! My name is",
            "heres_my_email_address_html": "Here\u2019s my <strong>email address<\/strong>:",
            "and_heres_my_password_html": "And here\u2019s my <strong>password<\/strong>:",
            "and_heres_the_currency_i_use_html": "And here\u2019s the <strong>currency<\/strong> that I use:",
            "sign_me_up": "Sign me up!",
            "just_a_sec": "Just a sec...",
            "sign_up_with_SERVICE": "Sign up with %@",
            "dont_use_usd_for_currency": "Don't use USD for currency?",
            "split_expenses_with_friends__home_page_header": "Split expenses with friends.",
            "share_bills_and_ious_html": "<strong>Share<\/strong> bills and IOUs.",
            "make_sure_everyone_gets_paid_back_html": "<strong>Make sure<\/strong> everyone gets paid back.",
            "totally_free_for_web_iphone_and_android_html": "<strong>Totally free<\/strong> for web, iPhone, and Android.",
            "get_started_now": "Get started now",
            "its_free": "it's free",
            "ious_made_easy": "IOUs made easy.",
            "splitwise_takes_the_trouble_out_of_sharing_expenses": "Splitwise takes the trouble out of sharing expenses \u2013 with friends, with roommates, with anyone.",
            "we_do_the_math_for_you": "We do the math for you",
            "splitwise_keeps_a_running_total": "Splitwise keeps a running total over time, so you can pay each other back in one big payment, instead of a bunch of small ones.",
            "friendly_email_reminders": "Friendly email reminders",
            "get_notified_when_the_rent_is_due": "Get notified when the rent check is due\u2026or get a reminder when you forget to pay someone back.",
            "were_fairness_experts": "We\u2019re fairness experts",
            "fairness_experts_details_LINK_LINK_html": "How should we <a href='%1$@'>split the cost of rent<\/a>? At what point is a <a href='%2$@'>girlfriend a roommate<\/a>? Participate in cool fairness research and get advice on all sorts of common sharing problems.",
            "bring_splitwise_anywhere": "Bring Splitwise anywhere",
            "bring_splitwise_anywhere_blurb": "No need to save the receipt! With mobile apps for iPhone and Android, you can add expenses as soon as they happen.",
            "new__word": "New",
            "learn_more": "Learn more",
            "and_best_of_all_its_totally_free": "And best of all? It's totally free.",
            "ready_to_give_splitwise_a_spin": "Ready to give Splitwise a spin?",
            "meta_tag_description": "Splitwise is a free tool for friends and roommates to track bills and other shared expenses, so that everyone gets paid back. On the web, iPhone, and Android!",
            "made_with_smiles_in_pvd_html": "Made with \u263b in Providence, RI, USA",
            "copyright_YEAR": "Copyright \u00a9 %@ Splitwise, Inc. All rights reserved.",
            "jobs": "Jobs",
            "calculators": "Calculators",
            "blog": "Blog",
            "terms": "Terms",
            "press": "Press",
            "you__subject": "You",
            "_link_arrow": "%@ \u00bb",
            "_exclamation": "%@!",
            "_parentheses": "(%@)",
            "_in_progress": "%@...",
            "_plus_prefix": "+ %@",
            "_colon": "%@:",
            "_period": "%@.",
            "_quotation_marks": "\u201c%@\u201d",
            "you_added_DESCRIPTION_in_GROUP_html": "<strong>You<\/strong> added <strong>\u201c%2$@\u201d<\/strong> in <strong>\u201c%3$@\u201d<\/strong>.",
            "you_updated_DESCRIPTION_in_GROUP_html": "<strong>You<\/strong> updated <strong>\u201c%2$@\u201d<\/strong> in <strong>\u201c%3$@\u201d<\/strong>.",
            "you_deleted_DESCRIPTION_in_GROUP_html": "<strong>You<\/strong> deleted <strong>\u201c%2$@\u201d<\/strong> in <strong>\u201c%3$@\u201d<\/strong>.",
            "you_undeleted_DESCRIPTION_in_GROUP_html": "<strong>You<\/strong> undeleted <strong>\u201c%2$@\u201d<\/strong> in <strong>\u201c%3$@\u201d<\/strong>.",
            "NAME_added_DESCRIPTION_in_GROUP_html": "<strong>%1$@<\/strong> added <strong>\u201c%2$@\u201d<\/strong> in <strong>\u201c%3$@\u201d<\/strong>.",
            "NAME_updated_DESCRIPTION_in_GROUP_html": "<strong>%1$@<\/strong> updated <strong>\u201c%2$@\u201d<\/strong> in <strong>\u201c%3$@\u201d<\/strong>.",
            "NAME_deleted_DESCRIPTION_in_GROUP_html": "<strong>%1$@<\/strong> deleted <strong>\u201c%2$@\u201d<\/strong> in <strong>\u201c%3$@\u201d<\/strong>.",
            "NAME_undeleted_DESCRIPTION_in_GROUP_html": "<strong>%1$@<\/strong> undeleted <strong>\u201c%2$@\u201d<\/strong> in <strong>\u201c%3$@\u201d<\/strong>.",
            "NAME_paid_you_AMOUNT_for_DESCRIPTION": "%1$@ paid you %3$@ for \u201c%4$@\u201d",
            "you_paid_NAME_AMOUNT_for_DESCRIPTION": "You paid %2$@ %3$@ for \u201c%4$@\u201d",
            "NAME_paid_NAME_AMOUNT_for_DESCRIPTION": "%1$@ paid %2$@ %3$@ for \u201c%4$@\u201d",
            "you_added_paid_payment_to_PERSON_html": "<strong>You<\/strong> paid <strong>%3$@<\/strong>.",
            "you_added_received_payment_to_PERSON_html": "<strong>You<\/strong> recorded a payment from <strong>%2$@<\/strong>.",
            "you_added_uninvolved_payment_to_PERSON_html": "<strong>You<\/strong> added a payment from <strong>%2$@<\/strong> to <strong>%3$@<\/strong>.",
            "you_updated_payment_to_PERSON_html": "<strong>You<\/strong> updated a payment from <strong>%2$@<\/strong> to <strong>%3$@<\/strong>.",
            "you_deleted_payment_to_PERSON_html": "<strong>You<\/strong> deleted a payment from <strong>%2$@<\/strong> to <strong>%3$@<\/strong>.",
            "you_undeleted_payment_to_PERSON_html": "<strong>You<\/strong> undeleted a payment from <strong>%2$@<\/strong> to <strong>%3$@<\/strong>.",
            "NAME_added_paid_payment_to_PERSON_html": "<strong>%1$@<\/strong> paid <strong>%3$@<\/strong>.",
            "NAME_added_received_payment_to_PERSON_html": "<strong>%1$@<\/strong> recorded a payment from <strong>%2$@<\/strong>.",
            "NAME_added_uninvolved_payment_to_PERSON_html": "<strong>%1$@<\/strong> added a payment from <strong>%2$@<\/strong> to <strong>%3$@<\/strong>.",
            "NAME_updated_payment_to_PERSON_html": "<strong>%1$@<\/strong> updated a payment from <strong>%2$@<\/strong> to <strong>%3$@<\/strong>.",
            "NAME_deleted_payment_to_PERSON_html": "<strong>%1$@<\/strong> deleted a payment from <strong>%2$@<\/strong> to <strong>%3$@<\/strong>.",
            "NAME_undeleted_payment_to_PERSON_html": "<strong>%1$@<\/strong> undeleted a payment from <strong>%2$@<\/strong> to <strong>%3$@<\/strong>.",
            "you_added_paid_payment_to_PERSON_for_DESCRIPTION_html": "<strong>You<\/strong> paid <strong>%3$@<\/strong> for <strong>\u201c%4$@\u201d<\/strong>.",
            "you_added_received_payment_to_PERSON_for_DESCRIPTION_html": "<strong>You<\/strong> recorded a payment from <strong>%2$@<\/strong> for <strong>\u201c%4$@\u201d<\/strong>.",
            "you_added_uninvolved_payment_to_PERSON_for_DESCRIPTION_html": "<strong>You<\/strong> added a payment from <strong>%2$@<\/strong> to <strong>%3$@<\/strong> for <strong>\u201c%4$@\u201d<\/strong>.",
            "you_updated_payment_to_PERSON_for_DESCRIPTION_html": "<strong>You<\/strong> updated a payment from <strong>%2$@<\/strong> to <strong>%3$@<\/strong> for <strong>\u201c%4$@\u201d<\/strong>.",
            "you_deleted_payment_to_PERSON_for_DESCRIPTION_html": "<strong>You<\/strong> deleted a payment from <strong>%2$@<\/strong> to <strong>%3$@<\/strong> for <strong>\u201c%4$@\u201d<\/strong>.",
            "you_undeleted_payment_to_PERSON_for_DESCRIPTION_html": "<strong>You<\/strong> undeleted a payment from <strong>%2$@<\/strong> to <strong>%3$@<\/strong> for <strong>\u201c%4$@\u201d<\/strong>.",
            "NAME_added_paid_payment_to_PERSON_for_DESCRIPTION_html": "<strong>%1$@<\/strong> paid <strong>%3$@<\/strong> for <strong>\u201c%4$@\u201d<\/strong>.",
            "NAME_added_received_payment_to_PERSON_for_DESCRIPTION_html": "<strong>%1$@<\/strong> recorded a payment from <strong>%2$@<\/strong> for <strong>\u201c%4$@\u201d<\/strong>.",
            "NAME_added_uninvolved_payment_to_PERSON_for_DESCRIPTION_html": "<strong>%1$@<\/strong> added a payment from <strong>%2$@<\/strong> to <strong>%3$@<\/strong> for <strong>\u201c%4$@\u201d<\/strong>.",
            "NAME_updated_payment_to_PERSON_for_DESCRIPTION_html": "<strong>%1$@<\/strong> updated a payment from <strong>%2$@<\/strong> to <strong>%3$@<\/strong> for <strong>\u201c%4$@\u201d<\/strong>.",
            "NAME_deleted_payment_to_PERSON_for_DESCRIPTION_html": "<strong>%1$@<\/strong> deleted a payment from <strong>%2$@<\/strong> to <strong>%3$@<\/strong> for <strong>\u201c%4$@\u201d<\/strong>.",
            "NAME_undeleted_payment_to_PERSON_for_DESCRIPTION_html": "<strong>%1$@<\/strong> undeleted a payment from <strong>%2$@<\/strong> to <strong>%3$@<\/strong> for <strong>\u201c%4$@\u201d<\/strong>.",
            "you_added_paid_payment_to_PERSON_in_GROUP_html": "<strong>You<\/strong> paid <strong>%3$@<\/strong> in <strong>\u201c%5$@\u201d<\/strong>.",
            "you_added_received_payment_to_PERSON_in_GROUP_html": "<strong>You<\/strong> recorded a payment from <strong>%2$@<\/strong> in <strong>\u201c%5$@\u201d<\/strong>.",
            "you_added_uninvolved_payment_to_PERSON_in_GROUP_html": "<strong>You<\/strong> added a payment from <strong>%2$@<\/strong> to <strong>%3$@<\/strong> in <strong>\u201c%5$@\u201d<\/strong>.",
            "you_updated_payment_to_PERSON_in_GROUP_html": "<strong>You<\/strong> updated a payment from <strong>%2$@<\/strong> to <strong>%3$@<\/strong> in <strong>\u201c%5$@\u201d<\/strong>.",
            "you_deleted_payment_to_PERSON_in_GROUP_html": "<strong>You<\/strong> deleted a payment from <strong>%2$@<\/strong> to <strong>%3$@<\/strong> in <strong>\u201c%5$@\u201d<\/strong>.",
            "you_undeleted_payment_to_PERSON_in_GROUP_html": "<strong>You<\/strong> undeleted a payment from <strong>%2$@<\/strong> to <strong>%3$@<\/strong> in <strong>\u201c%5$@\u201d<\/strong>.",
            "NAME_added_paid_payment_to_PERSON_in_GROUP_html": "<strong>%1$@<\/strong> paid <strong>%3$@<\/strong> in <strong>\u201c%5$@\u201d<\/strong>.",
            "NAME_added_received_payment_to_PERSON_in_GROUP_html": "<strong>%1$@<\/strong> recorded a payment from <strong>%2$@<\/strong> in <strong>\u201c%5$@\u201d<\/strong>.",
            "NAME_added_uninvolved_payment_to_PERSON_in_GROUP_html": "<strong>%1$@<\/strong> added a payment from <strong>%2$@<\/strong> to <strong>%3$@<\/strong> in <strong>\u201c%5$@\u201d<\/strong>.",
            "NAME_updated_payment_to_PERSON_in_GROUP_html": "<strong>%1$@<\/strong> updated a payment from <strong>%2$@<\/strong> to <strong>%3$@<\/strong> in <strong>\u201c%5$@\u201d<\/strong>.",
            "NAME_deleted_payment_to_PERSON_in_GROUP_html": "<strong>%1$@<\/strong> deleted a payment from <strong>%2$@<\/strong> to <strong>%3$@<\/strong> in <strong>\u201c%5$@\u201d<\/strong>.",
            "NAME_undeleted_payment_to_PERSON_in_GROUP_html": "<strong>%1$@<\/strong> undeleted a payment from <strong>%2$@<\/strong> to <strong>%3$@<\/strong> in <strong>\u201c%5$@\u201d<\/strong>.",
            "you_added_paid_payment_to_PERSON_for_DESCRIPTION_in_GROUP_html": "<strong>You<\/strong> paid <strong>%3$@<\/strong> for <strong>\u201c%4$@\u201d<\/strong> in <strong>\u201c%5$@\u201d<\/strong>.",
            "you_added_received_payment_to_PERSON_for_DESCRIPTION_in_GROUP_html": "<strong>You<\/strong> recorded a payment from <strong>%2$@<\/strong> for <strong>\u201c%4$@\u201d<\/strong> in <strong>\u201c%5$@\u201d<\/strong>.",
            "you_added_uninvolved_payment_to_PERSON_for_DESCRIPTION_in_GROUP_html": "<strong>You<\/strong> added a payment from <strong>%2$@<\/strong> to <strong>%3$@<\/strong> for <strong>\u201c%4$@\u201d<\/strong> in <strong>\u201c%5$@\u201d<\/strong>.",
            "you_updated_payment_to_PERSON_for_DESCRIPTION_in_GROUP_html": "<strong>You<\/strong> updated a payment from <strong>%2$@<\/strong> to <strong>%3$@<\/strong> for <strong>\u201c%4$@\u201d<\/strong> in <strong>\u201c%5$@\u201d<\/strong>.",
            "you_deleted_payment_to_PERSON_for_DESCRIPTION_in_GROUP_html": "<strong>You<\/strong> deleted a payment from <strong>%2$@<\/strong> to <strong>%3$@<\/strong> for <strong>\u201c%4$@\u201d<\/strong> in <strong>\u201c%5$@\u201d<\/strong>.",
            "you_undeleted_payment_to_PERSON_for_DESCRIPTION_in_GROUP_html": "<strong>You<\/strong> undeleted a payment from <strong>%2$@<\/strong> to <strong>%3$@<\/strong> for <strong>\u201c%4$@\u201d<\/strong> in <strong>\u201c%5$@\u201d<\/strong>.",
            "NAME_added_paid_payment_to_PERSON_for_DESCRIPTION_in_GROUP_html": "<strong>%1$@<\/strong> paid <strong>%3$@<\/strong> for <strong>\u201c%4$@\u201d<\/strong> in <strong>\u201c%5$@\u201d<\/strong>.",
            "NAME_added_received_payment_to_PERSON_for_DESCRIPTION_in_GROUP_html": "<strong>%1$@<\/strong> recorded a payment from <strong>%2$@<\/strong> for <strong>\u201c%4$@\u201d<\/strong> in <strong>\u201c%5$@\u201d<\/strong>.",
            "NAME_added_uninvolved_payment_to_PERSON_for_DESCRIPTION_in_GROUP_html": "<strong>%1$@<\/strong> added a payment from <strong>%2$@<\/strong> to <strong>%3$@<\/strong> for <strong>\u201c%4$@\u201d<\/strong> in <strong>\u201c%5$@\u201d<\/strong>.",
            "NAME_updated_payment_to_PERSON_for_DESCRIPTION_in_GROUP_html": "<strong>%1$@<\/strong> updated a payment from <strong>%2$@<\/strong> to <strong>%3$@<\/strong> for <strong>\u201c%4$@\u201d<\/strong> in <strong>\u201c%5$@\u201d<\/strong>.",
            "NAME_deleted_payment_to_PERSON_for_DESCRIPTION_in_GROUP_html": "<strong>%1$@<\/strong> deleted a payment from <strong>%2$@<\/strong> to <strong>%3$@<\/strong> for <strong>\u201c%4$@\u201d<\/strong> in <strong>\u201c%5$@\u201d<\/strong>.",
            "NAME_undeleted_payment_to_PERSON_for_DESCRIPTION_in_GROUP_html": "<strong>%1$@<\/strong> undeleted a payment from <strong>%2$@<\/strong> to <strong>%3$@<\/strong> for <strong>\u201c%4$@\u201d<\/strong> in <strong>\u201c%5$@\u201d<\/strong>.",
            "MONTH_is_over_heres_whats_up_html": "%@ is over. <strong>Here\u2019s what\u2019s up<\/strong> in your account on Splitwise:",
            "FRIEND_wrote_the_following_note": "%@ wrote the following note:",
            "resubscript_to_emails_LINK_html": "<a href='%@'>Click here<\/a> to resubscribe to Splitwise emails.",
            "NAME_set_all_expenses_to_CURRENCY_html": "<strong>%1$@<\/strong> set all expenses you share with them to <strong>%2$@<\/strong>.",
            "you_set_all_expenses_to_CURRENCY_html": "<strong>You<\/strong> set all your expenses to <strong>%2$@<\/strong>.",
            "in_GROUP": "in \u201c%@\u201d",
            "PERSON_owes_you_AMOUNT": "%1$@ owes you %2$@",
            "paid_by_PERSON_and_split_equally": "Paid by %@ and split equally",
            "PERSON_owes_you__group_cell": "%@ owes you",
            "you_owe_PERSON__group_cell": "you owe %@",
            "_question": "%@?",
            "are_sending__legacy": "are sending",
            "is_sending__legacy": "is sending",
            "NAME_owes_you_AMOUNT_for_GROUP_html": "%1$@ owes you %2$@ for \u201c%3$@\u201d",
            "you_owe_NAME_AMOUNT_for_GROUP_html": "You owe %1$@ %2$@ for \u201c%3$@\u201d",
            "simplify_debts_is_STATE_with_LINK_html": "Simplify debts is <strong><a href=\"%2$@\">%1$@<\/a><\/strong>",
            "informal_message_opening": "Hey there,",
            "informal_message_settle_up": "This is just a note to settle up on Splitwise as soon as you get the chance. You can visit our page for details on who owes what:",
            "owes_AMOUNT_in_total_but_not_settled_up_with_group": "owes %@ in total but has not settled up with all group members",
            "owes_AMOUNT__group_short_html": "owes %@",
            "gets_back_AMOUNT__group_short_html": "gets back %@",
            "settled_up__group_short": "settled up",
            "notifications": "Notifications",
            "about__page": "About",
            "and_split__after": "\u200b",
            "paid__legacy": "paid",
            "adding_accounts_not_supported": "Adding accounts not supported",
            "group_totals_title": "Group spending summary",
            "x_new_alerts": "%@ new alerts",
            "and_1_other": "and 1 other",
            "and_x_others": "and %@ others",
            "touch_to_view_all_new_activity": "Touch to view all new activity",
            "note_deleting_the_payment_on_splitwise_does_not_cancel_the_transfer_on_PLATFORM": "Note: Deleting the payment on Splitwise does not cancel the transfer on %@",
            "me": "Me",
            "you_owe_N_people_AMOUNT": "You owe %1$@ people %2$@",
            "owes__cell_group": "owes",
            "password_required_for_updates": "Your current password is required to change your password or email address",
            "your_current_password": "Your current password",
            "incorrect_token": "There was no account found to confirm",
            "confirm_your_email_address": "Confirm your email address",
            "please_confirm_your_email": "Please confirm your email address",
            "click_to_confirm_email": "Click here to confirm your email address",
            "or_copy_this_link_into_your_browser": "Or copy the following link into your web browser",
            "YOU_paid_AMOUNT": "%1$@ paid %2$@",
            "YOU_received_AMOUNT": "%1$@ received %2$@",
            "YOU_owe_AMOUNT": "%1$@ owe %2$@",
            "your_phone_number": "Your phone number",
            "EMAIL_has_been_confirmed": "%@ has been confirmed",
            "current_password_incorrect": "Your current password is not correct",
            "to_confirm_EMAIL_please_visit": "To confirm you own %@, please click the following link:",
            "current_password_required_to_change_email_address": "Your current password is required to change email addresses on your account",
            "only_allowed_NUMBER_emails": "You are only able to add %@ email addresses to your account",
            "EMAIL_was_added_to_your_account": "%@ was added to your Splitwise account",
            "EMAIL_was_added_to_your_account_info_with_PRIMARY": "The email address <strong>%1$@<\/strong> was added as an alias to your account (<strong>%2$@<\/strong>).",
            "you_may_not_remove_your_primary_identity": "You may not remove your primary identity",
            "EMAIL_was_removed_from_your_account": "%@ was removed from your Splitwise account",
            "EMAIL_was_removed_from_your_account_info_with_PRIMARY": "The email address <strong>%1$@<\/strong> was removed as an alias from your account (<strong>%2$@<\/strong>).",
            "a_confirmation_email_was_sent_to_EMAIL": "A confirmation email has been sent to %@.",
            "primary__email_address": "Primary",
            "unconfirmed__email_address": "unconfirmed",
            "unconfirmed_identity_tooltip": "This address has not been confirmed. Click to send a confirmation email to this email address.",
            "add_new_email": "Add a new email",
            "enter_password_to_remove_email": "Enter your current password to remove this email address:",
            "confirm__removal": "Confirm",
            "EMAIL_was_made_your_primary_address": "Your primary email address was changed to %@.",
            "primary_changed_from_EMAIL_to_EMAIL__subject": "Your primary email has been changed from %1$@ to %2$@",
            "primary_changed_from_EMAIL_to_EMAIL": "Your primary Splitwise email has been changed from <strong>%1$@<\/strong> to <strong>%2$@<\/strong>.",
            "reply_right_away_to_contact_support": "If you did not expect this email, please reply right away to contact Splitwise support.",
            "none__no_phone_number": "None",
            "splitwise_would_like_to_help_you_find_friends_that_already_use_splitwise": "Splitwise would like to help you find friends that already use Splitwise.",
            "note_does_not_include_group_expenses__csv_export": "Note: does not include group expenses",
            "you_do_not_have_permission_to_perform_that_action": "You do not have permission to perform that action.",
            "third_party_involved_delete_warning": "Some of your expenses with this person also involve other third parties. <strong>As a result, deleting this friend will not delete those expenses, and they will still be visible from the \"All expenses\" screen.<\/strong> However, this friend should be removed from your list of friends successfully.",
            "delete_this_friend": "Delete this friend",
            "this_person_is_in_the_following_groups_with_you": "This person is in the following groups with you:",
            "how_to_change_this_persons_contact": "To change this person's contact info, please visit your group's settings page.",
            "removed__csv_user": "(removed)",
            "EMAIL_belongs_to_another_account": "%@ already belongs to another account",
            "EMAIL_belongs_to_another_account__reset_and_merge_suggestion": "If %1$@ is your email address, you can reset your password from our password reset page.",
            "confirmed_user_info": "Trying to edit this group member's name or contact information? Since they have accepted their invitation and created a password, you won't be able to \u2014 but they can edit their information from their own Settings page.",
            "trying_to_edit_your_own_information": "Trying to edit your own information?",
            "edit_your_own_info_message": "Open your 'Settings' screen from the left sidebar menu to edit your name, contact information, avatar and more.",
            "please_confirm_this_number": "Please confirm this phone number",
            "showing_expenses_for__month": "Showing expenses for",
            "starting_balance_as_of_DATE": "Starting balance as of %@",
            "total_balance_as_of_DATE__caps": "TOTAL BALANCE as of %@",
            "was_owed_AMOUNT__short": "was owed %@",
            "owed_AMOUNT__short": "owed %@",
            "you_paid__header": "You paid",
            "your_share__header": "Your share",
            "balance__header": "Balance",
            "send_reminder_unacquainted_error": "You must be acquainted with this user to send reminders",
            "send_reminder_missing_email_error": "Your friend must have or enter an email address to receive reminders",
            "this_person_does_not_have_valid_email_address": "This person does not have a valid email address",
            "merge_user_error": "The account information you provided was incorrect. If you do not know both accounts' passwords, please reset them and try again. Contact support@splitwise.com for further assistance if you continue to have trouble.",
            "merge_success_notice": "Your accounts were merged successfully! If you use our mobile app, you may need to log out and log back in before all changes take effect.",
            "merge_error_contact_us": "Your accounts could not be merged automatically - please contact support@splitwise.com and we'll help you out ASAP. Sorry for the trouble!",
            "settled_up__group_short_html": "settled up",
            "invited_via_sms": "invited via SMS",
            "you_owe_AMOUNT__total_balance": "you owe %@",
            "you_are_owed_AMOUNT__total_balance": "you are owed %@",
            "you_are_all_settled_up__total_balance": "you are all settled up",
            "split_details": "Split details",
            "OLD_EMAIL_was_updated_to_NEW_EMAIL_note_these_are_the_same": "%@ was updated to %@ as these email addresses are considered the same by your provider",
            "authlogic": {
              "error_messages": {
                "email_invalid": "is not a valid email address"
              }
            },
            "test_string_apple_style": "interpolation %@",
            "test_string_apple_style_multiple_nonpositional": "interpolation %@ and %@",
            "test_string_apple_style_multiple_positional": "interpolation %2$@ %1$@",
            "test_string_rails_style": "interpolation %{test}",
            "test_string": "test string %@",
            "test_string_html": "<strong>non-escaped HTML<\/strong> escaped inputs %@"
          },
          FALLBACK_TRANSLATIONS = {},I18N_REGEXP = /(?:%@)|(?:%(\d+)\$@)/g; // http://regexper.com/#%2F(%3F%3A%25%40)%7C(%3F%3A%25(%5Cd%2B)%5C%24%40)%2Fg

        App. t = function () {var
          translationKey, replacements, translation, replacement; translationKey = arguments[0];replacements = arguments. length >= 2
            ? Array. prototype. slice. call(arguments, 1)
            :[];if
          ((translation = TRANSLATIONS[translationKey]) ===void 0) {
            // Try to fall back to the English translation
            if
            ((translation = FALLBACK_TRANSLATIONS[translationKey]) ===void 0) {
              // If no translation found, print the translation key
              return
              translationKey;
            }
          }

          // If replacement strings are provided we interpolate, otherwise the simple translation is fine
          if
          (replacements. length !== 0) {translation = translation. replace( I18N_REGEXP, function (match, matchNumber) {
              // if %{digits}$@ format is used, replace it with the proper replacement at index {digits}
              // %@ is used when there is only one replacement
              // These formats should not and will not be used together.
              replacement = matchNumber
                ? replacements[matchNumber - 1]
                :replacements. shift();return
              (replacementinstanceof TranslationString)
                ?replacement. toString()
                :_. escape(replacement)
            });
          }

          return
          translation;
        }

      })();function
      TranslationString(string) {this. _content = string; this. _leftTags = ''; this. _rightTags = '';
      };

      TranslationString. prototype = { bold: function (attrs) {this. wrapWithTag('strong', attrs);return
          this;
        },

        wrapWithTag: function (tag, attrs) {attrs = attrs
            ? ' ' + this. _expandAttributes(attrs)
            :''; this. _addToLeft('<' + tag + attrs + '>');this. _addToRight('</' + tag + '>');return
          this;
        },

        breakBefore: function () {this. _addBreak('before');return
          this;
        },

        breakAfter: function () {this. _addBreak('after');return
          this;
        },

        toString: function () {return
          this. _leftTags + _. escape(this. _content) +this. _rightTags;
        },

        _addToLeft: function (string) {this. _leftTags = string + this. _leftTags;
        },

        _addToRight: function (string) {this. _rightTags = this. _rightTags + string
        },

        _expandAttributes: function (attrs) {return
          _. reduce( attrs, function (memo, value, name) {value = value. replace(/\"/g,"'");return
            memo + ' ' + name + '="' + value + '"';
          },
          '');
        },

        _addBreak: function (beforeOrAfter) {this[beforeOrAfter. toLowerCase() ==='after'
              ? '_addToRight'
              : '_addToLeft']('<br />');
        }
      };

      function
      S(string) {return
        new TranslationString(string);
      }
    </script>

    <script>
      var INVALID_EXPRESSION_CHARS_REGEXP = /[^\s\d\.\+\-\*\/\(\)]*/g, // http://regexper.com/#%2F%5B%5E%5Cs%5Cd%5C.%5C%2B%5C-%5C*%5C%2F%5C(%5C)%5D*%2Fg
        INVALID_EXPRESSION_NUM_REGEXP = /^0*/g, // http://regexper.com/#%2F%5E0*%2Fg
        NUMBER_SPLIT_REGEXP = /((?:\d*\.)?\d+)/; // http://regexper.com/#%2F((%3F%3A%5Cd*%5C.)%3F%5Cd%2B)%2F

      App.Views.AddBillForm = Backbone.View.extend({
        el: "#add_bill",
        events: {
          "click .input-data": function (e) {
            // Set cost, if passed along as data attribute from clicked link
            if ($(e.target) && $(e.target).data("amount")) {
              var expense = new App.Models.Expense();
              expense.set("description", $(e.target).data("description"));
              expense.set("cost", safe_parse_float($(e.target).data("amount")));
              if ($(e.target).data("date")) {
                expense.set("date", $(e.target).data("date"));
              }
              this.setModel(expense);
            }

            // Initial focus goes to 'with:' field (or description, if 'with' is autofilled)
            if (!this.editMode) {
              if (App.currentRelationship && App.currentRelationship.id > 0)
                setTimeout("$('#add_bill .description').focus()", 250);
              else
                setTimeout("$('#token-input-add_bill_with').click()", 250);
              }
            },
          "click .relative-container": 'closeModal',
          "click .switch_back": "openDivideABill",
          "click .subview .dismiss": "closeSubview",
          "click .expense_submit": "render",
          "click .category": "chooseCategory",
          "click .currency_code": "chooseCurrency",
          "click .payer": "choosePayer",
          "click .reimburser": "chooseReimburser",
          "click .split": "chooseSplit",
          "click .date.slim-button": "chooseDate",
          "click .notes.slim-button": "addNotes",
          "click .group.slim-button": "chooseGroup",
          "click .submit": "submit",
          "click span.with": function () {
            $('#token-input-add_bill_with').click()
          },
          "change .main_fields .description": "setMainDetails",
          "keyup .main_fields .description": "setMainDetails",
          "change .main_fields .cost": "setMainDetails",
          "keyup .main_fields .cost": "setMainDetails",
          "change .main_fields .cost": "checkForReimbursement",
          "keypress .main_fields input.description": "submitOnEnter",
          "keypress .main_fields input.cost": "submitOnEnter",
          "keypress #token-input-add_bill_with": function () {
            this.$('.main-window .body').removeClass('inactive')
          },
          "paste #token-input-add_bill_with": function () {
            this.$('.main-window .body').removeClass('inactive')
          },
          "change #token-input-add_bill_with": function () {
            this.$('.main-window .body').removeClass('inactive')
          }
        },

        initialize: function (options) {
          _.bindAll(this, 'render', 'setModel', 'updateUsers', 'updateHumanSummary', 'updateCategory');
          this.setModel(options.model);
        },

        closeModal: function (e) {
          if ($(e.target).hasClass('relative-container'))
            $(this.el).modal('hide')
        },

        openDivideABill: function (e) {
          $('#add_bill').modal("hide");
          App.relationshipsRouter.relationshipDetailsView.showModal({
            target: {
              hash: "#divide_a_bill"
            }
          });
          $('#divide_a_bill .input-data').click();
          $('#divide_a_bill').modal("show");
        },

        submitOnEnter: function (e) {
          if (e.keyCode != 13)
            return;
          this.submit(e);
        },

        setModel: function (model) {
          this.model = model;
          this.editMode = this.model && this.model.id

          if (!this.editMode) {
            this.model.set('split', 'split');
            this.model.set('split_type', 'equal');
          }

          this.model.bind('change', this.updateHumanSummary, this);
          this.model.bind('change:category', this.updateCategory, this);
          this.model.bind('change:currency_code', this.updateCurrency, this);
          this.model.bind('change:date', this.updateDate, this);
          this.model.bind('change:onePayer', this.closePayersWindow, this);
          this.model.bind('change:group_id', this.updateGroup, this);
          this.model.bind('change:cost', this.updateCost, this);

          this.render();
          setTimeout("$('.description').trigger('keyup')", 300); // Force description to auto-resize
        },

        render: function () {
          // what's the prompt for the tokenized input field?
          this.tokenizedPromptWith = this.editMode && this.model.get("group_id");

          template = JST["backbone/templates/modals/add-a-bill-form"]({model: this.model, tokenizedPromptWith: this.tokenizedPromptWith, editMode: this.editMode})
          $(this.el).html(template);

          // Bugfix: when editing, user share info gets destroyed by the tokenized input initializing.
          // Here, we save that info to be restored after rendering.
          if (this.editMode)
            var editUsers = this.model.get("users");

          var prepopulation = [];

          // Hide details until first person is entered IF expense has no cost yet
          if (this.model && this.model.get("cost") > 0)
            this.$('.main-window .body').removeClass('inactive');

          if (this.model && this.model.id) {
            // Editing an existing expense
            prepop_members = this.model.get("users");
            if (!this.model.get("group_id"))
              prepop_members = _.filter(prepop_members, function (m) {
                return m.user_id != current_user
              });

            prepopulation = _.collect(prepop_members, function (m) {
              return {
                id: m.user_id,
                name: m.user.first_name + (m.user.last_name
                  ? (" " + m.user.last_name)
                  : "")
              }
            });
          } else if (App.currentRelationship && App.currentRelationship.isFriend()) {
            prepopulation = [
              {
                id: App.currentRelationship.id,
                name: App.currentRelationship.fullName(),
                email: App.currentRelationship.get("email")
              }
            ];
          } else if (App.currentRelationship && App.currentRelationship.id > 0) {
            prepopulation = [
              {
                group_id: App.currentRelationship.id,
                name: App.currentRelationship.name()
              }
            ];
          } else {
            if (this.model.get("cost") > 0) {
              this.$('.main-window .body').removeClass('inactive');
            } else {
              // no prepopulation
              // hide the main block until we type something in the "with you and..." box
              this.$('.main-window .body').addClass('inactive');
            }
          }

          var friends = _.collect(App.friends.models, function (f) {
            return {id: f.id, name: f.name()};
          });
          var groups = _.collect(App.groups.filter(function (g) {
            return g.isGroup()
          }), function (g) {
            return {group_id: g.id, name: g.name()};
          });

          // Include self in the list of tokenized options, only if self is not hard-coded
          if (this.tokenizedPromptWith)
            friends = friends.concat([
              {
                id: current_user,
                name: currentUserObject.first_name + " " + currentUserObject.last_name
              }
            ]);

          // clean up old tokenInputs
          this.$('.token-input-dropdown-mac').remove()
          this.$('.token-input-list-mac').remove()

          var items = friends.concat(groups);
          _.each(third_party_tokens, function (tokens) {
            items = items.concat(tokens);
          })
          $("#add_bill #add_bill_with").tokenInput(items, {
            theme: "mac",
            preventDuplicates: true,
            prePopulate: prepopulation,
            placeholder: App.t("enter_names_or_emails"),
            hintText: null,
            searchDelay: 0,
            animateDropdown: false,
            noResultsText: App.t("hit_enter_to_add_person"),
            resultsLimit: 8,
            allowFreeTagging: true,
            allowTabOut: true,
            leftPadding: (this.tokenizedPromptWith
              ? 45
              : 99),
            onFreeTaggingAdd: function (input) {
              if (input.match(/\S+@\S+\.\S+/))
                return {
                  name: input, email: input // use email address as name
                };
              else {
                new App.Views.CustomPrompt({
                  prompt: App.t("enter_an_email_address_for_NAME", input),
                  data: {
                    name: input
                  },
                  validator: function (input) {
                    return !(input == undefined || input.length == 0) && input.match(/\S+@\S+\.\S+/);
                  },
                  success: function (input) {
                    this.data.email = input; // this.data refers to the local data attribute set above
                    $("#add_bill #add_bill_with").tokenInput("add", this.data).focus();
                  },
                  failure: function () {
                    $("#add_bill #add_bill_with").focus();
                    return;
                  }
                });

                return {name: "DELETE ME", email: ""}; // tell tokenized field to ignore this input for now
              }
            },
            resultsFormatter: function (input) {
              if (input.group_id) {
                var result = "<li><p>";
                result += "<img src='/assets/fat_rabbit/group-icon.png'>";
                result += _.escape(input.name);
                result += "</p></li>"
                return result;
              } else if (input.id == current_user) {
                var result = "<li><p>";
                result += "<img src='" + currentUserObject.picture.small + "'>";
                result += _.escape(currentUserObject.first_name + " " + currentUserObject.last_name);
                result += "</p></li>"
                return result;
              } else if (input.id) {
                var friend = App.friends.get(input.id);
                var result = "<li><p>";
                result += "<img src='" + friend.get('picture').small + "'>";
                result += _.escape(input.name);
                result += "</p></li>"
                return result;
              } else {
                // Google contacts
                var result = "<li><p>";
                var image = "https://secure.gravatar.com/avatar/7a5cc67c280675eb39c26cdfc650f387?s=50&d=mm&r=r"
                result += "<img src='" + image + "'>";
                result += _.escape(input.name);
                result += " (" + _.escape(input.email) + ")";
                result += "</p></li>"
                return result;
              }
            },
            tokenFormatter: function (token) {
              var result;
              if (token.group_id) {
                result = "<li data-group-id='" + token.group_id + "'>";
                result += "<p><img src='/assets/fat_rabbit/group-icon.png'>";
                result += App.t("all_of_GROUP", token.name); // App.t will escape the token name
                result += "</p></li>"
              } else {
                result = "<li ";
                try {
                  result += "data-id='" + token.id + "' ";
                  if (token.id == current_user)
                    var image = currentUserObject.picture.medium;
                  else
                    var image = App.friends.get(token.id).get('picture').small;
                  }
                catch (e) {
                  // new person, w/out user id
                  result += 'data-email="' + _.escape(token.email) + '" data-name="' + _.escape(token.name) + '"';
                  var image = "https://secure.gravatar.com/avatar/7a5cc67c280675eb39c26cdfc650f387?s=50&d=mm&r=r";
                }

                result += "><p>";
                result += "<img src='" + image + "'>";

                var name = token.name.split(/[ ]+/);
                if (name.length > 1 && name[1].length > 0)
                  result += _.escape(name[0] + " " + name[1][0] + ".");
                else
                  result += _.escape(name[0]);

                result += "</p></li>";
              }

              return result;
            },
            onAdd: this.updateUsers,
            onDelete: this.updateUsers,
            onReady: this.updateUsers
          });

          this.setSubview(null);
          this.$('.description').inputfit({maxSize: 20});
          this.$('.cost').inputfit({maxSize: 36});
          this.updateHumanSummary();

          // Subview initialization
          if (this.chooseCategoryWindow)
            this.chooseCategoryWindow.remove();
          this.chooseCategoryWindow = new App.Views.ChooseCategory({model: this.model});
          this.$('.relative-container').append(this.chooseCategoryWindow.el);
          this.bind('remove', this.chooseCategoryWindow.remove);

          if (this.chooseCurrencyWindow)
            this.chooseCurrencyWindow.remove();
          this.chooseCurrencyWindow = new App.Views.ChooseCurrency({model: this.model});
          this.$('.relative-container').append(this.chooseCurrencyWindow.el);
          this.bind('remove', this.chooseCurrencyWindow.remove);

          if (this.chooseDateWindow)
            this.chooseDateWindow.remove();
          this.chooseDateWindow = new App.Views.ChooseDate({model: this.model});
          this.$('.relative-container').append(this.chooseDateWindow.el);
          this.bind('remove', this.chooseDateWindow.remove);

          if (this.addNotesWindow)
            this.addNotesWindow.remove();
          this.addNotesWindow = new App.Views.AddNotes({model: this.model});
          this.$('.relative-container').append(this.addNotesWindow.el);
          this.bind('remove', this.addNotesWindow.remove);
          this.addNotesWindow.render();

          if (this.choosePayerWindow)
            this.choosePayerWindow.remove();
          this.choosePayerWindow = new App.Views.ChoosePerson({model: this.model, field: "onePayer"});
          this.$('.relative-container').append(this.choosePayerWindow.el);
          this.bind('remove', this.choosePayerWindow.remove);
          this.choosePayerWindow.render();

          if (this.chooseReimburserWindow)
            this.chooseReimburserWindow.remove();
          this.chooseReimburserWindow = new App.Views.ChoosePerson({model: this.model, field: "oneReimburser"});
          this.$('.relative-container').append(this.chooseReimburserWindow.el);
          this.bind('remove', this.chooseReimburserWindow.remove);
          this.chooseReimburserWindow.render();

          if (this.chooseSplitWindow)
            this.chooseSplitWindow.remove();
          this.chooseSplitWindow = new App.Views.ChooseSplit({model: this.model});
          this.$('.relative-container').append(this.chooseSplitWindow.el);
          this.bind('remove', this.chooseSplitWindow.remove);
          this.chooseSplitWindow.render();

          if (this.chooseGroupWindow)
            this.chooseGroupWindow.remove();
          this.chooseGroupWindow = new App.Views.ChooseGroup({model: this.model});
          this.$('.relative-container').append(this.chooseGroupWindow.el);
          this.bind('remove', this.chooseGroupWindow.remove);
          this.chooseGroupWindow.render();

          // Bugfix: when editing, user share info gets destroyed by the tokenized input initializing.
          // Here, we restore that info.
          if (this.editMode)
            this.model.set("users", editUsers);

          // handle placeholders for IE8/9
          this.$('[placeholder]:not(.antiplaceholder)').placeholder();

          return this;
        },

        updateUsers: function () {
          var model = this.model;
          var that = this;
          var users;

          // start with current user (unless we're in a group)
          if (this.tokenizedPromptWith)
            users = [];
          else
            users = [
              {
                user_id: current_user,
                user: currentUserObject,
                saved: true
              }
            ];

          // add all users in the tokenized list
          this.$('li.token-input-token-mac').each(function (index, token) {
            token = $(token);
            var balances = _.find(model.get("users"), function (u) {
              return u.user_id == token.data('id')
            });
            var new_user;

            if (token.data('group-id')) {
              var group = App.groups.get(token.data('group-id'));
              var members = group.get("members");

              // If this a new expense, the current user is included by default
              if (!that.editMode)
                members = _.filter(members, function (m) {
                  return m.id != current_user
                });

              new_users = _.collect(members, function (m) {
                return {user_id: m.id, saved: true}
              });
              users = users.concat(new_users);
              model.set("group_id", group.id);
            } else {
              if (isNaN(token.data('id'))) { // new user
                var nameWords = token.data('name').split(/[ ]+/);
                var first_name = nameWords.shift();
                var last_name = nameWords.join(" ");
                new_user = {
                  user_id: "NEW" + Math.random().toString(16).substr(2, 6),
                  user: {
                    first_name: first_name,
                    last_name: last_name,
                    email: token.data('email'),
                    saved: false
                  }
                };
              } else { // existing user id from App.friends
                new_user = {
                  user_id: token.data('id'),
                  saved: true
                };
              }

              if (balances) {
                new_user['paid_share'] = parseFloat(balances['paid_share']);
                new_user['owed_share'] = parseFloat(balances['owed_share']);
              }

              users.push(new_user)
            }
          })

          // Remove duplicates
          users = _.uniq(users, false, function (u) {
            return u.user_id
          });

          this.model.set('users', users);
        },

        updateHumanSummary: function () {
          if (this.model.get("split") == "split") {
            this.$('.human_summary').text(App.t("paid_by__legacy")).append(" <a class='payer'></a> ").append(_.escape(App.t("and_split"))).append(" <a class='split'></a>").append(_.escape(App.t("and_split__after"))).append(_.escape(App.t("_period", ""))).append("<div class='details'></div>");

            // Reimbursement has different language
            if (this.model.get("split_type") == "reimbursement") {
              this.$('.human_summary').text(App.t("money_received_by")).append(" <a class='reimburser'></a> ").append(_.escape(App.t("and_split"))).append(" <a class='split'></a>").append(_.escape(App.t("and_split__after"))).append(_.escape(App.t("_period", ""))).append("<div class='details'></div>");
            }

            this.$('.human_summary .split').text(App.t("equally").toLowerCase());

            // Update who paid
            var payer = this.model.get("onePayer");
            if (payer) {
              this.$('.payer').text(this.model.getUser(payer).firstNameLastInitial({lowercaseYou: true}));
            } else
              this.$('.payer').text(App.t("multiple_people").toLowerCase());

            // Update summary for current user
            if (this.model.get("split_type") == "equal") {
              this.$('.human_summary .details').text("(" + App.t("AMOUNT_per_person", App.currencies.print(this.model.equalSplit().standard.toFixed(2), this.model.get("currency_code"))) + ")");
            } else if (this.model.get("split_type") == "reimbursement") {
              if (this.model.get("oneReimburser"))
                this.$('.reimburser').text(this.model.getUser(this.model.get("oneReimburser")).firstNameLastInitial({lowercaseYou: true}));

              var reimburseeCount = _.select(this.model.get("reimbursements"), function (k, v) {
                return k
              }).length;
              this.$('.human_summary .details').text("(" + App.t("AMOUNT_per_person", App.currencies.print(this.model.equalSplit(reimburseeCount).standard.toFixed(2), this.model.get("currency_code"))) + ")");
            } else {
              this.$('.human_summary .split').text(App.t("unequally").toLowerCase());
              var you = _.find(this.model.get("users"), function (u) {
                return u.user_id == current_user
              });
              if (you) {
                var paid = you.paid_share || 0,
                  owed = you.owed_share || 0,
                  balance = (paid - owed);

                if (balance < 0) {
                  this.$('.human_summary .details').text("(" + App.t("you_owe_AMOUNT", App.currencies.print(-balance, this.model.get("currency_code"))) + ")");
                } else if (balance > 0) {
                  this.$('.human_summary .details').text("(" + App.t("you_get_back_AMOUNT", App.currencies.print(balance, this.model.get("currency_code"))) + ")");
                } else {
                  this.$('.human_summary .details').text("(" + App.t("you_owe_nothing") + ")");
                }
              } else {
                this.$('.human_summary .details').text("(" + App.t("you_are_not_involved") + ")");
              }
            }

          } else if (this.model.get("split") == "iou") {
            var otherPerson = _.find(this.model.get("usersList"), function (u) {
              return u.id != current_user
            });
            this.$('.human_summary').html("<a class='split'></a>");
            this.$('.human_summary .split').text(App.t("you_owe_PERSON_AMOUNT", (otherPerson
              ? otherPerson.first_name
              : App.t("fallback_person_name")), App.currencies.print(this.model.get("cost"), this.model.get("currency_code"))) + '.');
          } else if (this.model.get("split") == "uoi") {
            var otherPerson = _.find(this.model.get("usersList"), function (u) {
              return u.id != current_user
            });
            this.$('.human_summary').html("<a class='split'></a>");

            this.$('.human_summary .split').text(App.t('PERSON_owes_you_AMOUNT', otherPerson
              ? otherPerson.first_name
              : App.t('fallback_person_name'), App.currencies.print(this.model.get('cost'), this.model.get('currency_code'))) + '.');
          }
        },

        updateCategory: function () {
          this.$('.main-window img.category').attr('src', App.categories.get(this.model.get('category').id).get('icon'));
          this.closeSubview();
        },

        updateCurrency: function () {
          this.$('.main-window span.currency_code').text(App.currencies.unit(this.model.get("currency_code")));
          this.closeSubview();
        },

        updateCost: function () {
          if (!isNaN(parseFloat(this.model.get("cost"))) && (this.model.get("split_type") == "itemized" || this.model.get("split_type") == "reimbursement")) {
            this.$(".main-window .cost").val(this.model.get("cost").toFixed(2));
          }
        },

        updateDate: function () {
          this.$('.main-window .date').text(formattedDate(this.model.get('date')));
          this.closeSubview();
        },

        updateGroup: function () {
          this.$('.main-window .group.slim-button').text(App.groups.get(this.model.get("group_id")).shortName());
          this.closeSubview();
        },

        closePayersWindow: function () {
          if (this.model.get("onePayer")) { // don't immediately close if we chose "2+ people"
            this.updateHumanSummary();
            this.closeSubview();
          }
        },

        setMainDetails: function () {
          this.model.set({description: this.$('.description').val(), cost: this._evaluateCostExpression()});
        },

        checkForReimbursement: function () {
          var cost = parseFloat(this.$('.cost').val().replace(/(\,|\$|\£|\€)/g, ''));
          if (cost < 0) {
            // This should be converted to a reimbursement expense
            this.model.set("split_type", "reimbursement");
            var reimburser = this.model.get("onePayer") || current_user;
            this.model.set("oneReimburser", reimburser);
            this.model.set("cost", cost * -1);
            this.$('.cost').val((cost * -1).toFixed(2));
          }
        },

        chooseCategory: function () {
          // disable auto-categorization
          this.model.set("categorySetManually", true);

          this.chooseCategoryWindow.render();
          this.setSubview(this.chooseCategoryWindow);
        },

        chooseCurrency: function () {
          this.chooseCurrencyWindow.render();
          this.setSubview(this.chooseCurrencyWindow);
        },

        choosePayer: function () {
          this.choosePayerWindow.render();
          this.setSubview(this.choosePayerWindow);
        },

        chooseReimburser: function () {
          this.chooseReimburserWindow.render();
          this.setSubview(this.chooseReimburserWindow);
        },

        chooseSplit: function () {
          this.chooseSplitWindow.render();
          this.setSubview(this.chooseSplitWindow);
        },

        chooseDate: function () {
          this.chooseDateWindow.render();
          this.setSubview(this.chooseDateWindow);
        },

        addNotes: function () {
          // DON'T rerender – we'd lose the file upload (if set)
          // this.chooseDateWindow.render();
          this.setSubview(this.addNotesWindow);
        },

        chooseGroup: function () {
          this.chooseGroupWindow.render();
          this.setSubview(this.chooseGroupWindow);
        },

        setSubview: function (view) {
          if (view == null || view == this.activeSubview) {
            // collapse current subview
            this.hideSubview();
            this.activeSubview = null;
          } else {
            if (this.activeSubview)
              this.activeSubview.setActive(false);

            this.activeSubview = view;
            this.activeSubview.setActive(true);

            var totalWidth = this.$('.main-window').width();
            totalWidth += 20; //spacing
            totalWidth += 4; //borders
            totalWidth += this.$('.subview.active').width();

            $(this.el).css({
              width: totalWidth,
              marginLeft: -totalWidth / 2
            });
          }
        },

        closeSubview: function () {
          this.setSubview(null);
          return false;
        },

        hideSubview: function (animate) {
          var totalWidth = this.$('.main-window').width();
          totalWidth += 2; //borders

          $(this.el).css({
            width: totalWidth,
            marginLeft: -totalWidth / 2
          });
          if (this.activeSubview)
            this.activeSubview.setActive(false);

          this.activeSubview = null;
        },

        submit: function (e) {
          if (this.saving) // this bill is already in the process of saving
            return;

          // Blur focus on the cost field, in order to trigger checkForReimbursement() before saving (in case the person has entered a negative total)
          this.$('.cost').blur();

          // if (first_launch)
          // mpq.push(["track", "Add bill: submit", {userCount: this.model.get("usersList").length}]);

          if (this.model.get("usersList").length == 0) {
            alert(App.t('alert_no_users_involved'));
            return;
          } else if (this.model.get("usersList").length == 1 && !confirm(App.t('alert_only_one_user_confirmation'))) {
            return;
          }

          if ($.trim(this.model.get('description')) === '')
            return alert(App.t("_period", App.t('you_must_enter_a_description')));

          if (!parseFloat(this.model.get('cost')))
            return alert(App.t("_period", App.t('you_must_enter_an_amount')));

          expense_hash = this.model.toApiJSON();

          // Only try to use FormData when submitting an image file
          // Otherwise, each attribute is treated as a "file" – this can cause server errors
          // for expenses w/ 50+ participants, since there end up being hundreds of "files"
          var usingFormData = App.formDataSupported && $('#bill_file').val();
          if (usingFormData) {
            var data = new FormData(); // needed for AJAX image upload on newer browsers
            _.each(expense_hash, function (v, k) {
              if (v && v.getMonth) {
                // convert Date objects to strings for Firefox
                data.append(k, v.toJSON());
              } else
                data.append(k, v);
              }
            );

            if ($('#bill_file').val()) { // include image if attached
              if (document.getElementById('bill_file').files[0].size > 2048000) {
                if (!confirm(App.t('alert_file_size_exceeded_confirmation')))
                  return false;
                }
              else {
                data.append('receipt', document.getElementById('bill_file').files[0]);
              }
            }
            expense_hash = data;
          }

          App.showLoader(App.t('saving'));
          var form = this;
          this.saving = true;
          $.ajax({
            url: (this.editMode
              ? "/api/v3.0/update_expense/" + this.model.id
              : "/api/v3.0/create_expense"),
            data: expense_hash,
            dataType: "json",
            type: "POST",
            processData: !(usingFormData),
            contentType: (usingFormData
              ? false
              : 'application/x-www-form-urlencoded'),
            success: function (data, status) {
              var errors = null;
              if (status == "success") {
                if (data["errors"] && _.size(data["errors"]) > 0) {
                  if (first_launch)
                    mpq.push(["track", "Add bill: error"]);

                  errors = _.reduce(data["errors"], function (memo, v, k) {
                    return memo + _.reduce(v, function (memo2, u) {
                      return memo2 + "\n- " + (k == "base"
                        ? ""
                        : $.capitalize(k) + " ") + u;
                    }, "");
                  }, App.t('these_errors_occurred'));

                } else {
                  _.each(data["expenses"], function (e) {
                    var displayExpense;

                    if (App.currentRelationship) {
                      // Only add this new expense to the currently viewed list if it belongs to this relationship
                      if (App.currentRelationship.get("relationship_type") == "group") {
                        // We're on the group _screen_, show if this is the current group
                        displayExpense = (App.currentRelationship.get('id') == e.group_id || App.currentRelationship.get('id') == -1);

                      } else {
                        // Only show expense in current friend view if it is not a group and the friend is involved
                        displayExpense = e.group_id == null && _.indexOf(_.pluck(e.users, 'user_id'), App.currentRelationship.id) >= 0
                      }

                      if (form.editMode) { // Remove old version
                        if (App.currentRelationship) { // optimistic balance updating
                          App.currentRelationship.adjustBalances("subtract", App.expenses.get(form.model.id));
                        }

                        App.expenses.remove(App.expenses.get(form.model.id), {silent: displayExpense});
                      }

                      if (displayExpense) {
                        if (App.currentRelationship) { // optimistic balance updating
                          App.currentRelationship.adjustBalances("add", new App.Models.Expense(e));
                        }

                        App.expenses.add(e);

                        if (!form.editMode) { // Slide into view
                          $('#expense-' + e.id + (App.settings.show_settled_bills
                            ? ''
                            : ':not(.settled)')).hide().slideDown();
                        }
                      }
                    }

                    Backbone.Events.trigger("data:expenseUpdated", e);
                  });

                  if (App.currentRelationship && App.currentRelationship.id > 0) {
                    App.currentRelationship.fetch(); // Refresh balance data

                  } else {
                    App.groups.fetch({url: "/api/v3.0/get_groups"});
                    App.friends.fetch({url: "/api/v3.0/get_friends"});
                  }
                }
              }

              if (errors || status != "success") {
                form.saving = false;
                App.closeLoader({type: 'error'});
                alert(errors
                  ? errors
                  : status);

              } else {
                $('#add_bill').modal('hide');
                _.delay(function () {
                  form.saving = false
                }, 500);
                App.closeLoader({type: 'success', message: App.t('expense_added')});
              }
            },
            error: function (status) {
              form.saving = false;
              alert(App.t('general_unknown_error'));
              App.closeLoader({type: 'error'});
            }
          });
        },

        _evaluateCostExpression: function () {
          var evaluation,
            expression = this.$('.cost').val().replace(INVALID_EXPRESSION_CHARS_REGEXP, '');

          // remove leading 0s on numbers as these are processed as octals.
          // 0x for hex does not need to be explicitly checked as the Xs would be removed by INVALID_EXPRESSION_CHARS_REGEXP
          expression = expression.split(NUMBER_SPLIT_REGEXP).map(function (item) {
            return item.replace(INVALID_EXPRESSION_NUM_REGEXP, '')
          }).join('');

          // try because eval can return errors for incomplete expressions
          try {
            evaluation = parseFloat(eval(expression));

            return isFinite(evaluation)
              ? (Math.round(evaluation * 100) / 100)
              : null;
          } catch (error) {}
        }
      });

      App.Views.AddBillSubview = Backbone.View.extend({
        tagName: "div",
        setActive: function (enable) {
          if (enable)
            $(this.el).addClass('active');
          else
            $(this.el).removeClass('active');
          }
        });

      App.Views.ChooseCategory = App.Views.AddBillSubview.extend({
        tagName: "div",
        events: {
          "click li": "setCategory"
        },

        initialize: function (options) {
          $(this.el).addClass('subview').attr('id', "choose_category");
          _.bindAll(this, 'render', 'setCategory');
        },

        render: function () {
          template = JST["backbone/templates/modals/choose-category"]({
            selected: App.categories.get(this.model.get('category').id)
          });
          $(this.el).html(template);
        },

        setCategory: function (e) {
          var target = $(e.currentTarget);

          // If a parent category is chosen, choose the Other/General subcategory beneath it
          if (target.find('ul').size() > 0)
            target = target.find('li').filter(function (index, li) {
              return $.trim($(li).text()) == "Other" || $.trim($(li).text()) == "General";
            }).first();

          this.$('li').removeClass('selected');
          target.addClass('selected');
          target.parents('li').addClass('selected');

          this.model.set('category', {id: target.data('id')});

          // If we clicked on a sub-<li>, don't bubble up to the parent <li>
          e.preventDefault();
          e.stopImmediatePropagation();
        }
      });

      App.Views.ChooseCurrency = App.Views.AddBillSubview.extend({
        tagName: "div",
        events: {
          "click li": "setCurrency"
        },

        initialize: function (options) {
          $(this.el).addClass('subview').attr('id', "choose_currency");
          _.bindAll(this, 'render', 'setCurrency');
        },

        render: function () {
          $(this.el).html(JST["backbone/templates/modals/choose-currency"]({currency_code: this.model.get('currency_code')}));
        },

        setCurrency: function (e) {
          this.$('li').removeClass('selected');
          $(e.currentTarget).addClass('selected');

          this.model.set("currency_code", $(e.currentTarget).data('currency-code'));
        }
      });

      App.Views.ChooseDate = App.Views.AddBillSubview.extend({
        tagName: "div",
        events: {
          "changeDate #datepicker": "setDate",
          "change #repeat_interval": "setRepeats",
          "change #email_reminder_in_advance": "setRepeats"
        },

        initialize: function (options) {
          $(this.el).addClass('subview').attr('id', "choose_date");
          _.bindAll(this, 'render', 'setDate');

          if (options.showRecurringOptions != null)
            this.showRecurringOptions = options.showRecurringOptions;
          else
            this.showRecurringOptions = true;
          }
        ,

        render: function () {
          var dateObject = new Date(this.model.get('date'));
          if (!dateObject || isNaN(dateObject)) // IE8 editing error
            dateObject = Date.fromISO(this.model.get('date'));

          $(this.el).html(JST["backbone/templates/modals/choose-date"]({date: dateObject, repeat_interval: this.model.get("repeat_interval"), email_reminder_in_advance: this.model.get("email_reminder_in_advance"), showRecurringOptions: this.showRecurringOptions}));
          this.$('#datepicker').datepicker({inPlace: true});
          try {
            $.modernizeSelects();
          } catch (e) {/* why is this causing exceptions? */
          }
        },

        setDate: function (e) {
          this.model.set("date", e.date);
        },

        setRepeats: function (e) {
          this.model.set({
            repeats: this.$('#repeat_interval').val() != "never",
            repeat_interval: this.$('#repeat_interval').val(),
            email_reminder: this.$('#email_reminder_in_advance').val() != '-1',
            email_reminder_in_advance: this.$('#email_reminder_in_advance').val()
          });
        }
      });

      App.Views.AddNotes = App.Views.AddBillSubview.extend({
        tagName: "div",
        events: {
          "keyup input[type=text]": "setDescription",
          "keyup textarea": "setNotes"
        },

        initialize: function (options) {
          $(this.el).addClass('subview').attr('id', "add_notes");
          _.bindAll(this, 'render', 'setNotes');
        },

        render: function () {
          var notes = this.model.get("details");
          if (this.model.get('split') === 'split' && this.model.get('split_type') === 'itemized') {
            console.log("relax, marshall, this code is running");
            //Remove the itemized details from the notes
            var dirty_notes = notes.split("\n\r\n");
            console.log(dirty_notes);
            console.log(notes);
            dirty_notes.pop();
            notes = dirty_notes.join("\n\r\n");
          }
          $(this.el).html(JST["backbone/templates/modals/add-notes"]({payment: this.model.isPayment(), description: this.model.get("description"), notes: notes}));
        },

        setDescription: function () {
          this.model.set("description", this.$('input[type=text]').val());
        },

        setNotes: function () {
          this.model.set("details", this.$('textarea').val());
        }
      });

      App.Views.ChoosePerson = App.Views.AddBillSubview.extend({
        tagName: "div",
        events: {
          "click li.main_payer": "updateOnePayer",
          "change input": "updateMultiplePeopleShares",
          "keyup input": "updateMultiplePeopleShares"
        },

        initialize: function (options) {
          this.field = options.field;
          $(this.el).addClass('subview').attr('id', "choose_payer");
          this.model.bind('change:usersList change:onePayer', this.render, this);
          this.model.bind('change:cost', this.updateMultiplePeopleShares, this);
          _.bindAll(this, 'render', 'updateOnePayer', 'updateMultiplePeopleShares');
        },

        render: function () {
          $(this.el).html(JST["backbone/templates/modals/choose-payer"]({
            field: this.field,
            payment: this.model.isPayment(),
            users: this.model.get('usersList'),
            userShares: this.model.get('users'),
            active: this.model.get(this.field),
            eachPaidOwnShare: this.model.get('eachPaidOwnShare'),
            currency_symbol: App.currencies.unit(this.model.get("currency_code"))
          }));
        },

        updateOnePayer: function (e) {
          if (e && e.currentTarget) {
            this.$('li').removeClass('selected');
            $(e.currentTarget).addClass('selected');
            this.model.set(this.field, $(e.currentTarget).data('id'));
          }
        },

        updateMultiplePeopleShares: function (e) {
          if (this.model.get('onePayer') == null) {
            var model = this.model;
            if (this.$('input[type=checkbox]').is(':checked')) {
              model.set("eachPaidOwnShare", true);
              // If checkbox checked, set all paid_shares to equal the corresponding owed_shares
              this.$('input[type=text]').attr('disabled', true).each(function (index) {
                var share = model.getShare($(this).data('id')).owed_share;
                if (isNaN(share))
                  share = 0;
                $(this).val(share.toFixed(2));
              });
            } else {
              this.model.set("eachPaidOwnShare", false);
              var users = model.get("users");
              // Else, set each user's paid_share to the value in the text box
              this.$('input[type=text]').attr('disabled', false).each(function (index) {
                var thisId = $(this).data('id');
                var thisUser = _.find(users, function (u) {
                  return u.user_id == parseInt(thisId) || u.user_id == thisId
                });
                if (thisUser)
                  thisUser.paid_share = parseFloat($(this).val()) || 0;
                }
              );
              model.set("users", users);
              //For some reason, we're not getting a main expense add UI
              //update after updating manual multiple payers, so we trigger
              //a change event to get things to update
              //I tried a bunch of specific fields (onePayer, users, etc)
              //but only the generic event triggered a correc UI update
              this.model.trigger("change");
            }
          }
        }
      });

      App.Views.ChooseSplit = App.Views.AddBillSubview.extend({
        tagName: "div",
        events: {
          "click .slim-button": "updateSlimButton",
          "click .split_button": "changeForm",
          "keyup .unequal input": "updateUnequalData",
          "change .unequal input": "updateUnequalData",
          "click .equal .person": "togglePerson",
          "click .reimbursement .person": "togglePerson",
          "keyup .percent input": "updatePercentData",
          "change .percent input": "updatePercentData",
          "keyup .shares input": "updateShareData",
          "change .shares input": "updateShareData",
          "keyup .adjustment input": "updateAdjustmentData",
          "change .adjustment input": "updateAdjustmentData",

          //itemized
          "keyup #itemized_tip .tip_amount": "updateRawTip",
          "keyup #itemized_tax .tax_amount": "updateRawTax",
          "click td.itemized_item_selector": "toggleItemizedItem",
          "keyup .itemized_item input[type=text]": "updateItemizedData",
          "keyup #itemized_tax .tax_percent": "updateItemizedData",
          "keyup #itemized_tip .tip_percent": "updateItemizedData",
          "click .itemized .initials": "updateItemizedColumn",
          "change .row_selector": "toggleItemizedRow"
        },

        initialize: function (options) {
          $(this.el).addClass('subview').attr('id', "choose_split");
          this.model.bind('change:usersList change:cost change:split_type', this.render, this);
          _.bindAll(this, 'render');
        },

        render: function (object, value, options) {
          //This avoids re-rendering on cost updates from item updates
          if (options && options.itemized) {
            return;
          };

          $(this.el).html(JST["backbone/templates/modals/choose-split"]({
            users: this.model.get('usersList'),
            userShares: this.model.get('users'),
            cost: this.model.get('cost'),
            currency_code: this.model.get('currency_code'),
            currency_symbol: App.currencies.unit(this.model.get("currency_code")),
            model: this.model
          }));
          this.$('.slim-button[data-split-type=' + this.model.get("split") + ']').addClass('selected');
          if (this.model.get("split") == "split") {
            this.$('#split_method button[data-split-subtype=' + this.model.get("split_type") + ']').click();
          }

          this.$('[rel=tooltip]').tooltip({placement: 'top'});
        },

        updateSlimButton: function (e) {
          this.$('.slim-button').removeClass('selected');
          $(e.target).addClass('selected');
          this.model.set("split", $(e.target).data('split-type'));
          if ("itemized" == this.model.get("split_type") && this.model.get("split") == "split") {
            $(this.el).addClass("itemized_form");
          } else {
            $(this.el).removeClass("itemized_form");
          }

          this.render();
        },

        togglePerson: function (e) {
          var person = $(e.currentTarget),
            checkbox = $(person).find('input[type=checkbox]');
          $(person).toggleClass('nope');
          checkbox.attr('checked', !$(person).hasClass('nope'));
          if (this.model.get("split_type") == "equal") {
            this.updateEqualData();
          } else if (this.model.get("split_type") == "reimbursement") {
            this.updateReimbursementData();
          }
        },

        changeForm: function (e) {
          var split_subtype = $(e.currentTarget).data('split-subtype');

          var modelChanged = (this.model.get("split") != "split" || this.model.get("split_type") != split_subtype);
          this.$('.split_method').hide();
          this.$('.' + split_subtype).show();

          if ("itemized" == split_subtype) {
            $(this.el).addClass("itemized_form");
            this.updateItemizedData();
          } else {
            $(this.el).removeClass("itemized_form");
          }

          // update model if subtype has changed
          if (modelChanged) {

            this.model.set({
              split: "split",
              split_type: split_subtype
            }, {silent: true});
            $('.tooltip').hide();

            if ("equal" == split_subtype) {
              this.updateEqualData();
            } else if ("unequal" == split_subtype) {
              this.updateUnequalData();
            } else if ("percent" == split_subtype) {
              this.updatePercentData();
            } else if ("shares" == split_subtype) {
              this.updateShareData();
            } else if ("adjustment" == split_subtype) {
              this.updateAdjustmentData();
            } else if ("reimbursement" == split_subtype) {
              var reimburser = this.model.get("onePayer") || current_user;
              this.model.set("oneReimburser", reimburser);

              // Flip the sign if we're editing an old negative expense
              if (this.model.get("cost") < 0)
                this.model.set("cost", this.model.get("cost") * -1);

              this.updateReimbursementData();
            } else if ("itemized" == split_subtype) {
              this.updateItemizedData();
            } else {
              alert("Invalid split type! You should email mgod@splitwise.com and tell him he messed up :)");
            }
          }
        },

        updateEqualData: function () {
          var user_inputs = this.$(".equal .person");
          var amounts = {};
          _.each(user_inputs, function (input) {
            amounts[$(input).data("id")] = $(input).find('input[type=checkbox]').is(':checked');
          });
          this.model.set("equal_users", amounts);
          _.each(user_inputs, function (input) {
            var amount = this.model.getShare($(input).data("id")).owed_share;
            $(input).find(".amount").text(App.currencies.print(amount, this.model.get("currency_code")));
          }, this);
        },

        updateUnequalData: function () {
          var user_inputs = this.$(".unequal .person");
          var amounts = {};
          _.each(user_inputs, function (input) {
            var amt = safe_parse_float($(input).find('input[type=text]').val());
            amounts[$(input).data("id")] = amt;
          });
          this.model.set("unequal_amounts", amounts);
          var sum = _.reduce(amounts, function (m, amount) {
            return m + amount
          }, 0);
          this.$(".unequal .owed_total").text(App.currencies.print(sum, this.model.get("currency_code")));
          var remaining = parseFloat(this.model.get('cost')) - sum;
          this.$(".unequal .owed_remaining").text(App.t('AMOUNT_left', App.currencies.print(remaining, this.model.get("currency_code"))));
        },

        updatePercentData: function () {
          var user_inputs = this.$(".percent .person");
          var percents = {};
          _.each(user_inputs, function (input) {
            percents[$(input).data("id")] = safe_parse_float($(input).find('input[type=text]').val()) / 100.0;
          })
          this.model.set("percents", percents)

          var sum = _.reduce(percents, function (m, percent) {
            return m + percent * 100.0;
          }, 0);
          this.$(".percent .owed_total").text(sum.toFixed(2) + "%");
          this.$(".percent .owed_remaining").text(App.t('PERCENT_left', (100.0 - sum).toFixed(2)));
        },

        updateShareData: function () {
          var user_inputs = this.$(".shares .person");
          var shares = {};

          _.each(user_inputs, function (input) {
            shares[$(input).data("id")] = safe_parse_float($(input).find('input[type=text]').val());
          })
          this.model.set("shares", shares);
          _.each(user_inputs, function (input) {
            var amount = this.model.getShare($(input).data("id")).owed_share;
            $(input).find(".subsummary").text(App.t('total_share_AMOUNT', App.currencies.print(amount, this.model.get("currency_code"))));
          }, this);
        },

        updateAdjustmentData: function () {
          var user_inputs = this.$(".adjustment .person");
          var adjustments = {};
          _.each(user_inputs, function (input) {
            adjustments[$(input).data("id")] = safe_parse_float($(input).find('input[type=text]').val());
          });
          this.model.set("adjustments", adjustments);
          _.each(user_inputs, function (input) {
            var amount = this.model.getShare($(input).data("id")).owed_share;
            $(input).find(".subsummary").text(App.t('total_share_AMOUNT', App.currencies.print(amount, this.model.get("currency_code"))));
          }, this);
        },

        updateReimbursementData: function () {
          var user_inputs = this.$(".reimbursement .person");
          var amounts = {};
          _.each(user_inputs, function (input) {
            amounts[$(input).data("id")] = $(input).find('input[type=checkbox]').is(':checked');
          });
          this.model.set("reimbursements", amounts);
          _.each(user_inputs, function (input) {
            var amount = this.model.getShare($(input).data("id")).paid_share;
            $(input).find(".amount").text(App.currencies.print(amount, this.model.get("currency_code")));
          }, this);
        },

        toggleItemizedItem: function (item) {
          var td = $(item.currentTarget);
          if (td.hasClass("selected")) {
            td.addClass("unselected");
            td.removeClass("selected");
          } else {
            td.addClass("selected");
            td.removeClass("unselected");
          }
          this.updateItemizedData();
        },
        toggleItemizedRow: function (item) {
          var items = $(item.currentTarget).parent().parent().find(".itemized_item_selector");
          if ($(item.currentTarget).is(":checked")) {
            items.addClass("selected");
            items.removeClass("unselected");
          } else {
            items.addClass("unselected");
            items.removeClass("selected");
          }
          this.updateItemizedData();
        },
        updateRawTip: function (event) {
          var user_id = $(event.currentTarget).data("id");
          var tip = this.model.get("items")["tip"]["users"][user_id];
          var amount = safe_parse_float($(event.currentTarget).val());
          if (tip != amount) {
            this.$(".tip_percent").val("");
            this.updateItemizedData();
          }
        },
        updateRawTax: function (event) {
          var user_id = $(event.currentTarget).data("id");
          var tax = this.model.get("items")["tax"]["users"][user_id];
          var amount = safe_parse_float($(event.currentTarget).val());
          if (tax != amount) {
            this.$(".tax_percent").val("");
            this.updateItemizedData();
          }
        },
        updateItemizedColumn: function (column) {
          user_id = $(column.currentTarget).data('id');

          var td = $('.itemized td.cost[data-id=' + user_id + ']');
          if (td.hasClass("selected")) {
            td.addClass("unselected");
            td.removeClass("selected");
          } else {
            td.addClass("selected");
            td.removeClass("unselected");
          }

          this.updateItemizedData();
        },
        addItemizedEntry: function () {
          var itemplate = JST["backbone/templates/modals/itemized-item"]({users: this.model.get("usersList"), item: null});
          this.$("#itemized_items #item_holder").append(itemplate);
        },
        updateItemizedData: function () {
          var totals = {};
          var itemized_data = {};
          var items = [];
          var that = this;
          _.each(this.model.get("usersList"), function (member) {
            totals[member.id] = 0.0;
          });

          _.each(this.$("#item_holder tr"), function (row) {
            var total = safe_parse_float($('.amount', $(row)).val());
            total = Math.round(total * 100.0) / 100.0;

            var shares = safe_divide_evenly_amounts(total, $('.itemized_item_selector.selected', $(row)).length);
            var user_shares = {};
            var users_with_shares = [];
            _.each($('.itemized_item_selector.selected', $(row)), function (elt, index) {
              var user_id = $(elt).data("id");
              $(elt).html(shares[index].toFixed(2));
              user_shares[user_id] = shares[index];
              totals[user_id] += shares[index];
              users_with_shares.push(user_id);
            });
            $('td.unselected', $(row)).html("");

            var item = {};
            item["cost"] = $('.amount', $(row)).val();
            item["description"] = $('.item_name', $(row)).val();
            item["shares"] = user_shares;
            item["users"] = users_with_shares;
            items.push(item);
          });

          var total_cost = 0;
          var grand_total_cost = 0;
          var tax = parseFloat($("#itemized_tax .tax_percent").val().replace(/%/, ""));
          var update_tax = !isNaN(tax);
          tax = isNaN(tax)
            ? 0
            : Math.round(tax * 100) / 100;
          var tip = parseFloat($("#itemized_tip .tip_percent").val().replace(/%/, ""));
          var update_tip = !isNaN(tip);
          tip = isNaN(tip)
            ? 0
            : Math.round(tip * 100) / 100;

          var overall_subtotal = safe_sum(totals);
          var tip_data = {
            "total": $("#itemized_tip .tip_percent").val(),
            "users": {}
          };
          var tax_data = {
            "total": $("#itemized_tax .tax_percent").val(),
            "users": {}
          };
          var user_grand_total = {};

          _.each(totals, function (total, user_id) {
            var total_cell = $("#itemized_total .cost[data-id=" + user_id + "]");
            $(total_cell).html(total.toFixed(2));

            var tax_input = that.$(".tax_amount[data-id=" + user_id + "]");
            if (update_tax == true) {
              var actual_tax = Math.round(total * tax) / 100;
              var tax_is_percent = $("#itemized_tax .tax_percent").val().indexOf("%") >= 0;
              if (!tax_is_percent && overall_subtotal > 0) {
                //This is not a percent, it's an absolute value for tax
                actual_tax = Math.round(tax * total * 100.0 / overall_subtotal) / 100.0;
              }

              tax_input.val(actual_tax.toFixed(2));
              tax_data["users"][user_id] = actual_tax;
            } else {
              tax_data["users"][user_id] = Math.round(safe_parse_float(tax_input.val()) * 100.0) / 100.0;
            }

            var tip_input = that.$(".tip_amount[data-id=" + user_id + "]");
            if (update_tip == true) {
              var actual_tip = Math.round(total * tip) / 100.0;
              var tip_is_percent = $("#itemized_tip .tip_percent").val().indexOf("%") >= 0;
              if (!tip_is_percent && overall_subtotal > 0) {
                //This is not a percent, it's an absolute value for tax
                actual_tip = Math.round(tip * total * 100.0 / overall_subtotal) / 100.0;
              }

              tip_input.val(actual_tip.toFixed(2));
              tip_data["users"][user_id] = actual_tip;
            } else {
              tip_data["users"][user_id] = Math.round(safe_parse_float(tip_input.val()) * 100.0) / 100.0;
            }

            var grand_total = total + tax_data["users"][user_id] + tip_data["users"][user_id];
            $("#itemized_grand_total .grand_total[data-id=" + user_id + "]").html(grand_total.toFixed(2));
            user_grand_total[user_id] = grand_total;
          });

          //check the last item for 0 cost/no description and remove it to prevent extra line items
          var last_item = _.last(items);
          if (last_item && last_item["cost"] == 0.0 && last_item["description"] == "") {
            items.pop();
          } else {
            this.addItemizedEntry();
          }

          this.$("#itemized_total .amount_column").html(safe_sum(totals).toFixed(2));
          this.$("#itemized_grand_total .amount_column").html(safe_sum(user_grand_total).toFixed(2));

          itemized_data["items"] = items;
          itemized_data["subtotals"] = totals;
          itemized_data["tax"] = tax_data;
          itemized_data["tip"] = tip_data;
          itemized_data["totals"] = user_grand_total;
          that.model.set("items", itemized_data);
        },

        updateMultiplePeopleShares: function (e) {}
      });

      App.Views.ChooseGroup = App.Views.AddBillSubview.extend({
        tagName: "div",
        events: {
          "click li": "setGroupId"
        },

        initialize: function (options) {
          $(this.el).addClass('subview').attr('id', "choose_group");
          _.bindAll(this, 'render', 'setGroupId');
        },

        render: function () {
          $(this.el).html(JST["backbone/templates/modals/choose-group"]({group_id: this.model.get('group_id')}));
        },

        setGroupId: function (e) {
          this.$('li').removeClass('selected');
          $(e.currentTarget).addClass('selected');
          this.model.set("group_id", $(e.currentTarget).data('id'));
        }
      });

      App.Views.SettleUpForm = Backbone.View.extend({
        el: "#settle_up_form",
        events: {
          "click .input-data": function () {
            var loadExpense = this.$('.input-data').data('expenseId');
            if (loadExpense) {
              var attributes = $.extend(true, {}, App.expenses.get(loadExpense).attributes);
              loadExpense = new App.Models.Expense(attributes);
              this.setModel(loadExpense);
            } else {
              var from = this.$(".input-data").data("from"),
                to = this.$(".input-data").data("to"),
                amount = this.$(".input-data").data("amount"),
                currency = this.$(".input-data").data("currency_code"),
                group_id = this.$(".input-data").data("group_id");

              if (from && to && amount && currency) {
                var expense = new App.Models.Expense({split: 'payment', payment: true, description: 'Payment', cost: safe_parse_float(amount), currency_code: currency});

                if (group_id) {
                  expense.set("group_id", group_id);
                }

                this.setModel(expense);

                //Set the payee stuff after setting expense - needs the usersList we build for setting
                expense.set("onePayer", from);
                expense.set("onePayee", to);
              }
            }
            // setTimeout("$('#settle_up_form .cost').focus()", 200);
          },
          "click .relative-container": 'closeModal',
          "click .subview .dismiss": "closeSubview",
          "click .expense_submit": "render",
          "click .overlay button": 'chooseTransactionMethod',
          "click .currency_code": "chooseCurrency",
          "click .date.slim-button": "chooseDate",
          "click .notes.slim-button": "addNotes",
          "click .group.slim-button": "chooseGroup",
          "click .submit": "submit",
          "click .payer": "choosePayer",
          "click .payee": "choosePayee",
          "change .cost": "setMainDetails",
          "keyup .cost": "setMainDetails",
          "keypress input.cost": "submitOnEnter"
        },

        initialize: function (options) {
          _.bindAll(this, 'render', 'setModel');
          this.render();
        },

        closeModal: function (e) {
          if ($(e.target).hasClass('relative-container'))
            $(this.el).modal('hide')
        },

        submitOnEnter: function (e) {
          if (e.keyCode != 13)
            return;
          this.submit(e);
        },

        setModel: function (model) {
          this.model = model;
          this.editMode = !this.model.isNew();

          if (!model.get("onePayee"))
            model.guessPayee();

          // Set user list based on current context:
          var users = [
            {
              user_id: current_user,
              user: currentUserObject,
              saved: true
            }
          ];

          if (App.currentRelationship && App.currentRelationship.isGroup()) {
            users = _.collect(App.currentRelationship.get("members"), function (m) {
              return {user_id: m.id, saved: true}
            });
          } else if (App.currentRelationship && App.currentRelationship.isFriend()) {
            users.push({user_id: App.currentRelationship.id, saved: true});
          } else {
            // Dashboard or all expenses => list all users
            _.each(App.friends.models, function (friend) {
              users.push({user_id: friend.id, saved: true});
            })
          }

          // Remove duplicates before setting list of users
          users = _.uniq(users, false, function (u) {
            return u.user_id
          });
          this.model.set('users', users);

          this.model.bind('change:transaction_method change:onePayer change:onePayee', this.updateHumanSummary, this);
          this.model.bind('change:currency_code', this.updateCurrency, this);
          this.model.bind('change:date', this.updateDate, this);
          this.model.bind('change:group_id', this.updateGroup, this);
          this.model.bind('change:onePayer change:onePayee', this.closeSubview, this);
          this.model.bind('change:onePayer change:onePayee', this.guessCost, this);
          this.render();
        },

        render: function () {
          $(this.el).html(JST["backbone/templates/modals/settle-up-form"]({model: this.model, editMode: this.editMode}));
          this.setSubview(null);
          this.venmoToken = undefined; // Clear Venmo token

          if (!this.model) {
            return this;
          }

          // Subview initialization
          if (this.choosePayerWindow)
            this.choosePayerWindow.remove();
          this.choosePayerWindow = new App.Views.ChoosePerson({model: this.model, field: "onePayer"});
          this.$('.relative-container').append(this.choosePayerWindow.el);
          this.bind('remove', this.choosePayerWindow.remove);
          this.choosePayerWindow.render();

          if (this.choosePayeeWindow)
            this.choosePayeeWindow.remove();
          this.choosePayeeWindow = new App.Views.ChoosePerson({model: this.model, field: "onePayee"});
          this.$('.relative-container').append(this.choosePayeeWindow.el);
          this.bind('remove', this.choosePayeeWindow.remove);
          this.choosePayeeWindow.render();

          if (this.chooseCurrencyWindow)
            this.chooseCurrencyWindow.remove();
          this.chooseCurrencyWindow = new App.Views.ChooseCurrency({model: this.model});
          this.$('.relative-container').append(this.chooseCurrencyWindow.el);
          this.bind('remove', this.chooseCurrencyWindow.remove);

          if (this.chooseDateWindow)
            this.chooseDateWindow.remove();
          this.chooseDateWindow = new App.Views.ChooseDate({model: this.model, showRecurringOptions: false});
          this.$('.relative-container').append(this.chooseDateWindow.el);
          this.bind('remove', this.chooseDateWindow.remove);

          if (this.addNotesWindow)
            this.addNotesWindow.remove();
          this.addNotesWindow = new App.Views.AddNotes({model: this.model});
          this.$('.relative-container').append(this.addNotesWindow.el);
          this.bind('remove', this.addNotesWindow.remove);
          this.addNotesWindow.render();

          if (this.chooseGroupWindow)
            this.chooseGroupWindow.remove();
          this.chooseGroupWindow = new App.Views.ChooseGroup({model: this.model});
          this.$('.relative-container').append(this.chooseGroupWindow.el);
          this.bind('remove', this.chooseGroupWindow.remove);
          this.chooseGroupWindow.render();

          return this;
        },

        guessCost: function () {
          if (!this.model.id) {
            // for new payments, guess the amount that should be paid from payer to payee
            if (App.currentRelationship && App.currentRelationship.isGroup()) {
              // find group repayment
              var thatModel = this.model;
              var balance = _.find(App.currentRelationship.repayments(), function (r) {
                return r.from == thatModel.get("onePayer") && r.to == thatModel.get("onePayee");
              });
              if (balance) {
                this.model.set({
                  cost: parseFloat(balance.amount),
                  currency_code: balance.currency_code
                });
                this.$(".main-window .cost").val(this.model.get("cost").toFixed(2));
              }
            } else if (this.model.get("onePayer") == current_user) {
              var friend = App.friends.get(this.model.get("onePayee"));
              if (friend && friend.mainBalance().amount < 0) {
                this.model.set({
                  cost: Math.abs(friend.mainBalance().amount),
                  currency_code: friend.mainBalance().currency_code
                });
                this.$(".main-window .cost").val(this.model.get("cost").toFixed(2));
              }
            } else if (this.model.get("onePayee") == current_user) {
              var friend = App.friends.get(this.model.get("onePayer"));
              if (friend && friend.mainBalance().amount > 0) {
                this.model.set({
                  cost: parseFloat(friend.mainBalance().amount),
                  currency_code: friend.mainBalance().currency_code
                });
                this.$(".main-window .cost").val(this.model.get("cost").toFixed(2));
              }
            }
          }
        },

        updateHumanSummary: function () {
          if (['paypal', 'venmo'].indexOf(this.model.get("transaction_method")) > -1) {
            var keystring = this.model.payer().id == current_user
                ? 'are_sending__legacy'
                : 'is_sending__legacy',
              $footerSubmit = this.$('footer button.submit');

            this.$(".transaction_human_summary").text(App.t(keystring));
            $footerSubmit.text(App.t('next'));

            if (this.model.get("transaction_method") == "venmo") {
              $footerSubmit.removeClass('btn-mint btn-orange').addClass('btn-venmo');
            } else {
              $footerSubmit.removeClass('btn-mint btn-venmo').addClass('btn-orange');
            }
          } else {
            this.$(".transaction_human_summary").text(App.t('paid__legacy'));
          }

          var payerOptions,
            payeeOptions;
          if (currentUserObject.locale == "en") {
            // In English languages, verb tense is the same for "You paid Ben" vs. "Jon paid Ben"
            // Displaying "you" instead of the user's name is a nice usability tweak
            payerOptions = {
              uppercaseYou: true
            };
            payeeOptions = {
              lowercaseYou: true
            };
            // For other languages, we will not do this, as verb tense may be different for 2nd vs 3rd person
          }

          this.$('a.payer').text(this.model.payer().firstNameLastInitial(payerOptions));
          this.$('a.payee').text(this.model.payee().firstNameLastInitial(payeeOptions));
          this.$('img.avatar.payer').attr('src', this.model.payer().get("picture").medium);
          this.$('img.avatar.payee').attr('src', this.model.payee().get("picture").medium);
        },

        updateCurrency: function () {
          this.$('.main-window span.currency_code').text(App.currencies.unit(this.model.get("currency_code")));
          this.closeSubview();
        },

        updateDate: function () {
          this.$('.main-window .date').text(formattedDate(this.model.get('date')));
          this.closeSubview();
        },

        updateGroup: function () {
          this.$('.main-window .group.slim-button').text(App.groups.get(this.model.get("group_id")).shortName());
          this.closeSubview();
        },

        setMainDetails: function () {
          var cost = parseFloat(this.$('.cost').val().replace(/(\,|\$|\£|\€)/g, ''));
          this.model.set('cost', isNaN(cost)
            ? null
            : cost);

          // periods are tiny; avoid extra padding at the end of our input
          var newLength = this.$('.cost').val().length;
          if (this.$('.cost').val().indexOf(".") > 0)
            newLength -= 1;

          this.$('.cost').attr('size', Math.max(newLength, 3));
        },

        chooseTransactionMethod: function (e) {
          this.model.set("transaction_method", $(e.currentTarget).data('transaction-method'));
          this.$('.overlay').fadeOut(250);
        },

        choosePayer: function () {
          this.choosePayerWindow.render();
          this.setSubview(this.choosePayerWindow);
        },

        choosePayee: function () {
          this.choosePayeeWindow.render();
          this.setSubview(this.choosePayeeWindow);
        },

        chooseCurrency: function () {
          this.chooseCurrencyWindow.render();
          this.setSubview(this.chooseCurrencyWindow);
        },

        chooseDate: function () {
          this.chooseDateWindow.render();
          this.setSubview(this.chooseDateWindow);
        },

        addNotes: function () {
          // DON'T rerender – we'd lose the file upload (if set)
          // this.chooseDateWindow.render();
          this.setSubview(this.addNotesWindow);
        },

        chooseGroup: function () {
          this.chooseGroupWindow.render();
          this.setSubview(this.chooseGroupWindow);
        },

        setSubview: function (view) {
          if (view == null || view == this.activeSubview) {
            // collapse current subview
            this.hideSubview();
            this.activeSubview = null;
          } else {
            if (this.activeSubview)
              this.activeSubview.setActive(false);

            this.activeSubview = view;
            this.activeSubview.setActive(true);

            var totalWidth = this.$('.main-window').width();
            totalWidth += 20; //spacing
            totalWidth += 4; //borders
            totalWidth += this.$('.subview.active').width();

            $(this.el).css({
              width: totalWidth,
              marginLeft: -totalWidth / 2
            });
          }
        },

        closeSubview: function () {
          this.setSubview(null);
          return false;
        },

        hideSubview: function (animate) {
          var totalWidth = this.$('.main-window').width();
          totalWidth += 2; //borders

          $(this.el).css({
            width: totalWidth,
            marginLeft: -totalWidth / 2
          });
          if (this.activeSubview)
            this.activeSubview.setActive(false);

          this.activeSubview = null;
        },

        submit: function (e) {
          if (this.saving) // this bill is already in the process of saving
            return;

          if (this.model.get("usersList").length == 0) {
            alert(App.t('alert_no_users_involved'));
            return;
          } else if (this.model.get("usersList").length == 1 && !confirm(App.t('alert_only_one_user_confirmation'))) {
            return;
          } else if (this.model.get("cost") == 0.0) {
            alert(App.t("_period", App.t('you_must_enter_an_amount')));
            return;
          } else if (this.model.get("transaction_method") == "venmo") {
            if (this.model.get("currency_code") != "USD") {
              alert('Venmo only accepts USD, sorry!');
              return;
            } else if (this.model.payer().id != current_user) {
              alert(App.t('alert_request_via_venmo_unsupported'));
              return;
            }
          }

          // Handle Venmo payments by going offsite (for new payments only, not edited payments)
          if (this.model.get("transaction_method") == "venmo" && !this.venmoToken && !this.editMode) {
            var that = this;

            // This function will be executed after Venmo authentication goes through successfully
            window.addVenmoToken = function (token) {
              // Prepare to make a payment with the supplied token
              window.addVenmoToken = undefined;
              that.venmoToken = token;

              // Get profile info on this user
              $.get("/api/v3.0/get_venmo_info?access_token=" + that.venmoToken, function (data) {
                mpq.push([
                  "track",
                  "Venmo: authentication success", {
                    venmo_username: data.data.user.username,
                    venmo_friends_count: data.data.user.friends_count,
                    venmo_date_joined: data.data.user.date_joined
                  }
                ]);
              });

              // Show a confirmation prompt to the user before sending the actual Venmo payment on their behalf
              var textAmount = App.currencies.print(that.model.get("cost"), that.model.get("currency_code"));
              this.$('.overlay').html("<div class='venmo_confirmation'><img src='/assets/fat_rabbit/app/venmo_logo_blue.png'>" + App.t('this_will_send_AMOUNT_to_NAME_from_venmo_html', textAmount, that.model.payee().get("email")) + "</div>").show();

              this.$('footer button.submit').text(App.t('send_AMOUNT_via_SERVICE', textAmount, 'Venmo'))
            }

            // Open a Venmo pop-up to authenticate the user
            window.open("/users/venmo_redirect", '', ' menubar=no,toolbar=no,resizable=yes,scrollbars=yes,height=500,width=400');

            // this.submit() will be executed a second time when the user confirms this Venmo transaction and makes
            // it go through, so we should return here and short-circuit the submit this time around
            return;
          }

          expense_hash = this.model.toApiJSON();
          expense_hash["settle_all"] = true;

          // If this is a Venmo payment, pass an access token to the server to make a payment
          if (this.venmoToken)
            expense_hash["venmo_token"] = this.venmoToken;

          if (App.formDataSupported) {
            var data = new FormData(); // needed for AJAX image upload on newer browsers
            _.each(expense_hash, function (v, k) {
              if (v && v.getMonth) {
                // convert Date objects to strings for Firefox
                data.append(k, v.toJSON());
              } else
                data.append(k, v);
              }
            );

            if ($('#bill_file').val()) { // include image if attached
              // TODO: make sure this doesn't conflict with add_bill's file input
              if (document.getElementById('bill_file').files[0].size > 2048000) {
                if (!confirm(App.t('alert_file_size_exceeded_confirmation')))
                  return false;
                }
              else {
                data.append('receipt', document.getElementById('bill_file').files[0]);
              }
            }
            expense_hash = data;
          }

          App.showLoader(App.t('saving'));
          var form = this;
          this.saving = true;
          $.ajax({
            url: (this.editMode
              ? "/api/v3.0/update_expense/" + this.model.id
              : "/api/v3.0/create_expense"),
            data: expense_hash,
            dataType: "json",
            type: "POST",
            processData: !(App.formDataSupported),
            contentType: (App.formDataSupported
              ? false
              : 'application/x-www-form-urlencoded'),
            success: function (data, status) {
              var errors = null;
              if (status == "success") {
                if (data["errors"] && _.size(data["errors"]) > 0) {
                  errors = _.reduce(data["errors"], function (memo, v, k) {
                    return memo + _.reduce(v, function (memo2, u) {
                      return memo2 + "\n- " + (k == "base"
                        ? ""
                        : $.capitalize(k) + " ") + u;
                    }, "");
                  }, App.t('these_errors_occurred'));
                } else {
                  _.each(data["expenses"], function (e) {
                    if (App.currentRelationship) {
                      // Only add this new expense to the currently viewed list if it belongs to this relationship
                      if (App.currentRelationship.get("relationship_type") == "group") {
                        var displayExpense = (App.currentRelationship.get('id') == e.group_id || App.currentRelationship.get('id') == -1);
                      } else { // expense added to friendship
                        var expenseParticipants = _.pluck(e["users"], 'user_id');
                        var friendshipParticipants = _.pluck(this.users, 'id');
                        var displayExpense = (_.without(friendshipParticipants, expenseParticipants).toString() == [].toString() && isNaN(parseInt(e["group_id"])));
                      }

                      if (form.editMode) { // Remove old version
                        if (App.currentRelationship) // optimistic balance updating
                          App.currentRelationship.adjustBalances("subtract", App.expenses.get(form.model.id));
                        App.expenses.remove(App.expenses.get(form.model.id), {silent: displayExpense});
                      }

                      if (displayExpense) {
                        if (App.currentRelationship) { // optimistic balance updating
                          if (!(App.currentRelationship.isFriend() && e["creation_method"] == "debt_consolidation"))
                            App.currentRelationship.adjustBalances("add", new App.Models.Expense(e));
                          }

                        App.expenses.add(e);
                        if (!form.editMode) // Slide into view
                          $('#expense-' + e.id + (App.settings.show_settled_bills
                            ? ''
                            : ':not(.settled)')).hide().slideDown();
                        }
                      }

                    // Send user to PayPal page if necessary
                    if (form.model.get("transaction_method") == "paypal") {
                      window.location.href = "/expenses/" + data["expenses"][0].id + "/send_money";
                    }
                  });

                  if (App.currentRelationship && App.currentRelationship.id > 0)
                    App.currentRelationship.fetch( // Refresh balance data
                    );
                  else {
                    App.groups.fetch({url: "/api/v3.0/get_groups"});
                    App.friends.fetch({url: "/api/v3.0/get_friends"});
                  }
                  //form.render();
                }
              }

              if (errors || status != "success") {
                form.saving = false;
                App.closeLoader({type: 'error'});
                alert(errors
                  ? errors
                  : status);

              } else {
                $('#settle_up_form').modal('hide');
                _.delay(function () {
                  form.saving = false
                }, 500);
                App.closeLoader({type: 'success', message: App.t('success')});
              }
            },
            error: function (status) {
              form.saving = false;
              alert(App.t('general_unknown_error'));
              App.closeLoader({type: 'error'});
            }
          });
        }
      });
    </script>

    <script type="text/javascript">
      var Analytics = {
        trackPage: function (page) {
          _gaq.push(["_trackPageview", page]);
        },

        trackEvent: function (category, action, label, value, silent) {
          _gaq.push(["_trackEvent", category, action, label, value]);
        }
      }
    </script>
    <script>
      var flatten_for_splitwise_api = function (name, value) {
        var values = {};
        if ($.isArray(value) || $.isPlainObject(value) || $.isFunction(value)) {
          //Array and hash behavior
          _.each(value, function (item, index) {
            var flattened = flatten_for_splitwise_api(name + "__" + index, item);
            for (var key in flattened) {
              values[key] = flattened[key];
            }
          })
        } else {
          //God help us if this isn't a primitive type
          values[name] = value;
        }
        return values;
      }

      var patch_js_template_settings = function () {
        // Use "<@= @>" instead of "" in underscore.js templates
        _.templateSettings = {
          interpolate: /\<\@\=(.+?)\@\>/g,
          evaluate: /\<\@(.+?)\@\>/g
        };
      }

      var safe_divide_evenly_amounts = function (total, count) {
        var equal_share = total / count;
        equal_share = (isNaN(equal_share) || !isFinite(equal_share))
          ? 0.0
          : equal_share;
        equal_share = parseFloat(equal_share.toFixed(2));

        //Ok, so we should now have a below total equal amount, so we create an array of results
        var amounts = [];
        while (count--)
          amounts.push(equal_share);
        var sum = _.reduce(amounts, function (memo, num) {
          return memo + num;
        }, 0);
        var remainder = total - sum;
        for (var i = 0; remainder > 0.001; i++, remainder -= 0.01) {
          amounts[i] += 0.01;
        }
        for (var i = 0; remainder < -0.001; i++, remainder += 0.01) {
          amounts[i] -= 0.01;
        }
        return amounts;
      }

      var safe_parse_float = function (string) {
        return parseFloat(string) || 0.0;
      }

      var safe_sum = function (values) {
        return _.reduce(values, function (memo, num) {
          return memo + safe_parse_float(num);
        }, 0.0)
      }
    </script>

    <script>
      $(document).ready(function () {
        // Build loading spinner
        $("#ajax_activity").activity({
          steps: 10,
          width: 4,
          space: 5,
          length: 10,
          align: 'center',
          valign: 'top',
          padding: 0,
          color: '#ccc'
        });

        // Initialize the app
        App.notifications_read = "2012-07-17T23:54:29Z";
        App.notifications_count_at_page_load = 0;
        App.loadBootstrapDataAndInit();

        $(document).on("click", "a.track", function (event) {
          var link = $(event.currentTarget);
          mpq.push([
            "track",
            "Tracking link clicked", {
              action: link.data('action')
            }
          ]);
          if (link.attr('target') == "_blank")
            return true;
          else {
            setTimeout(function () {
              window.location = link.attr('href')
            }, 150);
            return false;
          }
        });
      });

      if ($.cookies.test() && $.cookies.get("signingUp")) {
        //mpq.push(["track", "User signup: completed", {newUser: false}]);
        $.cookies.del("signingUp");
      }
    </script>

    <script>
      // Track existing user logins on Mixpanel
      if ($ && $.cookies.test()) {
        if ($.cookies.get("notLoggedIn")) {
          // if (true)
          //   mpq.push(["track", "Logged in"]);
          $.cookies.del("notLoggedIn");
        }
        if ($.cookies.get("user_credentials"))
          document.cookie = "user_credentials=;path=/;domain=.splitwise.com;expires=Thu, 01 Jan 1970 00:00:01 GMT;";
        }
    </script>
    <script>
      (function () {
        var uv = document.createElement('script');
        uv.type = 'text/javascript';
        uv.async = true;
        uv.src = '//widget.uservoice.com/btQQZLdeTNPCOWTNulTSg.js';
        var s = document.getElementsByTagName('script')[0];
        s.parentNode.insertBefore(uv, s)
      })()
    </script>
    <script>
      UserVoice = window.UserVoice || [];
      UserVoice.push([
        'showTab',
        'classic_widget', {
          mode: 'full',
          primary_color: '#5bc5a7',
          link_color: '#007cbf',
          default_mode: 'support',
          forum_id: 162446,
          tab_label: 'Feedback',
          tab_color: '#5bc5a7',
          tab_position: 'bottom-right',
          tab_inverted: false
        }
      ]);
    </script>
    <script>
      var _gaq = [
        [
          '_setAccount', 'UA-22826239-1'
        ],
        ['_trackPageview'],
        ['_trackPageLoadTime']
      ];
      _gaq.push(['_setCustomVar', 1, 'Signup Week', '2016-08', 1]);
      _gaq.push(['_setCustomVar', 2, 'Signup Type', 'registered', 1]);
      _gaq.push(['_setCustomVar', 4, 'Ad source', '', 1]);
      _gaq.push(['_setCustomVar', 5, 'A/B test', 'A', 1]);
      (function (d, t) {
        var g = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
        g.src = ('https:' == location.protocol
          ? '//ssl'
          : '//www') + '.google-analytics.com/ga.js';
        s.parentNode.insertBefore(g, s)
      }(document, 'script'));
    </script>
  </body>
</html>
